<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tattoo Booking Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 
    Content-Security-Policy for production:
      - 'unsafe-eval' so Supabase can function
      - connect-src includes your domain
  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    /* Dark, mobile-friendly style */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #111;
      color: #fff;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2 {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-weight: bold;
      margin: 8px 0 4px;
    }
    input, select, textarea, button {
      width: 100%;
      background: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 10px;
    }
    button {
      background: #333;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background: #555;
    }
    .form-section {
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .size-container {
      display: flex;
      gap: 10px;
    }
    .size-container > div {
      flex: 1;
    }
    .conditional-section {
      margin-top: 10px;
      background: #333;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 10px;
    }
    .list-container {
      margin-top: 6px;
    }
    .list-item {
      background: #444;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 6px;
      cursor: pointer;
    }
    .list-item:hover {
      background: #555;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Tattoo Booking Form</h1>

  <form id="tattoo-form" enctype="multipart/form-data">
    <!-- Personal Info -->
    <div class="form-section">
      <h2>Personal Info</h2>
      <label for="name">Name *</label>
      <input type="text" id="name" name="name" required />

      <label for="phone">Phone (include prefix if non-US, e.g. +34) *</label>
      <input type="tel" id="phone" name="phone" required />

      <label for="email">Email *</label>
      <input type="email" id="email" name="email" required />
    </div>

    <!-- Tattoo Info -->
    <div class="form-section">
      <h2>Tattoo Info</h2>
      <label for="placement">Placement *</label>
      <input type="text" id="placement" name="placement" placeholder="forearm, shoulder, etc." required />

      <div class="size-container">
        <div>
          <label for="heightInches">Height (in)</label>
          <input type="number" id="heightInches" name="heightInches" required />
        </div>
        <div>
          <label for="widthInches">Width (in)</label>
          <input type="number" id="widthInches" name="widthInches" required />
        </div>
      </div>

      <label>Color or Black & Grey? *</label>
      <select id="colorOrBlack" name="colorOrBlack" required>
        <option value="color">Color</option>
        <option value="black-and-grey">Black and Grey</option>
      </select>

      <label for="description">Brief Description *</label>
      <textarea id="description" name="description" rows="4" required></textarea>

      <!-- Reference images -->
      <label>Reference Image 1</label>
      <input type="file" id="reference-image1" name="reference-image1" accept="image/*" />

      <label>Reference Image 2</label>
      <input type="file" id="reference-image2" name="reference-image2" accept="image/*" />

      <label>Reference Image 3</label>
      <input type="file" id="reference-image3" name="reference-image3" accept="image/*" />
    </div>

    <!-- Location first -->
    <div class="form-section">
      <label for="locationSelect">Preferred Location *</label>
      <select id="locationSelect" name="locationSelect" required>
        <option value="">-- Select Location --</option>
      </select>

      <!-- Natural question: what's more important? -->
      <label for="prioritySelect" style="margin-top:10px;">Which is more important?</label>
      <select id="prioritySelect" name="prioritySelect" required>
        <option value="">-- Choose --</option>
        <option value="datePriority">I need a specific Date</option>
        <option value="artistPriority">I have a specific Artist in mind</option>
      </select>

      <!-- If date is priority -->
      <div id="datePrioritySection" class="conditional-section hidden">
        <label for="priorityDate">Which date do you need?</label>
        <input type="date" id="priorityDate" />
        <!-- Then we show a list of available artists for that date -->
        <div class="list-container" id="availableArtistsForDate"></div>
        <!-- Once user picks an artist from that list, we show timeslots -->
        <div class="list-container hidden" id="dateTimesContainer"></div>
      </div>

      <!-- If artist is priority -->
      <div id="artistPrioritySection" class="conditional-section hidden">
        <label for="artistPick">Choose Artist</label>
        <select id="artistPick">
          <option value="">-- Pick Artist --</option>
        </select>

        <label for="rangeStart">Start Date</label>
        <input type="date" id="rangeStart" />
        <label for="rangeEnd">End Date</label>
        <input type="date" id="rangeEnd" />

        <!-- Then we show a list of possible days in that range for that artist -->
        <div class="list-container" id="availableDaysForArtist"></div>
        <!-- Once user picks a day, show timeslots for that day -->
        <div class="list-container hidden" id="artistTimesContainer"></div>
      </div>
    </div>

    <!-- Marketing & Consent -->
    <div class="form-section">
      <label>
        <input type="checkbox" id="opt-in-marketing" name="opt-in-marketing" required />
        I agree to receive emails and SMS regarding my appointment and marketing.
      </label>
      <p style="font-size: 0.9em;">
        By checking this box, you consent to be contacted in compliance with applicable ADA and privacy regulations.
      </p>
    </div>

    <!-- Hidden fields for final (artist, date, start_time, end_time) -->
    <input type="hidden" id="finalArtistId" name="finalArtistId" />
    <input type="hidden" id="finalDate" name="finalDate" />
    <input type="hidden" id="finalStartTime" name="finalStartTime" />
    <input type="hidden" id="finalEndTime" name="finalEndTime" />

    <!-- Submit -->
    <button type="submit">Submit</button>
  </form>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    const supabaseUrl='https://shlvjhipxnslrncczopn.supabase.co';
    const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase=window.supabase.createClient(supabaseUrl,supabaseKey);

    // references
    const locationSelect=document.getElementById('locationSelect');
    const prioritySelect=document.getElementById('prioritySelect');
    const datePrioritySection=document.getElementById('datePrioritySection');
    const priorityDate=document.getElementById('priorityDate');
    const availableArtistsForDate=document.getElementById('availableArtistsForDate');
    const dateTimesContainer=document.getElementById('dateTimesContainer');

    const artistPrioritySection=document.getElementById('artistPrioritySection');
    const artistPick=document.getElementById('artistPick');
    const rangeStart=document.getElementById('rangeStart');
    const rangeEnd=document.getElementById('rangeEnd');
    const availableDaysForArtist=document.getElementById('availableDaysForArtist');
    const artistTimesContainer=document.getElementById('artistTimesContainer');

    const finalArtistId=document.getElementById('finalArtistId');
    const finalDate=document.getElementById('finalDate');
    const finalStartTime=document.getElementById('finalStartTime');
    const finalEndTime=document.getElementById('finalEndTime');

    // On load => fill location
    window.addEventListener('DOMContentLoaded', loadLocations);
    async function loadLocations(){
      let {data,error}=await supabase
        .from('locations')
        .select('id, location_name');
      if(error){console.error(error);return;}
      data.forEach(loc=>{
        const opt=document.createElement('option');
        opt.value=loc.id;
        opt.textContent=loc.location_name;
        locationSelect.appendChild(opt);
      });
    }

    // Priority => show/hide
    prioritySelect.addEventListener('change',()=>{
      const val=prioritySelect.value;
      if(val==='datePriority'){
        datePrioritySection.classList.remove('hidden');
        artistPrioritySection.classList.add('hidden');
        clearDatePriority();
        clearArtistPriority();
      } else if(val==='artistPriority'){
        artistPrioritySection.classList.remove('hidden');
        datePrioritySection.classList.add('hidden');
        loadArtistsForLocation();
        clearArtistPriority();
        clearDatePriority();
      } else {
        datePrioritySection.classList.add('hidden');
        artistPrioritySection.classList.add('hidden');
        clearDatePriority();
        clearArtistPriority();
      }
    });

    function clearDatePriority(){
      priorityDate.value='';
      availableArtistsForDate.innerHTML='';
      dateTimesContainer.innerHTML='';
      dateTimesContainer.classList.add('hidden');
    }
    function clearArtistPriority(){
      artistPick.innerHTML='<option value="">-- Pick Artist --</option>';
      rangeStart.value='';
      rangeEnd.value='';
      availableDaysForArtist.innerHTML='';
      artistTimesContainer.innerHTML='';
      artistTimesContainer.classList.add('hidden');
    }

    // If date priority => user picks date => we list which artists are free that day
    priorityDate.addEventListener('change', loadArtistsForThisDate);

    // compute needed time from form
    function getNeededMins(){
      const hVal=parseFloat(document.getElementById('heightInches').value||'0');
      const wVal=parseFloat(document.getElementById('widthInches').value||'0');
      return computeTattooDurationSqInches(hVal,wVal);
    }
    function computeTattooDurationSqInches(height,width){
      const sqIn=height*width;
      if(sqIn<3) return 30;
      if(sqIn<=6) return 45;
      if(sqIn<=9) return 60;
      if(sqIn<=12) return 75;
      if(sqIn<=18) return 120;
      if(sqIn<=25) return 190;
      if(sqIn<=38) return 285;
      return 9999;
    }

    async function loadArtistsForThisDate(){
      availableArtistsForDate.innerHTML='';
      dateTimesContainer.innerHTML='';
      dateTimesContainer.classList.add('hidden');
      const locId=locationSelect.value;
      const dateVal=priorityDate.value;
      if(!locId||!dateVal)return;
      const needed=getNeededMins();

      // fetch all artists in location
      let {data:artists, error}=await supabase
        .from('artists')
        .select('*')
        .eq('location_id', locId);
      if(error||!artists)return;

      // fetch appts for date
      let {data:appts, error:apE}=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('date', dateVal);
      if(apE){console.error(apE);return;}

      let dayIdx= fixDayOffset(dateVal);
      const dayCols=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
      const scStart=dayCols[dayIdx]+'_start';
      const scEnd=dayCols[dayIdx]+'_end';

      // We'll show only those artists who have at least 1 free slot big enough
      let validArtists=[];
      artists.forEach(art=>{
        const st=art[scStart];
        const en=art[scEnd];
        if(!st||!en)return;
        const sMin=toMinutes(st);
        const eMin=toMinutes(en);
        const dayAppts=appts.filter(a=> a.artist_id===art.id);
        if(needed>=9999){
          // entire day => if dayAppts=0 => valid
          if(dayAppts.length===0){
            validArtists.push({id:art.id,name:art.artist_name});
          }
          return;
        }
        let free=buildFreeIntervals(sMin,eMin,dayAppts);
        // if any free interval >= needed => valid
        let hasSlot= free.some(int=> (int.end-int.start)>=needed );
        if(hasSlot){
          validArtists.push({id:art.id,name:art.artist_name});
        }
      });

      if(validArtists.length===0){
        availableArtistsForDate.innerHTML='<p>No artists available that day for the needed time.</p>';
      } else {
        validArtists.forEach(va=>{
          const div=document.createElement('div');
          div.classList.add('list-item');
          div.textContent=va.name;
          div.addEventListener('click',()=>{
            // load times for that artist
            showTimesForArtistOnDate(va.id, va.name, dateVal, needed);
          });
          availableArtistsForDate.appendChild(div);
        });
      }
    }

    async function showTimesForArtistOnDate(artistId, artistName, dateVal, needed){
      dateTimesContainer.innerHTML='';
      dateTimesContainer.classList.remove('hidden');

      // fetch that artist
      let {data:artist}=await supabase
        .from('artists')
        .select('*')
        .eq('id',artistId)
        .single();
      if(!artist)return;

      // fetch appts
      let {data:appts}=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('artist_id', artistId)
        .eq('date', dateVal);

      let dayIdx= fixDayOffset(dateVal);
      const dayCols=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
      const scStart=dayCols[dayIdx]+'_start';
      const scEnd=dayCols[dayIdx]+'_end';
      const st=artist[scStart];
      const en=artist[scEnd];
      if(!st||!en){
        dateTimesContainer.innerHTML='<p>Artist is off that day.</p>';
        return;
      }
      const sMin=toMinutes(st);
      const eMin=toMinutes(en);
      if(needed>=9999){
        // entire day => if no conflict => 1 slot
        if(!appts||appts.length===0){
          const div=document.createElement('div');
          div.classList.add('list-item');
          div.textContent=`${artistName}: All Day`;
          div.addEventListener('click',()=>{
            finalArtistId.value=artistId;
            finalDate.value=dateVal;
            finalStartTime.value=st;
            finalEndTime.value=en;
            alert(`Selected All Day with ${artistName}`);
          });
          dateTimesContainer.appendChild(div);
        }else{
          dateTimesContainer.innerHTML='<p>No full-day slot. Artist is booked.</p>';
        }
        return;
      }
      let free= buildFreeIntervals(sMin,eMin,appts);
      let resultSlots=[];
      free.forEach(int=>{
        let length=int.end-int.start;
        if(length>=needed){
          let step=5;
          for(let t=int.start; t<=(int.end-needed); t+=step){
            resultSlots.push({
              startM:t,
              endM:t+needed,
              label:`${artistName}: ${minsToHHMM(t)} - ${minsToHHMM(t+needed)}`
            });
          }
        }
      });
      if(!resultSlots.length){
        dateTimesContainer.innerHTML='<p>No available timeslots for this artist/day.</p>';
        return;
      }
      resultSlots.forEach(rs=>{
        const div=document.createElement('div');
        div.classList.add('list-item');
        div.textContent=rs.label;
        div.addEventListener('click',()=>{
          finalArtistId.value=artistId;
          finalDate.value=dateVal;
          finalStartTime.value=minsToHHMM(rs.startM);
          finalEndTime.value=minsToHHMM(rs.endM);
          alert(`Selected: ${rs.label}`);
        });
        dateTimesContainer.appendChild(div);
      });
    }

    // If artist priority => load artists in location => user picks => range => show days
    async function loadArtistsForLocation(){
      artistPick.innerHTML='<option value="">-- Pick Artist --</option>';
      const locId=locationSelect.value;
      if(!locId)return;
      let {data:artists, error}=await supabase
        .from('artists')
        .select('id, artist_name')
        .eq('location_id', locId);
      if(error){console.error(error);return;}
      artists.forEach(art=>{
        const opt=document.createElement('option');
        opt.value=art.id;
        opt.textContent=art.artist_name;
        artistPick.appendChild(opt);
      });
    }
    artistPick.addEventListener('change', ()=>{
      availableDaysForArtist.innerHTML='';
      artistTimesContainer.innerHTML='';
      artistTimesContainer.classList.add('hidden');
    });
    rangeStart.addEventListener('change', loadDaysForArtistRange);
    rangeEnd.addEventListener('change', loadDaysForArtistRange);

    async function loadDaysForArtistRange(){
      availableDaysForArtist.innerHTML='';
      artistTimesContainer.innerHTML='';
      artistTimesContainer.classList.add('hidden');

      const aVal=artistPick.value;
      if(!aVal)return;
      const rS=rangeStart.value;
      const rE=rangeEnd.value;
      if(!rS||!rE)return;
      const needed=getNeededMins();

      // fetch that artist
      let {data:art}=await supabase
        .from('artists')
        .select('*')
        .eq('id',aVal)
        .single();
      if(!art)return;

      // fetch appts in range
      let {data:appts}=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('artist_id',aVal)
        .gte('date',rS)
        .lte('date',rE);

      // iterate from rS->rE day by day
      let allDays=[];
      for(let d=new Date(rS); d<=new Date(rE); d=new Date(d.getTime()+86400000)){
        const dayVal=d.toISOString().split('T')[0];
        const dayIdx= fixDayOffset(dayVal);
        const dayCols=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
        const scStart=dayCols[dayIdx]+'_start';
        const scEnd=dayCols[dayIdx]+'_end';
        const st=art[scStart];
        const en=art[scEnd];
        if(!st||!en) continue;
        const sMin=toMinutes(st);
        const eMin=toMinutes(en);

        const dayAp= appts.filter(a=> a.date===dayVal);
        if(needed>=9999){
          // entire day => if no dayAp => 1 big day
          if(dayAp.length===0){
            allDays.push({date:dayVal,label:`${dayVal} => All Day`});
          }
        } else {
          let free=buildFreeIntervals(sMin,eMin,dayAp);
          let anySlot= free.some(int=> (int.end-int.start)>=needed );
          if(anySlot){
            allDays.push({date:dayVal,label:dayVal});
          }
        }
      }
      if(!allDays.length){
        availableDaysForArtist.innerHTML='<p>No available days in that range.</p>';
        return;
      }
      allDays.forEach(dy=>{
        const div=document.createElement('div');
        div.classList.add('list-item');
        div.textContent=dy.label;
        div.addEventListener('click',()=>{
          showTimesForArtistDay(aVal,dy.date,needed);
        });
        availableDaysForArtist.appendChild(div);
      });
    }

    async function showTimesForArtistDay(artistId, dayVal, needed){
      artistTimesContainer.innerHTML='';
      artistTimesContainer.classList.remove('hidden');

      let {data:art}=await supabase
        .from('artists')
        .select('*')
        .eq('id', artistId)
        .single();
      if(!art)return;

      let {data:appts}=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('artist_id', artistId)
        .eq('date', dayVal);

      const dayIdx= fixDayOffset(dayVal);
      const dayCols=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
      const scStart=dayCols[dayIdx]+'_start';
      const scEnd=dayCols[dayIdx]+'_end';
      const st=art[scStart];
      const en=art[scEnd];
      if(!st||!en){
        artistTimesContainer.innerHTML='<p>Artist is off that day.</p>';
        return;
      }
      const sMin=toMinutes(st);
      const eMin=toMinutes(en);

      if(needed>=9999){
        if(!appts||!appts.length){
          const div=document.createElement('div');
          div.classList.add('list-item');
          div.textContent=`All Day => ${dayVal}`;
          div.addEventListener('click',()=>{
            finalArtistId.value=artistId;
            finalDate.value=dayVal;
            finalStartTime.value=st;
            finalEndTime.value=en;
            alert(`Selected All Day`);
          });
          artistTimesContainer.appendChild(div);
        }else{
          artistTimesContainer.innerHTML='<p>No full-day slot available.</p>';
        }
        return;
      }
      let free=buildFreeIntervals(sMin,eMin,appts);
      let resultSlots=[];
      free.forEach(int=>{
        let length=int.end - int.start;
        if(length>=needed){
          let step=5;
          for(let t=int.start; t<=(int.end-needed); t+=step){
            resultSlots.push({
              startM:t,
              endM:t+needed,
              label:`${dayVal} => ${minsToHHMM(t)} - ${minsToHHMM(t+needed)}`
            });
          }
        }
      });
      if(!resultSlots.length){
        artistTimesContainer.innerHTML='<p>No timeslots available.</p>';
        return;
      }
      resultSlots.forEach(rs=>{
        const div=document.createElement('div');
        div.classList.add('list-item');
        div.textContent=rs.label;
        div.addEventListener('click',()=>{
          finalArtistId.value=artistId;
          finalDate.value=dayVal;
          finalStartTime.value=minsToHHMM(rs.startM);
          finalEndTime.value=minsToHHMM(rs.endM);
          alert(`Selected ${rs.label}`);
        });
        artistTimesContainer.appendChild(div);
      });
    }

    // building free intervals from existing appts
    function buildFreeIntervals(startM,endM,appts){
      let blocks=[];
      appts.forEach(a=>{
        const sN=toMinutes(a.start_time);
        const eN=toMinutes(a.end_time);
        blocks.push({start:sN,end:eN});
      });
      blocks.sort((x,y)=> x.start-y.start);
      let free=[];
      let curStart=startM;
      blocks.forEach(b=>{
        if(b.start>curStart){
          free.push({start:curStart,end:b.start});
        }
        if(b.end>curStart){
          curStart=b.end;
        }
      });
      if(curStart<endM){
        free.push({start:curStart,end:endM});
      }
      return free;
    }

    // we add +1 day offset to fix "thursday => wednesday schedule"
    function fixDayOffset(dateStr){
      let realDay = new Date(dateStr+'T00:00:00Z').getDay(); 
      return (realDay+1)%7; 
    }

    function toMinutes(hhmm){
      if(!hhmm)return 0;
      const [h,m]=hhmm.split(':').map(Number);
      return h*60+m;
    }
    function minsToHHMM(m){
      const hh=Math.floor(m/60);
      const mm=m%60;
      return String(hh).padStart(2,'0')+':'+String(mm).padStart(2,'0');
    }

    // On form submit => check final fields => send to your Make webhook
    const form=document.getElementById('tattoo-form');
    form.addEventListener('submit', async(e)=>{
      e.preventDefault();
      if(!finalArtistId.value||!finalDate.value||!finalStartTime.value||!finalEndTime.value){
        alert('Please select an appointment slot first.');
        return;
      }
      const fd=new FormData(form);
      try{
        const resp=await fetch('https://hook.us2.make.com/41mjz37swhb5fdu238aqtr26x9by4b5e',{
          method:'POST',
          body: fd
        });
        if(resp.ok){
          alert('Form submitted! We’ll contact you soon.');
          form.reset();
          // clear hidden
          finalArtistId.value='';
          finalDate.value='';
          finalStartTime.value='';
          finalEndTime.value='';
          prioritySelect.value='';
          datePrioritySection.classList.add('hidden');
          artistPrioritySection.classList.add('hidden');
        } else {
          alert('Error submitting form, please try again later.');
        }
      }catch(err){
        console.error(err);
        alert('Error submitting form, check console.');
      }
    });
  </script>
</body>
</html>
