<!-- Tattoo Info -->
  <div class="form-section">
    <h2>Tattoo Info</h2>
    <label for="placement">Placement *</label>
    <input type="text" id="placement" name="placement" placeholder="e.g., forearm, shoulder, etc." required>
    <div class="flex-container">
      <div>
        <label for="heightInches">Height (inches) *</label>
        <input type="number" id="heightInches" name="heightInches" required>
      </div>
      <div>
        <label for="widthInches">Width (inches) *</label>
        <input type="number" id="widthInches" name="widthInches" required>
      </div>
    </div>
    <label>Color or Black & Grey? *</label>
    <select id="colorOrBlack" name="colorOrBlack" required>
      <option value="color">Color</option>
      <option value="black-and-grey">Black and Grey</option>
    </select>
    <label for="description">Brief Description *</label>
    <textarea id="description" name="description" rows="4" required></textarea>
    <!-- Three separate file inputs for reference images -->
    <label for="reference-image1">Reference Image 1</label>
    <input type="file" id="reference-image1" name="reference-image1" accept="image/*">
    <label for="reference-image2">Reference Image 2</label>
    <input type="file" id="reference-image2" name="reference-image2" accept="image/*">
    <label for="reference-image3">Reference Image 3</label>
    <input type="file" id="reference-image3" name="reference-image3" accept="image/*">
  </div>

  <!-- Appointment Scheduling Section -->
  <div class="form-section">
    <h2>Appointment Scheduling</h2>
    <label for="preferred-location">Preferred Location *</label>
    <select id="preferred-location" name="preferred-location" required>
      <option value="">-- Select Location --</option>
    </select>

    <!-- Priority question (hidden until a location is selected) -->
    <div id="priority-question" class="hidden">
      <p>To help us accommodate you faster, please tell us what is more important for you:</p>
      <label><input type="radio" name="priority" value="date"> The Date</label>
      <label><input type="radio" name="priority" value="artist"> The Artist</label>
    </div>

    <!-- Date Priority Section -->
    <div id="date-priority-section" class="hidden">
      <label for="priority-date">Choose Appointment Date *</label>
      <input type="date" id="priority-date" name="priority-date">
      <div id="available-slots-container" class="hidden">
        <label for="time-slot">Choose an Available Slot *</label>
        <select id="time-slot" name="time-slot"></select>
      </div>
    </div>

    <!-- Artist Priority Section -->
    <div id="artist-priority-section" class="hidden">
      <label for="priority-artist">Choose Your Preferred Artist *</label>
      <select id="priority-artist" name="priority-artist">
        <option value="">-- Select Artist --</option>
      </select>
      <label for="date-range-start">Choose Date Range Start *</label>
      <input type="date" id="date-range-start" name="date-range-start">
      <label for="date-range-end">Choose Date Range End *</label>
      <input type="date" id="date-range-end" name="date-range-end">
      <div id="available-dates-container" class="hidden">
        <label for="available-dates">Available Dates *</label>
        <select id="available-dates" name="available-dates"></select>
      </div>
      <div id="artist-available-slots-container" class="hidden">
        <label for="artist-time-slot">Choose an Available Slot *</label>
        <select id="artist-time-slot" name="artist-time-slot"></select>
      </div>
    </div>

    <!-- Hidden fields for final appointment details -->
    <input type="hidden" id="appointment_date" name="appointment_date">
    <input type="hidden" id="appointment_start_time" name="appointment_start_time">
    <input type="hidden" id="appointment_end_time" name="appointment_end_time">
  </div>

  <!-- Marketing and Consent -->
  <div class="form-section">
    <label>
      <input type="checkbox" id="opt-in-marketing" name="opt-in-marketing" required>
      I agree to receive emails and SMS regarding my appointment and marketing.
    </label>
    <p style="font-size: 0.9em;">
      By checking this box, you consent to be contacted in compliance with applicable ADA and privacy regulations.
    </p>
  </div>

  <!-- Submit Button -->
  <button type="submit">Submit</button>
</form>

<!-- Supabase JS library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
<script>
  // Initialize Supabase (adjust your key/URL as needed)
  const supabaseUrl = 'https://shlvjhipxnslrncczopn.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'; // Use the full key in production
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  let loadedArtists = []; // Global variable to hold artists from the selected location

  // Load locations from Supabase into the locations dropdown
  async function loadLocations() {
    const { data, error } = await supabase
      .from('locations')
      .select('id, location_name');
    if (error) {
      console.error('Error loading locations:', error);
      return;
    }
    const locationSelect = document.getElementById('preferred-location');
    // Clear existing options (preserving the placeholder)
    while (locationSelect.options.length > 1) {
      locationSelect.remove(1);
    }
    data.forEach(loc => {
      const option = document.createElement('option');
      option.value = loc.id;
      option.textContent = loc.location_name;
      locationSelect.appendChild(option);
    });
  }

  // Load artists for the chosen location (querying all columns including schedule)
  async function loadArtistsByLocation(locationId) {
    const { data, error } = await supabase
      .from('artists')
      .select('*')
      .eq('location_id', locationId);
    if (error) {
      console.error('Error loading artists:', error);
      return;
    }
    loadedArtists = data; // Save the artists for later scheduling computations

    // Populate the artist selection for artist-priority branch.
    const artistSelect = document.getElementById('priority-artist');
    while (artistSelect.options.length > 1) {
      artistSelect.remove(1);
    }
    data.forEach(artist => {
      const option = document.createElement('option');
      // Save full details as JSON so we can use schedule info later
      option.value = JSON.stringify(artist);
      option.textContent = artist.artist_name;
      artistSelect.appendChild(option);
    });
  }

  // When the client selects a location, show the priority question and load artists.
  document.getElementById('preferred-location').addEventListener('change', function(e) {
    const locationId = e.target.value;
    if (locationId) {
      loadArtistsByLocation(locationId);
      document.getElementById('priority-question').classList.remove('hidden');
    } else {
      document.getElementById('priority-question').classList.add('hidden');
      document.getElementById('date-priority-section').classList.add('hidden');
      document.getElementById('artist-priority-section').classList.add('hidden');
    }
  });

  // Show the appropriate scheduling branch based on the priority radio selection.
  document.getElementsByName('priority').forEach(radio => {
    radio.addEventListener('change', function(e) {
      if (e.target.value === 'date') {
        document.getElementById('date-priority-section').classList.remove('hidden');
        document.getElementById('artist-priority-section').classList.add('hidden');
      } else if (e.target.value === 'artist') {
        document.getElementById('artist-priority-section').classList.remove('hidden');
        document.getElementById('date-priority-section').classList.add('hidden');
      }
    });
  });

  // Helper: Calculate the required tattoo duration (in minutes) based on area (height x width in inches)
  function calculateTattooDuration() {
    const height = parseFloat(document.getElementById('heightInches').value);
    const width = parseFloat(document.getElementById('widthInches').value);
    if (!height || !width) return null;
    const area = height * width;
    let duration = 0;
    if (area < 3) { duration = 30; }
    else if (area >= 3 && area <= 6) { duration = 45; }
    else if (area >= 7 && area <= 9) { duration = 60; }
    else if (area >= 10 && area <= 12) { duration = 75; }
    else if (area >= 13 && area <= 18) { duration = 120; }
    else if (area >= 19 && area <= 25) { duration = 190; }
    else if (area >= 26 && area <= 38) { duration = 285; }
    else if (area > 39) { duration = 'fullday'; }
    return duration;
  }

  // Helper: Convert a time string (HH:MM) into minutes
  function timeStrToMinutes(timeStr) {
    const [hours, minutes] = timeStr.split(':').map(Number);
    return hours * 60 + minutes;
  }

  // Helper: Convert minutes into a time string (HH:MM)
  function minutesToTimeStr(minutes) {
    const hrs = String(Math.floor(minutes / 60)).padStart(2, '0');
    const mins = String(minutes % 60).padStart(2, '0');
    return `${hrs}:${mins}`;
  }

  // Helper: Get day name (all lowercase) from a date string (YYYY-MM-DD)
  function getDayName(dateStr) {
    const date = new Date(dateStr);
    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    return days[date.getDay()];
  }

  // Compute available time slots for a given artist on a given date, taking into account the required duration.
  // This function queries the "artist_appointments" table and then calculates free intervals.
  async function computeTimeSlotsForArtist(artist, dateStr, duration) {
    const dayName = getDayName(dateStr);
    const startTimeStr = artist[dayName + '_start'];
    const endTimeStr = artist[dayName + '_end'];
    if (!startTimeStr || !endTimeStr) return []; // Artist is off on this day

    const workingStart = timeStrToMinutes(startTimeStr);
    const workingEnd = timeStrToMinutes(endTimeStr);

    // For a full-day appointment, check that there are no other appointments.
    if (duration === 'fullday') {
      const { data: appointments, error } = await supabase
        .from('artist_appointments')
        .select('*')
        .eq('artist_id', artist.id)
        .eq('date', dateStr);
      if (error) {
        console.error('Error fetching appointments:', error);
        return [];
      }
      if (appointments && appointments.length > 0) return [];
      return [{ start: startTimeStr, end: endTimeStr, fullDay: true }];
    }

    // Fetch existing appointments for the given artist and date.
    const { data: appointments, error } = await supabase
      .from('artist_appointments')
      .select('*')
      .eq('artist_id', artist.id)
      .eq('date', dateStr);
    if (error) {
      console.error('Error fetching appointments:', error);
      return [];
    }

    // Sort appointments by start time.
    appointments.sort((a, b) => timeStrToMinutes(a.start_time) - timeStrToMinutes(b.start_time));

    // Determine free intervals within the working hours.
    let freeIntervals = [];
    let currentStart = workingStart;
    appointments.forEach(app => {
      const appStart = timeStrToMinutes(app.start_time);
      if (appStart > currentStart) {
        freeIntervals.push({ start: currentStart, end: appStart });
      }
      currentStart = Math.max(currentStart, timeStrToMinutes(app.end_time));
    });
    if (currentStart < workingEnd) {
      freeIntervals.push({ start: currentStart, end: workingEnd });
    }

    // Divide free intervals into potential slots based on the tattoo duration.
    let slots = [];
    freeIntervals.forEach(interval => {
      for (let t = interval.start; t + duration <= interval.end; t += 15) {  // incrementing by 15 minutes
        slots.push({
          start: minutesToTimeStr(t),
          end: minutesToTimeStr(t + duration)
        });
      }
    });
    return slots;
  }

  // For the date-priority branch, when the user picks a date, compute available slots across all loaded artists.
  async function loadAvailableSlotsByDate() {
    const dateStr = document.getElementById('priority-date').value;
    if (!dateStr) return;
    const duration = calculateTattooDuration();
    if (!duration) {
      alert('Please enter tattoo dimensions so that we can calculate your appointment duration.');
      return;
    }
    let slotOptions = [];
    for (const artist of loadedArtists) {
      const slots = await computeTimeSlotsForArtist(artist, dateStr, duration);
      slots.forEach(slot => {
        slotOptions.push({
          artist_id: artist.id,
          artist_name: artist.artist_name,
          start: slot.start,
          end: slot.end,
          date: dateStr,
          fullDay: slot.fullDay || false
        });
      });
    }
    const timeSlotSelect = document.getElementById('time-slot');
    timeSlotSelect.innerHTML = '<option value="">-- Select a Slot --</option>';
    if (slotOptions.length === 0) {
      const option = document.createElement('option');
      option.value = "";
      option.textContent = "No available slots for the selected date and tattoo size.";
      timeSlotSelect.appendChild(option);
    } else {
      slotOptions.forEach(opt => {
        const option = document.createElement('option');
        // Save the details as JSON so we can later fill the hidden fields.
        option.value = JSON.stringify(opt);
        option.textContent = opt.fullDay ?
          `${opt.artist_name} (Full Day Appointment)` :
          `${opt.artist_name}: ${opt.start} - ${opt.end}`;
        timeSlotSelect.appendChild(option);
      });
    }
    document.getElementById('available-slots-container').classList.remove('hidden');
  }

  // For the artist-priority branch, when a date range is chosen, compute available dates (i.e. dates with available slots) for the chosen artist.
  async function loadAvailableDatesForArtist() {
    const artistData = document.getElementById('priority-artist').value;
    if (!artistData) return;
    const artist = JSON.parse(artistData);
    const startDate = document.getElementById('date-range-start').value;
    const endDate = document.getElementById('date-range-end').value;
    if (!startDate || !endDate) return;

    const duration = calculateTattooDuration();
    if (!duration) {
      alert('Please enter tattoo dimensions so that we can calculate your appointment duration.');
      return;
    }

    const dateOptions = [];
    const current = new Date(startDate);
    const last = new Date(endDate);
    while (current <= last) {
      const dateStr = current.toISOString().split('T')[0];
      const slots = await computeTimeSlotsForArtist(artist, dateStr, duration);
      if (slots.length > 0) {
        dateOptions.push({ date: dateStr, slots: slots });
      }
      current.setDate(current.getDate() + 1);
    }

    const availableDatesSelect = document.getElementById('available-dates');
    availableDatesSelect.innerHTML = '<option value="">-- Select Date --</option>';
    if (dateOptions.length === 0) {
      const option = document.createElement('option');
      option.value = "";
      option.textContent = "No available dates in this range.";
      availableDatesSelect.appendChild(option);
    } else {
      dateOptions.forEach(opt => {
        const option = document.createElement('option');
        // Save both the date and the available slots (as JSON) so that the time slots can be updated later.
        option.value = JSON.stringify(opt);
        option.textContent = opt.date;
        availableDatesSelect.appendChild(option);
      });
    }
    document.getElementById('available-dates-container').classList.remove('hidden');
  }

  // When a date is chosen in the artist-priority branch, show its available time slots.
  function loadArtistSlotsForDate() {
    const selectedOption = document.getElementById('available-dates').value;
    if (!selectedOption) return;
    const opt = JSON.parse(selectedOption);
    const artistTimeSlotSelect = document.getElementById('artist-time-slot');
    artistTimeSlotSelect.innerHTML = '<option value="">-- Select a Slot --</option>';
    opt.slots.forEach(slot => {
      const option = document.createElement('option');
      option.value = JSON.stringify({
        start: slot.start,
        end: slot.end,
        date: opt.date,
        fullDay: slot.fullDay || false
      });
      option.textContent = slot.fullDay ? `Full Day Appointment` : `${slot.start} - ${slot.end}`;
      artistTimeSlotSelect.appendChild(option);
    });
    document.getElementById('artist-available-slots-container').classList.remove('hidden');
  }

  // Event listeners for dynamic scheduling
  document.getElementById('priority-date').addEventListener('change', loadAvailableSlotsByDate);
  document.getElementById('date-range-start').addEventListener('change', loadAvailableDatesForArtist);
  document.getElementById('date-range-end').addEventListener('change', loadAvailableDatesForArtist);
  document.getElementById('available-dates').addEventListener('change', loadArtistSlotsForDate);

  // When a time slot is selected (in either branch), update the hidden fields with appointment details.
  document.getElementById('time-slot').addEventListener('change', function() {
    const slotValue = this.value;
    if (!slotValue) return;
    const slot = JSON.parse(slotValue);
    document.getElementById('appointment_date').value = slot.date;
    document.getElementById('appointment_start_time').value = slot.start;
    document.getElementById('appointment_end_time').value = slot.end;
  });
  document.getElementById('artist-time-slot').addEventListener('change', function() {
    const slotValue = this.value;
    if (!slotValue) return;
    const slot = JSON.parse(slotValue);
    document.getElementById('appointment_date').value = slot.date;
    document.getElementById('appointment_start_time').value = slot.start;
    document.getElementById('appointment_end_time').value = slot.end;
  });

  // On page load, load locations.
  window.addEventListener('DOMContentLoaded', loadLocations);

  // Form submission – the final FormData includes personal info, tattoo details, and the computed appointment fields.
  const form = document.getElementById('tattoo-form');
  form.addEventListener('submit', async function(event) {
    event.preventDefault();
    if (!document.getElementById('appointment_date').value ||
        !document.getElementById('appointment_start_time').value ||
        !document.getElementById('appointment_end_time').value) {
      alert('Please select an appointment slot.');
      return;
    }
    const formData = new FormData(form);
    try {
      const response = await fetch('https://hook.us2.make.com/41mjz37swhb5fdu238aqtr26x9by4b5e', {
        method: 'POST',
        body: formData
      });
      if (response.ok) {
        alert('Form submitted successfully! We will contact you soon via SMS or email.');
        form.reset();
        // Reset dynamic sections on successful submission.
        document.getElementById('priority-question').classList.add('hidden');
        document.getElementById('date-priority-section').classList.add('hidden');
        document.getElementById('artist-priority-section').classList.add('hidden');
        document.getElementById('available-slots-container').classList.add('hidden');
        document.getElementById('available-dates-container').classList.add('hidden');
        document.getElementById('artist-available-slots-container').classList.add('hidden');
      } else {
        alert('Error submitting form, please try again later.');
      }
    } catch (error) {
      console.error(error);
      alert('Error submitting form, please check the console for details.');
    }
  });
</script>
