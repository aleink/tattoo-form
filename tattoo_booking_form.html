<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tattoo Booking Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 
    Content-Security-Policy:
    - 'unsafe-eval' for Supabase
    - connect-src for your .supabase.co domain
  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://YOUR_PROJECT.supabase.co wss://YOUR_PROJECT.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    /* Mobile-friendly dark style. */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #111;
      color: #fff;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2 {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-weight: bold;
      margin: 8px 0 4px;
    }
    input, select, textarea, button {
      width: 100%;
      background: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 10px;
    }
    button {
      background: #333;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background: #555;
    }
    .form-section {
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .size-container {
      display: flex;
      gap: 10px;
    }
    .size-container > div {
      flex: 1;
    }
    .conditional-section {
      margin-top: 10px;
      background: #333;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 10px;
    }
    .slots-container {
      margin-top: 8px;
    }
    .slot-item {
      background: #444;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 6px;
      cursor: pointer;
    }
    .slot-item:hover {
      background: #555;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Tattoo Booking Form</h1>

  <form id="tattoo-form" enctype="multipart/form-data">
    <!-- Personal Info -->
    <div class="form-section">
      <h2>Personal Info</h2>
      <label for="name">Name *</label>
      <input type="text" id="name" name="name" required />

      <label for="phone">Phone Number (if not US, include prefix e.g. +34) *</label>
      <input type="tel" id="phone" name="phone" required />

      <label for="email">Email *</label>
      <input type="email" id="email" name="email" required />
    </div>

    <!-- Tattoo Info -->
    <div class="form-section">
      <h2>Tattoo Info</h2>
      <label for="placement">Placement *</label>
      <input type="text" id="placement" name="placement" placeholder="e.g. forearm, shoulder" required />

      <div class="size-container">
        <div>
          <label for="heightInches">Height (inches) *</label>
          <input type="number" id="heightInches" name="heightInches" required />
        </div>
        <div>
          <label for="widthInches">Width (inches) *</label>
          <input type="number" id="widthInches" name="widthInches" required />
        </div>
      </div>

      <label>Color or Black & Grey? *</label>
      <select id="colorOrBlack" name="colorOrBlack" required>
        <option value="color">Color</option>
        <option value="black-and-grey">Black and Grey</option>
      </select>

      <label for="description">Brief Description *</label>
      <textarea id="description" name="description" rows="4" required></textarea>

      <!-- Reference images -->
      <label>Reference Image 1</label>
      <input type="file" id="reference-image1" name="reference-image1" accept="image/*" />

      <label>Reference Image 2</label>
      <input type="file" id="reference-image2" name="reference-image2" accept="image/*" />

      <label>Reference Image 3</label>
      <input type="file" id="reference-image3" name="reference-image3" accept="image/*" />
    </div>

    <!-- Location first -->
    <div class="form-section">
      <label for="locationSelect">Preferred Location *</label>
      <select id="locationSelect" name="locationSelect" required>
        <option value="">-- Select Location --</option>
      </select>

      <!-- Then ask what's the priority -->
      <label for="prioritySelect">Which is more important to you?</label>
      <select id="prioritySelect" name="prioritySelect" required>
        <option value="">-- Select Priority --</option>
        <option value="artistPriority">Choosing the Artist</option>
        <option value="datePriority">Choosing the Date</option>
      </select>

      <!-- If date is priority, show date & timeslots from the schedule/appointments -->
      <div id="datePrioritySection" class="conditional-section hidden">
        <label for="dateChoice">Choose a Date</label>
        <input type="date" id="dateChoice" />

        <div class="slots-container" id="dateSlotsContainer"></div>
      </div>

      <!-- If artist is priority, show artist dropdown, date-range, then timeslots -->
      <div id="artistPrioritySection" class="conditional-section hidden">
        <label for="artistChoice">Choose an Artist</label>
        <select id="artistChoice">
          <option value="">-- Select Artist --</option>
        </select>

        <label for="rangeStart">Start Date</label>
        <input type="date" id="rangeStart" />
        <label for="rangeEnd">End Date</label>
        <input type="date" id="rangeEnd" />

        <div class="slots-container" id="artistSlotsContainer"></div>
      </div>
    </div>

    <!-- Marketing + Consent -->
    <div class="form-section">
      <label>
        <input type="checkbox" id="opt-in-marketing" name="opt-in-marketing" required />
        I agree to receive emails and SMS regarding my appointment and marketing.
      </label>
      <p style="font-size: 0.9em;">
        By checking this box, you consent to be contacted in compliance with applicable ADA and privacy regulations.
      </p>
    </div>

    <!-- Hidden fields for final chosen date/time/artist if needed -->
    <input type="hidden" id="finalArtistId" name="finalArtistId" />
    <input type="hidden" id="finalDate" name="finalDate" />
    <input type="hidden" id="finalStartTime" name="finalStartTime" />
    <input type="hidden" id="finalEndTime" name="finalEndTime" />

    <!-- Submit -->
    <button type="submit">Submit</button>
  </form>

  <!-- Supabase JS library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    // Setup
    const supabaseUrl='https://YOUR_PROJECT.supabase.co';
    const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase=window.supabase.createClient(supabaseUrl,supabaseKey);

    // Basic references
    const locationSelect=document.getElementById('locationSelect');
    const prioritySelect=document.getElementById('prioritySelect');
    const datePrioritySection=document.getElementById('datePrioritySection');
    const artistPrioritySection=document.getElementById('artistPrioritySection');
    const dateChoice=document.getElementById('dateChoice');
    const dateSlotsContainer=document.getElementById('dateSlotsContainer');
    const artistChoice=document.getElementById('artistChoice');
    const rangeStart=document.getElementById('rangeStart');
    const rangeEnd=document.getElementById('rangeEnd');
    const artistSlotsContainer=document.getElementById('artistSlotsContainer');

    // Hidden final fields
    const finalArtistId=document.getElementById('finalArtistId');
    const finalDate=document.getElementById('finalDate');
    const finalStartTime=document.getElementById('finalStartTime');
    const finalEndTime=document.getElementById('finalEndTime');

    // Tattoo size => approximate duration
    function computeTattooDurationSqInches(height, width){
      const sqIn=height*width;
      if(sqIn<3)return 30;      // minutes
      if(sqIn<=6)return 45;
      if(sqIn<=9)return 60;
      if(sqIn<=12)return 75;
      if(sqIn<=18)return 120;
      if(sqIn<=25)return 190;
      if(sqIn<=38)return 285;
      // >39
      return 9999; // means entire day
    }

    // On page load => load locations
    window.addEventListener('DOMContentLoaded', loadLocations);
    async function loadLocations(){
      const {data,error}=await supabase
        .from('locations')
        .select('id, location_name');
      if(error){console.error(error);return;}
      data.forEach(loc=>{
        const opt=document.createElement('option');
        opt.value=loc.id;
        opt.textContent=loc.location_name;
        locationSelect.appendChild(opt);
      });
    }

    // Priority selection => show/hide sections
    prioritySelect.addEventListener('change',()=>{
      const val=prioritySelect.value;
      if(val==='datePriority'){
        datePrioritySection.classList.remove('hidden');
        artistPrioritySection.classList.add('hidden');
      }else if(val==='artistPriority'){
        artistPrioritySection.classList.remove('hidden');
        datePrioritySection.classList.add('hidden');
      }else{
        datePrioritySection.classList.add('hidden');
        artistPrioritySection.classList.add('hidden');
      }
      clearSlots();
    });

    function clearSlots(){
      dateSlotsContainer.innerHTML='';
      artistSlotsContainer.innerHTML='';
    }

    // If date is priority => pick date => find all artists available that day => show available times
    dateChoice.addEventListener('change', ()=>{
      loadTimesForDate();
    });

    async function loadTimesForDate(){
      dateSlotsContainer.innerHTML='';
      const locId=locationSelect.value;
      const dateVal=dateChoice.value;
      if(!locId||!dateVal)return;

      // 1) compute needed duration from height*width
      const heightVal= parseFloat(document.getElementById('heightInches').value||'0');
      const widthVal= parseFloat(document.getElementById('widthInches').value||'0');
      const neededMins=computeTattooDurationSqInches(heightVal,widthVal);

      // 2) fetch all artists from that location
      let {data:artists,error}=await supabase
        .from('artists')
        .select('*')
        .eq('location_id', locId);
      if(error){console.error(error);return;}

      // 3) For each artist => check if they have a schedule that day, then compute available times
      const dayIndex=new Date(dateVal).getDay(); // 0=Sun,...6=Sat
      const dayCols=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
      const colStart= dayCols[dayIndex]+'_start';
      const colEnd=   dayCols[dayIndex]+'_end';

      let allSlots=[];

      // get existing appointments that day => only appointment_type in ('appointment','walk-in','completed') or maybe just 'appointment'?
      let {data:appts, error:apptsE}=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('date', dateVal)
        .in('appointment_type',['appointment','walk-in','completed']); 
      if(apptsE){console.error(apptsE);return;}

      artists.forEach(art=>{
        const st=art[colStart];
        const en=art[colEnd];
        if(!st||!en)return; // off day
        const startMin=toMinutes(st);
        const endMin=toMinutes(en);
        if(neededMins>=9999){
          // Means entire day => if no conflicting appts, it's 1 big slot
          const conflicts=appts.filter(a=> a.artist_id===art.id);
          if(conflicts.length>0){
            // not available
            return;
          }else{
            // entire day is available
            allSlots.push({
              artistId:art.id,
              artistName:art.artist_name,
              slotLabel:`${art.artist_name} => All Day`,
              startTime: st,
              endTime: en
            });
            return;
          }
        }
        // gather existing appointments for this artist
        const artistAppts=appts.filter(a=> a.artist_id===art.id);
        // build free slots
        let freeIntervals= buildFreeIntervals(startMin, endMin, artistAppts);
        // now from these intervals, only keep those >= neededMins
        freeIntervals.forEach(int=>{
          const length=int.end - int.start;
          if(length>= neededMins){
            // we can slice this interval into multiple smaller possible start times (every 5 mins) if you prefer
            // or just present as "start any time within"
            // For simplicity, let's produce possible starts in 30-min increments, or 5-min increments
            let increment=5; // minutes
            for(let t=int.start; t<=(int.end-neededMins); t+=increment){
              allSlots.push({
                artistId: art.id,
                artistName: art.artist_name,
                slotLabel:`${art.artist_name} => ${minsToHHMM(t)} - ${minsToHHMM(t+neededMins)}`,
                startTime: minsToHHMM(t),
                endTime:   minsToHHMM(t+neededMins)
              });
            }
          }
        });
      });
      // show them in dateSlotsContainer
      allSlots.sort((a,b)=> a.slotLabel.localeCompare(b.slotLabel));
      allSlots.forEach(sl=>{
        const div=document.createElement('div');
        div.classList.add('slot-item');
        div.textContent=sl.slotLabel;
        div.addEventListener('click',()=>{
          // set hidden fields
          finalArtistId.value=sl.artistId;
          finalDate.value=dateVal;
          finalStartTime.value=sl.startTime;
          finalEndTime.value=sl.endTime;
          alert(`Selected ${sl.slotLabel}`);
        });
        dateSlotsContainer.appendChild(div);
      });
    }

    // If artist is priority => pick artist => date range => show day & times
    artistChoice.addEventListener('change', ()=> {
      loadArtistRangeSlots();
    });
    rangeStart.addEventListener('change', ()=> {
      loadArtistRangeSlots();
    });
    rangeEnd.addEventListener('change', ()=> {
      loadArtistRangeSlots();
    });

    async function loadArtistRangeSlots(){
      artistSlotsContainer.innerHTML='';
      const locId=locationSelect.value;
      const artistVal=artistChoice.value;
      const rS=rangeStart.value;
      const rE=rangeEnd.value;
      if(!locId||!artistVal||!rS||!rE)return;

      // 1) compute neededMins
      const hVal=parseFloat(document.getElementById('heightInches').value||'0');
      const wVal=parseFloat(document.getElementById('widthInches').value||'0');
      const neededMins=computeTattooDurationSqInches(hVal,wVal);

      // 2) load that single artist
      let {data:artists,error}=await supabase
        .from('artists')
        .select('*')
        .eq('id', artistVal);
      if(error||!artists||!artists.length){console.error(error);return;}
      const art=artists[0];

      // 3) load appointments in [rS,rE] for that artist
      let {data:appts, error:apE}=await supabase
        .from('artist_appointments')
        .select('*')
        .gte('date', rS)
        .lte('date', rE)
        .in('appointment_type',['appointment','walk-in','completed'])
        .eq('artist_id', artistVal);
      if(apE){console.error(apE);return;}

      // we'll go day by day from rS => rE
      let allSlots=[];
      let startD=new Date(rS);
      let endD=new Date(rE);
      for(let d=startD; d<=endD; d=new Date(d.getTime()+86400000)){
        const dayVal=d.toISOString().split('T')[0];
        const dayIndex=d.getDay();
        const dayCols=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
        const scStart=dayCols[dayIndex]+'_start';
        const scEnd=dayCols[dayIndex]+'_end';
        const st=art[scStart];
        const en=art[scEnd];
        if(!st||!en) continue; // off
        const sMin=toMinutes(st);
        const eMin=toMinutes(en);
        if(neededMins>=9999){
          // entire day if no conflicts
          const dayAppts=appts.filter(a=> a.date===dayVal);
          if(dayAppts.length===0){
            allSlots.push({
              date: dayVal,
              startTime: st,
              endTime: en,
              label:`${dayVal} => All Day`
            });
            continue;
          } else {
            // not available if any conflict
            continue;
          }
        }
        // gather dayAppts
        const dayAppts=appts.filter(a=> a.date===dayVal);
        let free=buildFreeIntervals(sMin,eMin,dayAppts);
        free.forEach(int=>{
          let length=int.end - int.start;
          if(length>=neededMins){
            // create possible slots
            let increment=5;
            for(let t=int.start; t<=(int.end-neededMins); t+=increment){
              allSlots.push({
                date: dayVal,
                startTime: minsToHHMM(t),
                endTime: minsToHHMM(t+neededMins),
                label: `${dayVal} => ${minsToHHMM(t)} - ${minsToHHMM(t+neededMins)}`
              });
            }
          }
        });
      }
      // show
      allSlots.sort((a,b)=> a.label.localeCompare(b.label));
      allSlots.forEach(sl=>{
        const div=document.createElement('div');
        div.classList.add('slot-item');
        div.textContent=sl.label;
        div.addEventListener('click',()=>{
          finalArtistId.value=artistVal;
          finalDate.value=sl.date;
          finalStartTime.value=sl.startTime;
          finalEndTime.value=sl.endTime;
          alert(`Selected ${sl.label}`);
        });
        artistSlotsContainer.appendChild(div);
      });
    }

    // function to build free intervals [startMin, endMin, arrayOfAppts]
    function buildFreeIntervals(startM, endM, appts){
      // filter these appts => convert to minutes
      let blocks=[];
      appts.forEach(a=>{
        const sN=toMinutes(a.start_time);
        const eN=toMinutes(a.end_time);
        blocks.push({start:sN,end:eN});
      });
      // sort by start
      blocks.sort((x,y)=> x.start-y.start);
      // merge or create free intervals
      let free=[];
      let currentStart=startM;
      blocks.forEach(b=>{
        if(b.start>currentStart){
          // free block is [currentStart,b.start]
          free.push({start:currentStart,end:b.start});
        }
        // update currentStart
        if(b.end>currentStart){
          currentStart=b.end;
        }
      });
      if(currentStart<endM){
        free.push({start:currentStart,end:endM});
      }
      return free;
    }
    function minsToHHMM(m){
      const hh=Math.floor(m/60);
      const mm=m%60;
      return hh.toString().padStart(2,'0')+':'+mm.toString().padStart(2,'0');
    }
  </script>

  <script>
    // On form submit => sets final hidden fields => POST to Make webhook
    const form=document.getElementById('tattoo-form');
    form.addEventListener('submit', async(e)=>{
      e.preventDefault();
      // check if finalArtistId, finalDate, finalStartTime, finalEndTime are set
      if(!finalArtistId.value || !finalDate.value || !finalStartTime.value || !finalEndTime.value){
        alert('Please select a valid slot first.');
        return;
      }
      // Submit to Make
      const fd=new FormData(form);

      // send to webhook
      try{
        const resp=await fetch('YOUR_MAKE_WEBHOOK_URL',{
          method:'POST',
          body: fd
        });
        if(resp.ok){
          alert('Form submitted successfully! We will contact you soon via SMS or email.');
          form.reset();
          // reset hidden
          finalArtistId.value='';
          finalDate.value='';
          finalStartTime.value='';
          finalEndTime.value='';
          prioritySelect.value='';
          datePrioritySection.classList.add('hidden');
          artistPrioritySection.classList.add('hidden');
        } else {
          alert('Error submitting form, please try again later.');
        }
      }catch(err){
        console.error(err);
        alert('Error submitting form, please see console.');
      }
    });
  </script>
</body>
</html>
