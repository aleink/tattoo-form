<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tattoo Booking Form</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co https://hook.us2.make.com;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Helvetica Neue',Arial,sans-serif;background:#111;color:#fff;max-width:600px;margin:0 auto;padding:20px}
    h1,h2{margin-bottom:10px}
    label{display:block;font-weight:700;margin:8px 0 4px}
    input,select,textarea,button{width:100%;background:#222;color:#fff;border:1px solid #444;border-radius:4px;padding:8px;margin-bottom:10px}
    button{background:#333;cursor:pointer;border:none}
    button:hover{background:#555}
    .form-section{background:#222;border:1px solid #444;border-radius:6px;padding:15px;margin-bottom:20px}
    .size-container{display:flex;gap:10px}.size-container>div{flex:1}
    .conditional-section{margin-top:10px;background:#333;border:1px solid #444;border-radius:4px;padding:10px}
    .list-container{margin-top:6px}
    .list-item{background:#444;padding:8px;border-radius:4px;margin-bottom:6px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .list-item:hover{background:#555}
    .list-item.selected{background:#28a745!important;border:1px solid #4fdf6f}
    .hidden{display:none}
  </style>
</head>
<body>
<h1>Tattoo Booking Form</h1>

<form id="tattoo-form" enctype="multipart/form-data">
  <!-- PERSONAL -->
  <div class="form-section">
    <h2>Personal Info</h2>
    <label>Name *</label><input id="name" name="name" required>
    <label>Phone (include prefix if non-US, e.g. +34) *</label><input id="phone" name="phone" type="tel" required>
    <label>Email *</label><input id="email" name="email" type="email" required>
  </div>

  <!-- TATTOO -->
  <div class="form-section">
    <h2>Tattoo Info</h2>

    <label>Placement *</label><input id="placement" name="placement" required placeholder="forearm, shoulderâ€¦">

    <div class="size-container">
      <div><label>Height (in)</label><input id="heightInches" name="heightInches" type="number" step="0.5" required></div>
      <div><label>Width (in)</label><input id="widthInches"  name="widthInches" type="number" step="0.5" required></div>
    </div>

    <!-- NEW style & colour controls -->
    <label>Style Category *</label>
    <select id="styleCategory" name="style_category" required>
      <option value="" disabled selected>-- Select Style Category --</option>
      <option value="quickMinimal">Quick minimal lines / words</option>
      <option value="boldBlackPattern">Bold black patterns & symbols</option>
      <option value="flatColour">Solid-colour classics & cartoons</option>
      <option value="bngRealism">Smooth black-&-grey realism</option>
      <option value="fullColourFx">Full-colour painterly & FX</option>
    </select>

    <label>Colour / Shading *</label>
    <select id="colourMode" name="colour_mode" required>
      <option value="" disabled selected>-- Select Colour / Shading --</option>
      <option value="outlineSingle">Single-colour outline</option>
      <option value="flatSingle">Flat single-colour fill</option>
      <option value="flatMulti">Flat multi-colour fill</option>
      <option value="bngGradient">Black-&-grey gradient</option>
      <option value="colourGradient">Full-colour gradient</option>
    </select>

    <label>Detail Level *</label>
    <select id="detailLevel" name="detail_level" required>
      <option value="simple">Simple</option>
      <option value="medium">Medium</option>
      <option value="intricate">Intricate</option>
    </select>

    <label><input type="checkbox" id="premiumArea" name="premium_area">
      This is a premium area (hands, fingers, neck, face, lips, private)
    </label>

    <label>Description *</label><textarea id="description" name="description" rows="4" required></textarea>

    <label>Reference Image 1</label><input type="file" id="reference-image1" name="image1_urls" accept="image/*">
    <label>Reference Image 2</label><input type="file" id="reference-image2" name="image2_urls" accept="image/*">
    <label>Reference Image 3</label><input type="file" id="reference-image3" name="image3_urls" accept="image/*">
  </div>

  <!-- LOCATION & PRIORITY -->
  <div class="form-section">
    <label>Preferred Location *</label>
    <select id="locationSelect" name="preferred_location" required><option value="">-- Select Location --</option></select>

    <label style="margin-top:10px">Which is more important?</label>
    <select id="prioritySelect" required>
      <option value="">-- Choose --</option>
      <option value="datePriority">I need a specific date</option>
      <option value="artistPriority">I have a specific artist in mind</option>
    </select>

    <div id="datePrioritySection" class="conditional-section hidden">
      <label>Which date do you need?</label><input type="date" id="priorityDate">
      <div class="list-container" id="availableArtistsForDate"></div>
      <div class="list-container hidden" id="dateTimesContainer"></div>
    </div>

    <div id="artistPrioritySection" class="conditional-section hidden">
      <label>Choose Artist</label><select id="artistPick"><option value="">-- Pick Artist --</option></select>
      <label>Start Date</label><input type="date" id="rangeStart">
      <label>End Date</label><input type="date" id="rangeEnd">
      <div class="list-container" id="availableDaysForArtist"></div>
      <div class="list-container hidden" id="artistTimesContainer"></div>
    </div>
  </div>

  <!-- CONSENT -->
  <div class="form-section">
    <label><input type="checkbox" id="opt-in-marketing" name="opt_in_marketing" required>
      I agree to receive emails/SMS about my appointment and marketing.</label>
    <p style="font-size:.9em">By checking, you consent to be contacted in compliance with ADA & privacy regulations.</p>
  </div>

  <!-- APPOINTMENT SLOT -->
  <input type="hidden" id="finalArtistId" name="finalArtistId">
  <input type="hidden" id="finalDate"     name="finalDate">
  <input type="hidden" id="finalStartTime" name="finalStartTime">
  <input type="hidden" id="finalEndTime"   name="finalEndTime">

  <!-- CALC FIELDS -->
  <input type="hidden" id="calc_area"     name="calc_area">
  <input type="hidden" id="calc_minutes"  name="calc_minutes">
  <input type="hidden" id="calc_hours"    name="calc_hours">
  <input type="hidden" id="calc_sessions" name="calc_sessions">
  <input type="hidden" id="quote_mid"     name="quote_mid">
  <input type="hidden" id="quote_low"     name="quote_low">
  <input type="hidden" id="quote_high"    name="quote_high">

  <button type="submit">Submit</button>
</form>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
<script>
/* ---------- Supabase init ---------- */
const supabase = window.supabase.createClient(
  'https://shlvjhipxnslrncczopn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
);

/* ---------- CONSTANTS ---------- */
const HOURLY_RATE          = 200;
const SESSION_HOURS        = 6;
const SESSION_MINUTES      = SESSION_HOURS*60;
const MIN_PRICE_REGULAR    = 100;
const MIN_PRICE_PREMIUM    = 150;
const CAP_COLOR_GRADIENT   = 2500;
const CAP_BNG_GRADIENT     = 2200;
const SETUP_OVERHEAD_MIN   = 10;

const BASE_MINS = {
  quickMinimal:7, boldBlackPattern:10, flatColour:12, bngRealism:16, fullColourFx:20
};
const COLOUR_FACTORS = {
  outlineSingle:1, flatSingle:1.1, flatMulti:1.3, bngGradient:1.4, colourGradient:1.6
};
const DETAIL_FACTORS = { simple:1, medium:1.2, intricate:1.4 };

/* ---------- DOM refs ---------- */
const locSel=document.getElementById('locationSelect');
const prioSel=document.getElementById('prioritySelect');
const dateSect=document.getElementById('datePrioritySection');
const artistSect=document.getElementById('artistPrioritySection');
const dateInput=document.getElementById('priorityDate');
const listArtistsDate=document.getElementById('availableArtistsForDate');
const listSlotsDate=document.getElementById('dateTimesContainer');
const artistPick=document.getElementById('artistPick');
const rangeStart=document.getElementById('rangeStart');
const rangeEnd=document.getElementById('rangeEnd');
const listDays=document.getElementById('availableDaysForArtist');
const listSlotsArtist=document.getElementById('artistTimesContainer');

const hIn=document.getElementById('heightInches');
const wIn=document.getElementById('widthInches');
const styleCat=document.getElementById('styleCategory');
const colourMode=document.getElementById('colourMode');
const detailLevel=document.getElementById('detailLevel');
const premiumArea=document.getElementById('premiumArea');

const hidA=document.getElementById('finalArtistId');
const hidD=document.getElementById('finalDate');
const hidS=document.getElementById('finalStartTime');
const hidE=document.getElementById('finalEndTime');

/* ---------- Helpers ---------- */
const toMin=t=>{if(!t)return 0;const [h,m]=t.split(':').map(Number);return h*60+m;};
const minsTo12=m=>{let h=Math.floor(m/60),mm=m%60,ap='AM';if(h===0)h=12;else if(h===12)ap='PM';else if(h>12){h-=12;ap='PM';}return`${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')} ${ap}`;};

/* ---------- Core calculation ---------- */
function computeEstimate(){
  const area=Math.max(1,(+hIn.value||0)*(+wIn.value||0));
  const base=BASE_MINS[styleCat.value]||BASE_MINS.quickMinimal;
  const col=COLOUR_FACTORS[colourMode.value]||1;
  const det=DETAIL_FACTORS[detailLevel.value]||1;

  let minutes=area*base*col*det+SETUP_OVERHEAD_MIN;
  let hours=minutes/60;
  let sessions=Math.ceil((hours/SESSION_HOURS)*2)/2;

  let price=hours*HOURLY_RATE;
  price=Math.max(price,premiumArea.checked?MIN_PRICE_PREMIUM:MIN_PRICE_REGULAR);
  if(colourMode.value==='colourGradient')price=Math.min(price,CAP_COLOR_GRADIENT);
  if(colourMode.value==='bngGradient')   price=Math.min(price,CAP_BNG_GRADIENT);
  price=Math.ceil(price/10)*10;

  return{
    area,
    minutes,
    hours:+hours.toFixed(1),
    sessions,
    price,
    low:Math.floor(price*0.9/10)*10,
    high:Math.ceil(price*1.2/10)*10
  };
}
function fillHidden(){
  const e=computeEstimate();
  document.getElementById('calc_area').value=e.area;
  document.getElementById('calc_minutes').value=Math.round(e.minutes);
  document.getElementById('calc_hours').value=e.hours;
  document.getElementById('calc_sessions').value=e.sessions;
  document.getElementById('quote_mid').value=e.price;
  document.getElementById('quote_low').value=e.low;
  document.getElementById('quote_high').value=e.high;
}
function needMin(){const m=computeEstimate().minutes;return m>=SESSION_MINUTES?9999:Math.ceil(m/5)*5;}

/* ---------- buildFree ---------- */
function buildFree(start,end,apps){
  const BUF=15;
  const busy=apps.map(a=>({s:Math.max(start,toMin(a.start_time)-BUF),e:Math.min(end,toMin(a.end_time)+BUF)})).sort((a,b)=>a.s-b.s);
  const free=[],cur={v:start};
  busy.forEach(b=>{if(b.s>cur.v)free.push({s:cur.v,e:b.s});if(b.e>cur.v)cur.v=b.e;});
  if(cur.v<end)free.push({s:cur.v,e:end});
  return free;
}

/* ---------- Rounding size inputs ---------- */
[hIn,wIn].forEach(inp=>inp.addEventListener('change',()=>{const v=parseFloat(inp.value||'0');inp.value=(Math.ceil(v*2)/2).toFixed(1).replace(/\.0$/,'');fillHidden();}));

/* ---------- LOCATION list ---------- */
document.addEventListener('DOMContentLoaded',async()=>{
  const {data}=await supabase.from('locations').select('id,location_name');
  data?.forEach(l=>{const o=document.createElement('option');o.value=l.id;o.textContent=l.location_name;locSel.appendChild(o);});
});

/* ---------- UI toggles and scheduler (identical logic) ---------- */
const dayCols=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
function clearSel(){document.querySelectorAll('.list-item.selected').forEach(li=>li.classList.remove('selected'));hidA.value=hidD.value=hidS.value=hidE.value='';}
function slotBtn(txt,start,end,aid,date,container){
  const d=document.createElement('div');d.className='list-item';d.textContent=txt;
  d.onclick=()=>{clearSel();d.classList.add('selected');hidA.value=aid;hidD.value=date;hidS.value=start;hidE.value=end;};
  container.appendChild(d);
}
function refreshUI(){
  listArtistsDate.innerHTML='';listSlotsDate.classList.add('hidden');
  listDays.innerHTML='';listSlotsArtist.classList.add('hidden');
  if(prioSel.value==='datePriority'){dateSect.classList.remove('hidden');artistSect.classList.add('hidden');loadArtistsForDate();}
  else if(prioSel.value==='artistPriority'){artistSect.classList.remove('hidden');dateSect.classList.add('hidden');loadArtistDropdown();}
  else{dateSect.classList.add('hidden');artistSect.classList.add('hidden');}
}
prioSel.addEventListener('change',refreshUI);

/* ----- DATE-priority flow ----- */
async function loadArtistsForDate(){
  if(!locSel.value||!dateInput.value)return;
  const {data:arts}=await supabase.from('artists').select('*').eq('location_id',locSel.value);
  const artIds=arts.map(a=>a.id);
  const {data:vac}=await supabase.from('artist_vacations').select('artist_id').in('artist_id',artIds).lte('vacation_start',dateInput.value).gte('vacation_end',dateInput.value);
  const vset=new Set(vac?.map(v=>v.artist_id)||[]);
  const {data:apps}=await supabase.from('artist_appointments').select('*').eq('date',dateInput.value);
  const idx=new Date(`${dateInput.value}T00:00:00`).getDay(),need=needMin(),cs=`${dayCols[idx]}_start`,ce=`${dayCols[idx]}_end`;
  const avail=arts.filter(a=>{
    if(vset.has(a.id))return false;
    const st=a[cs],en=a[ce];if(!st||!en)return false;
    if(need>=9999)return !apps.some(ap=>ap.artist_id===a.id);
    return buildFree(toMin(st),toMin(en),apps.filter(ap=>ap.artist_id===a.id)).some(f=>f.e-f.s>=need);
  });
  listArtistsDate.innerHTML=avail.length?'':'<p>No artists available for that date.</p>';
  avail.forEach(a=>{const d=document.createElement('div');d.className='list-item';d.textContent=a.artist_name;d.onclick=()=>{clearSel();d.classList.add('selected');showSlotsDate(a);};listArtistsDate.appendChild(d);});
}
async function showSlotsDate(artist){
  listSlotsDate.innerHTML='';listSlotsDate.classList.remove('hidden');
  const need=needMin(),{data:apps}=await supabase.from('artist_appointments').select('*').eq('artist_id',artist.id).eq('date',dateInput.value);
  const idx=new Date(`${dateInput.value}T00:00:00`).getDay(),st=artist[`${dayCols[idx]}_start`],en=artist[`${dayCols[idx]}_end`];
  if(!st||!en){listSlotsDate.innerHTML='<p>Artist is off that day.</p>';return;}
  if(need>=9999){if(apps.length)listSlotsDate.innerHTML='<p>No full-day slot available.</p>';else slotBtn(`All Day â€“ ${artist.artist_name}`,st,en,artist.id,dateInput.value,listSlotsDate);return;}
  const free=buildFree(toMin(st),toMin(en),apps);let any=false;
  free.forEach(f=>{for(let t=f.s;t<=f.e-need;t+=5){slotBtn(`${minsTo12(t)} â€“ ${minsTo12(t+need)}`,minsTo12(t),minsTo12(t+need),artist.id,dateInput.value,listSlotsDate);any=true;}});
  if(!any)listSlotsDate.innerHTML='<p>No timeslots fit the requested duration.</p>';
}

/* ----- ARTIST-priority flow ----- */
async function loadArtistDropdown(){
  const prev=artistPick.value;
  artistPick.innerHTML='<option value="">-- Pick Artist --</option>';
  if(!locSel.value)return;
  const {data}=await supabase.from('artists').select('id,artist_name').eq('location_id',locSel.value);
  data?.forEach(a=>{const o=document.createElement('option');o.value=a.id;o.textContent=a.artist_name;artistPick.appendChild(o);});
  if(prev&&artistPick.querySelector(`[value="${prev}"]`))artistPick.value=prev;
  loadDays();
}
async function loadDays(){
  listDays.innerHTML='';listSlotsArtist.classList.add('hidden');
  if(!artistPick.value||!rangeStart.value||!rangeEnd.value)return;
  const {data:artist}=await supabase.from('artists').select('*').eq('id',artistPick.value).single();
  const {data:apps}=await supabase.from('artist_appointments').select('*').eq('artist_id',artist.id).gte('date',rangeStart.value).lte('date',rangeEnd.value);
  const {data:vac}=await supabase.from('artist_vacations').select('*').eq('artist_id',artist.id).lte('vacation_start',rangeEnd.value).gte('vacation_end',rangeStart.value);
  const need=needMin(),days=[];
  for(let d=new Date(rangeStart.value);d<=new Date(rangeEnd.value);d.setDate(d.getDate()+1)){
    const iso=d.toISOString().slice(0,10),idx=d.getDay();
    if(vac?.some(v=>v.vacation_start<=iso&&v.vacation_end>=iso))continue;
    const st=artist[`${dayCols[idx]}_start`],en=artist[`${dayCols[idx]}_end`];if(!st||!en)continue;
    if(need>=9999){if(!apps.some(a=>a.date===iso))days.push({d:iso,l:`All Day â€“ ${iso}`});continue;}
    if(buildFree(toMin(st),toMin(en),apps.filter(a=>a.date===iso)).some(f=>f.e-f.s>=need))days.push({d:iso,l:iso});
  }
  listDays.innerHTML=days.length?'':'<p>No available days in that range.</p>';
  days.forEach(o=>{const div=document.createElement('div');div.className='list-item';div.textContent=o.l;div.onclick=()=>showSlotsArtistDay(o.d);listDays.appendChild(div);});
}
async function showSlotsArtistDay(day){
  listSlotsArtist.innerHTML='';listSlotsArtist.classList.remove('hidden');
  const {data:artist}=await supabase.from('artists').select('*').eq('id',artistPick.value).single();
  const {data:vac}=await supabase.from('artist_vacations').select('*').eq('artist_id',artist.id).lte('vacation_start',day).gte('vacation_end',day);
  if(vac?.length){listSlotsArtist.innerHTML='<p>Artist on vacation that day.</p>';return;}
  const {data:apps}=await supabase.from('artist_appointments').select('*').eq('artist_id',artist.id).eq('date',day);
  const idx=new Date(`${day}T00:00:00`).getDay(),st=artist[`${dayCols[idx]}_start`],en=artist[`${dayCols[idx]}_end`];
  if(!st||!en){listSlotsArtist.innerHTML='<p>Artist off that day.</p>';return;}
  const need=needMin();
  if(need>=9999){if(apps.length)listSlotsArtist.innerHTML='<p>No full-day slot available.</p>';else slotBtn('All Day',st,en,artist.id,day,listSlotsArtist);return;}
  const free=buildFree(toMin(st),toMin(en),apps);let any=false;
  free.forEach(f=>{for(let t=f.s;t<=f.e-need;t+=5){slotBtn(`${minsTo12(t)} â€“ ${minsTo12(t+need)}`,minsTo12(t),minsTo12(t+need),artist.id,day,listSlotsArtist);any=true;}});
  if(!any)listSlotsArtist.innerHTML='<p>No timeslots fit the requested duration.</p>';
}

/* ---------- first calc & UI ---------- */
fillHidden();refreshUI();

/* ---------- SUBMIT ---------- */
document.getElementById('tattoo-form').addEventListener('submit',async e=>{
  e.preventDefault();
  if(!hidA.value){alert('Please pick an appointment slot.');return;}
  const btn=e.submitter||e.target.querySelector('button[type="submit"]');
  btn.disabled=true;
  fillHidden();                                   // make sure numbers are current

  const fd=new FormData(e.target);

  /* --- 1. write to Supabase form_submissions --- */
  const payload={};
  fd.forEach((v,k)=>{ if(!(v instanceof File)) payload[k]=v; });  // skip files
  const { error } = await supabase.from('form_submissions').insert(payload);
  if(error){
    console.error(error);
    alert('Database error â€“ please try again.');
    btn.disabled=false;
    return;
  }

  /* --- 2. forward original FormData (incl. images) to Make --- */
  const r=await fetch('https://hook.us2.make.com/41mjz37swhb5fdu238aqtr26x9by4b5e',{method:'POST',body:fd});

  if(r.ok){
    document.body.innerHTML='<h2 style="text-align:center;margin-top:40px;">Thanks â€” your request was sent! Weâ€™ll text you soon.</h2>';
  }else{
    alert('Submission error â€“ please try again.');
    btn.disabled=false;
  }
});
</script>
</body>
</html>
