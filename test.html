<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Club Tattoo Management Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- CSP for Supabase -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net ;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co  wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #111;
      color: #fff;
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #000;
      padding: 20px;
      text-align: center;
      border-bottom: 2px solid #444;
    }

    header h1 {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 1px;
    }

    nav.tabs {
      display: flex;
      overflow-x: auto;
      background: #222;
      border-bottom: 2px solid #444;
    }

    .tab-link {
      flex-shrink: 0;
      padding: 15px 20px;
      color: #bbb;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .tab-link.active,
    .tab-link:hover {
      background: #333;
      color: #fff;
    }

    main {
      flex: 1;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    footer {
      background: #000;
      color: #666;
      text-align: center;
      padding: 15px;
      border-top: 2px solid #444;
    }

    /* Login Modal */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 6px;
      max-width: 400px;
      width: 100%;
    }

    .modal-content label {
      display: block;
      margin: 10px 0 4px;
    }

    .modal-content input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: none;
      background: #333;
      color: #fff;
    }

    .modal-content button {
      padding: 10px 20px;
      background: #777;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    .message {
      color: red;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      nav.tabs {
        flex-wrap: nowrap;
      }
    }
  </style>
</head>
<body>

<!-- Login Modal -->
<div id="login-modal" class="modal">
  <div class="modal-content">
    <h2>Login</h2>
    <label>Email</label>
    <input type="email" id="login-email" placeholder="GM/HR/SM/FD email">
    <label>Password</label>
    <input type="password" id="login-password" placeholder="Password">
    <button onclick="handleLogin()">Login</button>
    <div id="login-message" class="message"></div>
  </div>
</div>

<!-- Navigation Tabs -->
<header>
  <h1>Club Tattoo Management Tool</h1>
</header>
<nav class="tabs" id="tabs-nav"></nav>

<!-- Main Content Area -->
<main id="main-content"></main>

<footer>
  <p>&copy; <span id="year"></span> Club Tattoo. All rights reserved.</p>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/ @supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
<script>
  const supabaseUrl = 'https://shlvjhipxnslrncczopn.supabase.co ';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  let currentUserRole = null;

  document.getElementById('year').textContent = new Date().getFullYear();

  const tabsConfig = [
    { id: 'booking-form', title: 'Booking Form', roles: ['*'] },
    { id: 'calendar', title: 'Calendar', roles: ['fd', 'sm', 'gm'] },
    { id: 'artists', title: 'Manage Artists', roles: ['gm', 'hr', 'sm'] },
    { id: 'schedules', title: 'Manage Schedules', roles: ['gm', 'hr', 'sm'] },
    { id: 'vacations', title: 'Manage Vacations', roles: ['gm', 'hr', 'sm'] },
    { id: 'payroll', title: 'Payroll', roles: ['ad', 'gm'] },
  ];

  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
  }

  async function handleLogin() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const messageEl = document.getElementById('login-message');

    if (!email || !password) {
      messageEl.textContent = 'Email and Password required.';
      return;
    }

    const { data, error } = await supabase
      .from('users')
      .select('*')
      .eq('email', email)
      .single();

    if (error || !data || data.password_hash !== password) {
      messageEl.textContent = 'Invalid credentials.';
      return;
    }

    currentUserRole = data.role;
    localStorage.setItem('currentUserRole', currentUserRole);

    document.getElementById('login-modal').style.display = 'none';

    renderTabs();
  }

  function renderTabs() {
    const nav = document.getElementById('tabs-nav');
    nav.innerHTML = '';
    const allowedTabs = tabsConfig.filter(t => t.roles.includes(currentUserRole) || t.roles.includes('*'));

    allowedTabs.forEach(tab => {
      const a = document.createElement('div');
      a.className = 'tab-link';
      a.innerText = tab.title;
      a.onclick = () => showTab(tab.id);
      nav.appendChild(a);
    });

    if (allowedTabs.length > 0) {
      showTab(allowedTabs[0].id);
    }
  }

  // Inject tab contents dynamically
  async function loadTabContent(tabId) {
    const response = await fetch(`${tabId}.html`);
    const text = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');

    const main = document.getElementById('main-content');
    const container = document.createElement('div');
    container.id = tabId;
    container.className = 'tab-content';

    // Extract body content only
    Array.from(doc.body.children).forEach(child => {
      container.appendChild(child.cloneNode(true));
    });

    main.appendChild(container);
  }

  async function initApp() {
    const storedRole = localStorage.getItem('currentUserRole');
    if (!storedRole) {
      return; // Show login modal
    }

    currentUserRole = storedRole;
    renderTabs();

    // Load all necessary tab contents
    for (const tab of tabsConfig) {
      await loadTabContent(tab.id);
    }
  }

  window.addEventListener('DOMContentLoaded', initApp);
</script>

</body>
</html>