<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manage Locations</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- ─── CSP ─── -->
<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
        connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
        style-src 'self' 'unsafe-inline';
        object-src 'none';
      ">

<!-- ─── THEME ─── -->
<style>
:root{ --bg0:#111;--bg1:#222;--bg2:#333;--border:#444;--txt:#fff;--txt-dim:#ccc;--accent:#28a745 }
body.light{
  --bg0:#f7f7f7;--bg1:#fff;--bg2:#e6e6e6;
  --border:#b7b7b7;--txt:#000;--txt-dim:#444;--accent:#0d6efd;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Helvetica Neue',Arial,sans-serif}
body{
  background:var(--bg0);color:var(--txt);
  max-width:820px;margin:32px auto;padding:28px;
  transition:background .25s,color .25s;
}
h1{font-size:1.8rem;text-align:center;margin-bottom:24px}
h2{font-size:1.25rem;margin:10px 0 14px}

.card{
  background:var(--bg1);border:1px solid var(--border);
  border-radius:6px;padding:22px;margin-bottom:30px;
}

label{display:block;font-weight:700;margin:10px 0 4px}
input,textarea{
  width:100%;padding:8px;background:var(--bg0);color:var(--txt);
  border:1px solid var(--border);border-radius:4px;margin-bottom:12px;resize:vertical
}
input:focus,textarea:focus{outline:2px solid var(--accent)}

button{
  background:var(--bg2);color:var(--txt);border:none;border-radius:4px;
  padding:8px 16px;cursor:pointer;transition:background .2s
}
button:hover{background:#555}
.btn-mini{padding:4px 10px;font-size:.85em;margin-right:6px}

.message{color:#ff6262;font-size:.9em;margin-top:8px}
.hidden{display:none}

/* top bar */
#top-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
#top-bar.hidden{display:none}
#theme-btn{min-width:110px}

/* table */
.table-wrap{max-height:340px;overflow-y:auto;border:1px solid var(--border);margin-top:10px}
table{width:100%;border-collapse:collapse;font-size:.9em}
th{position:sticky;top:0;background:var(--bg1);color:var(--txt);border-bottom:2px solid var(--border);padding:10px}
td{padding:8px;border-bottom:1px solid var(--border);color:var(--txt-dim)}
tr:nth-child(even){background:var(--bg0)}
</style>
</head>
<body>
<h1>Manage Locations</h1>

<!-- TOP BAR -->
<div id="top-bar" class="hidden">
  <div style="font-weight:600">Location Manager</div>
  <div>
    <button id="theme-btn" class="btn-mini">Light mode</button>
    <button id="logout-btn" class="btn-mini">Logout</button>
  </div>
</div>

<!-- LOGIN -->
<div id="login-section" class="card">
  <label>Email</label><input id="login-email" type="email" autocomplete="username">
  <label>Password</label><input id="login-pass" type="password" autocomplete="current-password">
  <button id="login-btn">Login</button>
  <div id="login-msg" class="message"></div>
</div>

<!-- LOCATION MANAGEMENT -->
<div id="loc-section" class="card hidden">
  <h2>Add / Edit Location</h2>

  <label>Name</label><input id="l-name">
  <label>Address</label><input id="l-address">
  <label>Phone</label><input id="l-phone">
  <label>Business Hours</label><textarea id="l-hours" rows="3" placeholder="Mon - Thu 10 AM-11 PM&#10;Fri - Sun 10 AM-12 AM"></textarea>
  <label>Email</label><input id="l-email" type="email">
  <label>Timezone Offset (e.g. -8, 0, +2)</label><input id="l-tz">

  <div style="margin-top:8px">
    <button id="save-btn">Save Location</button>
    <button id="clear-btn">Clear</button>
    <div id="loc-msg" class="message"></div>
  </div>

  <hr style="border-color:var(--border);margin:28px 0">

  <div class="table-wrap">
    <table id="loc-table">
      <thead><tr>
        <th>Name</th><th>Address</th><th>Phone</th><th>Email</th><th>Timezone</th><th>Actions</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
<script>
/* ---------- INIT ---------- */
const supabase = window.supabase.createClient(
  'https://shlvjhipxnslrncczopn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
);

/* ---------- DOM ---------- */
const topBar     = document.getElementById('top-bar');
const themeBtn   = document.getElementById('theme-btn');
const logoutBtn  = document.getElementById('logout-btn');

const loginSec   = document.getElementById('login-section');
const loginEmail = document.getElementById('login-email');
const loginPass  = document.getElementById('login-pass');
const loginBtn   = document.getElementById('login-btn');
const loginMsg   = document.getElementById('login-msg');

const locSec     = document.getElementById('loc-section');
const fields     = {
  id   : null,
  name : document.getElementById('l-name'),
  addr : document.getElementById('l-address'),
  phone: document.getElementById('l-phone'),
  hours: document.getElementById('l-hours'),
  email: document.getElementById('l-email'),
  tz   : document.getElementById('l-tz')
};
const saveBtn    = document.getElementById('save-btn');
const clearBtn   = document.getElementById('clear-btn');
const locMsg     = document.getElementById('loc-msg');
const tbody      = document.querySelector('#loc-table tbody');

/* ---------- THEME ---------- */
(function(){
  if(localStorage.getItem('ui-theme')==='light'){
    document.body.classList.add('light');
    themeBtn.textContent='Dark mode';
  }
})();
themeBtn.onclick=()=>{
  const light=document.body.classList.toggle('light');
  themeBtn.textContent=light?'Dark mode':'Light mode';
  localStorage.setItem('ui-theme',light?'light':'dark');
};

/* ---------- LOGIN ---------- */
loginBtn.onclick=async()=>{
  loginMsg.textContent='';
  if(!loginEmail.value||!loginPass.value){
    loginMsg.textContent='Email & password required.';return;
  }
  const {data,error}=await supabase.from('users').select('*').eq('email',loginEmail.value.trim());
  if(error||!data?.length){loginMsg.textContent='Invalid credentials.';return;}
  const u=data[0];
  if(u.password_hash!==loginPass.value.trim()){loginMsg.textContent='Invalid credentials.';return;}
  if(u.role!=='gm'){loginMsg.textContent='Access restricted to GM only.';return;}

  loginSec.classList.add('hidden');
  locSec.classList.remove('hidden');
  topBar.classList.remove('hidden');
  loadLocations();
};

/* ---------- LOGOUT ---------- */
logoutBtn.onclick=()=>{
  loginEmail.value=loginPass.value='';
  loginSec.classList.remove('hidden');
  locSec.classList.add('hidden');
  topBar.classList.add('hidden');
  tbody.innerHTML='';
  clearForm();
};

/* ---------- LOAD TABLE ---------- */
async function loadLocations(){
  tbody.innerHTML='';
  const {data,error}=await supabase.from('locations').select('*').order('location_name',{ascending:true});
  if(error){console.error(error);locMsg.textContent='Error loading locations.';return;}
  data.forEach(l=>{
    const tr=document.createElement('tr');
    tr.dataset.location=JSON.stringify(l);
    tr.innerHTML=`
      <td>${l.location_name}</td>
      <td>${l.address||''}</td>
      <td>${l.phone||''}</td>
      <td>${l.email||''}</td>
      <td>${l.timezone||''}</td>
      <td>
        <button class="btn-mini" onclick="editLoc('${l.id}')">Edit</button>
        <button class="btn-mini" onclick="delLoc('${l.id}')">Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- CRUD ---------- */
window.editLoc=id=>{
  const row=[...tbody.children].find(r=>JSON.parse(r.dataset.location).id===id);
  if(!row)return;
  const l=JSON.parse(row.dataset.location);
  fields.id   = l.id;
  fields.name.value = l.location_name||'';
  fields.addr.value = l.address||'';
  fields.phone.value= l.phone||'';
  fields.hours.value= l.business_hours||'';
  fields.email.value= l.email||'';
  fields.tz.value   = l.timezone||'';
  locMsg.textContent='Editing – remember to Save.';
};

window.delLoc=async id=>{
  if(!confirm('Delete this location?'))return;
  const {error}=await supabase.from('locations').delete().eq('id',id);
  locMsg.textContent=error?'Error deleting.':'Location deleted.';
  if(!error){loadLocations();clearForm();}
};

saveBtn.onclick=async()=>{
  locMsg.textContent='';
  if(!fields.name.value.trim()){
    locMsg.textContent='Name required.';return;
  }
  const payload={
    location_name : fields.name.value.trim(),
    address       : fields.addr.value.trim()||null,
    phone         : fields.phone.value.trim()||null,
    business_hours: fields.hours.value.trim()||null,
    email         : fields.email.value.trim()||null,
    timezone      : fields.tz.value.trim()||null
  };
  let res;
  if(fields.id){
    res=await supabase.from('locations').update(payload).eq('id',fields.id);
  }else{
    res=await supabase.from('locations').insert([payload]);
  }
  locMsg.textContent=res.error?'Error saving.':'Saved!';
  if(!res.error){loadLocations();clearForm();}
};

clearBtn.onclick=clearForm;
function clearForm(){
  fields.id=null;
  [fields.name,fields.addr,fields.phone,fields.hours,fields.email,fields.tz].forEach(f=>f.value='');
  locMsg.textContent='';
}

/* expose for inline buttons */
window.editLoc=window.editLoc;
window.delLoc =window.delLoc;
</script>
</body>
</html>
