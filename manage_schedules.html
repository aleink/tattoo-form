<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Schedules</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 
    Content Security Policy allowing 'unsafe-eval' and 'unsafe-inline' so Supabase can function
    Adjust connect-src if your Supabase domain differs
  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 20px auto;
      padding: 10px;
      overflow-y: auto;
    }
    h1 {
      text-align: center;
    }
    .login-section, .schedules-section {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      display: block;
      margin: 8px 0 4px;
    }
    input, select {
      width: 100%;
      padding: 7px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 14px;
      cursor: pointer;
      margin-right: 10px;
    }
    .message {
      color: red;
      margin-top: 8px;
    }
    .hidden {
      display: none;
    }
    .days-container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .day-block {
      border: 1px solid #ccc;
      padding: 10px;
    }
    .day-block h3 {
      margin-top: 0;
      font-size: 1.1em;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Manage Artist Schedules</h1>

  <!-- GM Login -->
  <div class="login-section" id="login-section">
    <label for="gm-email">GM Email</label>
    <input type="email" id="gm-email" />

    <label for="gm-password">GM Password</label>
    <input type="password" id="gm-password" />

    <button id="gm-login-btn">Login</button>
    <div class="message" id="login-message"></div>
  </div>

  <!-- Main schedules section -->
  <div class="schedules-section hidden" id="schedules-section">
    <h2>Assign Working Days & Hours</h2>

    <!-- Filter by location -->
    <label for="location-filter">Filter by Location</label>
    <select id="location-filter">
      <option value="">-- Select Location --</option>
    </select>

    <!-- Filter by artist -->
    <label for="artist-filter">Select Artist</label>
    <select id="artist-filter">
      <option value="">-- Select Artist --</option>
    </select>

    <hr />

    <h3>Weekly Schedule</h3>
    <p>Select start/end time for each day. Leave blank if the artist doesnâ€™t work that day.</p>
    <div class="days-container" id="days-container">
      <!-- We'll create 7 blocks here (Sun-Sat), each with start & end inputs. -->
    </div>

    <button id="save-schedule-btn">Save Schedule</button>
    <div class="message" id="schedule-message"></div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    const supabaseUrl = 'https://shlvjhipxnslrncczopn.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // GM login elements
    const loginSection = document.getElementById('login-section');
    const gmEmailInput = document.getElementById('gm-email');
    const gmPasswordInput = document.getElementById('gm-password');
    const gmLoginBtn = document.getElementById('gm-login-btn');
    const loginMessage = document.getElementById('login-message');

    // Schedules section
    const schedulesSection = document.getElementById('schedules-section');
    const locationFilter = document.getElementById('location-filter');
    const artistFilter = document.getElementById('artist-filter');
    const daysContainer = document.getElementById('days-container');
    const saveScheduleBtn = document.getElementById('save-schedule-btn');
    const scheduleMessage = document.getElementById('schedule-message');

    // We'll build 7 day blocks: sunday...saturday
    // Each block has 2 <input type="time"> for start & end
    const dayNames = [
      { key: 'sunday', label: 'Sunday' },
      { key: 'monday', label: 'Monday' },
      { key: 'tuesday', label: 'Tuesday' },
      { key: 'wednesday', label: 'Wednesday' },
      { key: 'thursday', label: 'Thursday' },
      { key: 'friday', label: 'Friday' },
      { key: 'saturday', label: 'Saturday' }
    ];
    let dayInputs = {}; // e.g. dayInputs['monday'] = { start, end }

    // Build day blocks once DOM loaded
    function buildDayBlocks() {
      daysContainer.innerHTML = '';
      dayNames.forEach(d => {
        const block = document.createElement('div');
        block.classList.add('day-block');

        const title = document.createElement('h3');
        title.textContent = d.label;
        block.appendChild(title);

        // Start time
        const startLabel = document.createElement('label');
        startLabel.textContent = 'Start Time';
        block.appendChild(startLabel);
        const startInput = document.createElement('input');
        startInput.type = 'time';
        block.appendChild(startInput);

        // End time
        const endLabel = document.createElement('label');
        endLabel.textContent = 'End Time';
        block.appendChild(endLabel);
        const endInput = document.createElement('input');
        endInput.type = 'time';
        block.appendChild(endInput);

        dayInputs[d.key] = { start: startInput, end: endInput };
        daysContainer.appendChild(block);
      });
    }

    buildDayBlocks();

    // 1. GM login
    gmLoginBtn.addEventListener('click', async () => {
      loginMessage.textContent = '';
      const emailVal = gmEmailInput.value.trim();
      const passVal = gmPasswordInput.value.trim();
      if (!emailVal || !passVal) {
        loginMessage.textContent = 'Email and Password required.';
        return;
      }
      // Check user with role='gm'
      let { data, error } = await supabase
        .from('users')
        .select('*')
        .eq('email', emailVal)
        .eq('role', 'gm');
      if (error) {
        console.error(error);
        loginMessage.textContent = 'Error checking GM credentials.';
        return;
      }
      if (!data || data.length === 0) {
        loginMessage.textContent = 'Invalid GM credentials or not a GM.';
        return;
      }
      const user = data[0];
      if (user.password_hash !== passVal) {
        loginMessage.textContent = 'Invalid credentials.';
        return;
      }
      // success
      loginSection.classList.add('hidden');
      schedulesSection.classList.remove('hidden');
      loadLocations();
    });

    // 2. Load all locations
    async function loadLocations() {
      locationFilter.innerHTML = '<option value="">-- Select Location --</option>';
      const { data, error } = await supabase
        .from('locations')
        .select('*');
      if (error) {
        console.error(error);
        return;
      }
      data.forEach(loc => {
        const opt = document.createElement('option');
        opt.value = loc.id;
        opt.textContent = loc.location_name;
        locationFilter.appendChild(opt);
      });
    }

    // 3. locationFilter -> load artists
    locationFilter.addEventListener('change', async () => {
      artistFilter.innerHTML = '<option value="">-- Select Artist --</option>';
      clearDayInputs();
      if (!locationFilter.value) return;
      const { data, error } = await supabase
        .from('artists')
        .select('id, artist_name')
        .eq('location_id', locationFilter.value);
      if (error) {
        console.error(error);
        return;
      }
      data.forEach(art => {
        const opt = document.createElement('option');
        opt.value = art.id;
        opt.textContent = art.artist_name;
        artistFilter.appendChild(opt);
      });
    });

    // 4. artistFilter -> load current schedule from the `artists` row
    artistFilter.addEventListener('change', async () => {
      clearDayInputs();
      if (!artistFilter.value) return;
      const { data, error } = await supabase
        .from('artists')
        .select('*')
        .eq('id', artistFilter.value)
        .single();

      if (error) {
        console.error(error);
        scheduleMessage.textContent = 'Error loading artist schedule.';
        return;
      }
      if (!data) {
        scheduleMessage.textContent = 'No artist data found.';
        return;
      }
      // fill each day's inputs
      dayNames.forEach(d => {
        const startCol = d.key + '_start'; // e.g. 'monday_start'
        const endCol   = d.key + '_end';   // e.g. 'monday_end'
        if (data[startCol]) dayInputs[d.key].start.value = data[startCol];
        if (data[endCol])   dayInputs[d.key].end.value   = data[endCol];
      });
    });

    function clearDayInputs() {
      dayNames.forEach(d => {
        dayInputs[d.key].start.value = '';
        dayInputs[d.key].end.value   = '';
      });
      scheduleMessage.textContent = '';
    }

    // 5. Save schedule => update `artists` row
    saveScheduleBtn.addEventListener('click', async () => {
      scheduleMessage.textContent = '';
      if (!artistFilter.value) {
        scheduleMessage.textContent = 'Select an artist first.';
        return;
      }
      // build the update object
      let updateObj = {};
      dayNames.forEach(d => {
        const startCol = d.key + '_start';
        const endCol   = d.key + '_end';
        const stVal = dayInputs[d.key].start.value || null;
        const enVal = dayInputs[d.key].end.value   || null;
        updateObj[startCol] = stVal;
        updateObj[endCol]   = enVal;
      });

      const { data, error } = await supabase
        .from('artists')
        .update(updateObj)
        .eq('id', artistFilter.value);

      if (error) {
        console.error(error);
        scheduleMessage.textContent = 'Error saving schedule.';
        return;
      }
      scheduleMessage.textContent = 'Schedule saved!';
    });
  </script>
</body>
</html>
