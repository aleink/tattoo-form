<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Artists Payroll</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <!--  CSP  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <!-- ─── THEMES (same palette used across admin pages) ─── -->
  <style>
    :root{
      --bg-0:#111;--bg-1:#222;--bg-2:#333;
      --border:#444;--text:#fff;--text-dim:#ccc;
      --accent:#28a745;--info:#1976d2;--danger:#f44336;
    }
    body.light{
      --bg-0:#f7f7f7;--bg-1:#fff;--bg-2:#e4e4e4;
      --border:#bbb;--text:#000;--text-dim:#555;
      --accent:#0d6efd;--info:#0d6efd;--danger:#c62828;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Helvetica Neue',Arial,sans-serif}

    body{background:var(--bg-0);color:var(--text);min-height:100vh;display:flex;flex-direction:column;transition:.25s background}

    header{background:#000;border-bottom:2px solid #444;padding:20px;text-align:center}
    header h1{color:#fff;font-size:1.8rem}

    main{flex:1;max-width:900px;margin:20px auto;padding:10px}

    .card{background:var(--bg-1);border:1px solid var(--border);border-radius:6px;padding:18px;margin-bottom:26px}
    .hidden{display:none}

    label{display:block;font-weight:700;margin:10px 0 4px}
    input,select,button{width:100%;padding:8px;margin-bottom:12px;background:var(--bg-2);color:var(--text);
                         border:1px solid var(--border);border-radius:4px}
    input:focus,select:focus{outline:2px solid var(--accent)}
    button{cursor:pointer;transition:filter .2s}
    button:hover{filter:brightness(1.08)}

    .btn-accent{background:var(--accent);color:#fff}
    .btn-info  {background:var(--info);color:#fff}
    .btn-light {background:var(--bg-2);color:var(--text)}
    .btn-danger{background:var(--danger);color:#fff}

    .message{color:var(--danger);font-size:.9em;margin-top:6px}

    .table-wrap{max-height:320px;overflow-y:auto;border:1px solid var(--border);border-radius:4px}
    table{width:100%;border-collapse:collapse;font-size:.9em}
    th,td{border:1px solid var(--border);padding:8px;text-align:left}
    th{background:var(--bg-2)}

    .top-bar{display:flex;align-items:center;gap:14px;margin-bottom:18px;flex-wrap:wrap}

    /* modal */
    .modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);display:none;
              justify-content:center;align-items:center;z-index:999}
    .modal-bg.active{display:flex}
    .modal-content{background:var(--bg-1);border:1px solid var(--border);border-radius:6px;padding:22px;width:90%;max-width:400px}
    .modal-content h2{margin-bottom:12px;text-align:center}
  </style>
</head>
<body>
  <header><h1>Artists Payroll</h1></header>

  <main>
    <!-- LOGIN MODAL -->
    <div id="login-modal" class="modal-bg">
      <div class="modal-content">
        <h2>GM / AD / HR Login</h2>
        <label>Email</label>
        <input id="login-email" type="email" placeholder="user@company.com">
        <div id="login-msg" class="message"></div>
        <button id="login-btn" class="btn-info">Login</button>
      </div>
    </div>

    <!-- PAYROLL SECTION -->
    <div id="payroll-card" class="card hidden">
      <div class="top-bar">
        <button id="logout-btn" class="btn-danger">Logout</button>
        <button id="theme-btn"  class="btn-light">Light&nbsp;mode</button>
      </div>

      <h2>Generate Payroll</h2>

      <label>Location</label>
      <select id="loc-select"><option value="">-- All Locations --</option></select>

      <label>Start Date</label>
      <input type="date" id="start-date">
      <label>End Date</label>
      <input type="date" id="end-date">

      <button id="gen-btn" class="btn-accent">Generate Payroll</button>
      <div id="pay-msg" class="message"></div>

      <div class="table-wrap" style="margin-top:14px">
        <table>
          <thead><tr><th>Artist</th><th>Total Price</th><th>Total Tip</th><th>Split %</th><th>Earnings</th></tr></thead>
          <tbody id="pay-body"></tbody>
        </table>
      </div>
    </div>

    <!-- NO ACCESS -->
    <div id="no-access" class="card hidden" style="border-color:var(--danger);text-align:center;color:var(--danger)">
      You do not have access to the Payroll page.
    </div>
  </main>

  <!-- SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
/* ---------- Supabase ---------- */
const supabase = window.supabase.createClient(
  'https://shlvjhipxnslrncczopn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
);

/* ---------- Refs ---------- */
const loginModal=document.getElementById('login-modal');
const emailIn   =document.getElementById('login-email');
const loginBtn  =document.getElementById('login-btn');
const loginMsg  =document.getElementById('login-msg');

const payrollCard=document.getElementById('payroll-card');
const noAccess  =document.getElementById('no-access');
const logoutBtn =document.getElementById('logout-btn');
const themeBtn  =document.getElementById('theme-btn');

const locSel=document.getElementById('loc-select');
const sDate=document.getElementById('start-date');
const eDate=document.getElementById('end-date');
const genBtn=document.getElementById('gen-btn');
const payMsg=document.getElementById('pay-msg');
const tbody=document.getElementById('pay-body');

/* ---------- Session ---------- */
let role='';

/* ---------- Theme ---------- */
themeBtn.onclick=()=>{
  const light=document.body.classList.toggle('light');
  themeBtn.textContent=light?'Dark mode':'Light mode';
};

/* ---------- Login Flow ---------- */
const ALLOWED=['gm','ad','hr'];

function showLogin(){loginModal.classList.add('active');}
function hideLogin(){loginModal.classList.remove('active');}

async function init(){
  role=localStorage.getItem('currentUserRole')||'';
  if(ALLOWED.includes(role)){
    payrollCard.classList.remove('hidden');
    await loadLocations();
  }else{
    showLogin();
  }
}
init();

loginBtn.onclick=async()=>{
  loginMsg.textContent='';
  const email=emailIn.value.trim();
  if(!email){loginMsg.textContent='Email required.';return;}
  const {data,error}=await supabase.from('users').select('role').eq('email',email).in('role',ALLOWED);
  if(error||!data.length){loginMsg.textContent='Access denied.';return;}
  role=data[0].role;
  localStorage.setItem('currentUserRole',role);
  hideLogin();
  payrollCard.classList.remove('hidden');
  await loadLocations();
};

logoutBtn.onclick=()=>{
  localStorage.removeItem('currentUserRole');
  role='';
  payrollCard.classList.add('hidden');
  tbody.innerHTML=''; payMsg.textContent='';
  showLogin();
};

/* ---------- Locations ---------- */
async function loadLocations(){
  locSel.innerHTML='<option value="">-- All Locations --</option>';
  const {data}=await supabase.from('locations').select('*');
  data.forEach(l=>{
    const o=document.createElement('option');o.value=l.id;o.textContent=l.location_name;locSel.appendChild(o);
  });
}

/* ---------- Generate Payroll ---------- */
genBtn.onclick=async()=>{
  payMsg.textContent=''; tbody.innerHTML='';
  if(!sDate.value||!eDate.value){payMsg.textContent='Start & End dates required.';return;}
  if(eDate.value<sDate.value){payMsg.textContent='End date can’t be before start.';return;}

  let q=supabase.from('artist_appointments')
        .select('price,tip,artist_id, artists!inner(artist_name,percentage_split,location_id)')
        .gte('date',sDate.value).lte('date',eDate.value)
        .in('appointment_type',['completed','walk-in']);

  if(locSel.value) q=q.eq('artists.location_id',locSel.value);

  const {data,error}=await q;
  if(error){console.error(error);payMsg.textContent='Error fetching.';return;}
  if(!data.length){payMsg.textContent='No appointments in range.';return;}

  const summary={};
  data.forEach(a=>{
    const id=a.artist_id;
    if(!summary[id]){
      summary[id]={name:a.artists.artist_name,split:a.artists.percentage_split||0,price:0,tip:0};
    }
    summary[id].price+=a.price||0;
    summary[id].tip  +=a.tip  ||0;
  });

  Object.values(summary).forEach(r=>{
    const earn=(r.price*(r.split/100))+r.tip;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.name}</td>
      <td>${r.price.toFixed(2)}</td>
      <td>${r.tip.toFixed(2)}</td>
      <td>${r.split}%</td>
      <td>${earn.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
};
  </script>
</body>
</html>
