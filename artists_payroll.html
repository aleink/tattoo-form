<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Artists Payroll</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
        connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
        style-src 'self' 'unsafe-inline';
        object-src 'none';
      ">

<!-- ─── VISUAL THEME ─── -->
<style>
:root{
  --bg0:#111;--bg1:#222;--bg2:#333;
  --border:#444;--txt:#fff;--txt-dim:#ccc;
  --accent:#28a745;--info:#1976d2;--danger:#f44336;
}
body.light{
  --bg0:#f7f7f7;--bg1:#fff;--bg2:#e6e6e6;
  --border:#b7b7b7;--txt:#000;--txt-dim:#444;
  --accent:#0d6efd;--info:#0d6efd;--danger:#c62828;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Helvetica Neue',Arial,sans-serif}
body{background:var(--bg0);color:var(--txt);max-width:900px;margin:32px auto;padding:28px;transition:background .25s,color .25s}
h1{text-align:center;font-size:1.8rem;margin-bottom:24px}
h2{margin:10px 0 14px;font-size:1.25rem}

.card{background:var(--bg1);border:1px solid var(--border);border-radius:6px;padding:22px;margin-bottom:30px}
.hidden{display:none}

/* top bar */
.top-bar{display:flex;align-items:center;gap:12px;margin-bottom:22px;flex-wrap:wrap}
.btn-grey{
  background:var(--bg2);color:var(--txt);border:none;border-radius:4px;
  padding:6px 14px;cursor:pointer;transition:background .2s
}
.btn-grey:hover{background:#555}

label{display:block;font-weight:700;margin:10px 0 4px}
input,select{
  width:100%;padding:8px;background:var(--bg2);color:var(--txt);
  border:1px solid var(--border);border-radius:4px;margin-bottom:12px
}
input:focus,select:focus{outline:2px solid var(--accent)}

button{cursor:pointer;transition:filter .2s}
button:hover{filter:brightness(1.08)}
.btn-accent{background:var(--accent);color:#fff}
.message{color:var(--danger);font-size:.9em;margin-top:4px}

/* table */
.table-wrap{max-height:340px;overflow:auto;border:1px solid var(--border);border-radius:4px}
table{width:100%;border-collapse:collapse;font-size:.9em}
th,td{border:1px solid var(--border);padding:8px;text-align:left}
th{background:var(--bg2)}
</style>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>

<!-- ─── ACCESS-CHECK (runs *before* UI renders) ─── -->
<script type="module">
  /* ------- shared supabase client ------- */
  const supabase = window.supabase.createClient(
    'https://shlvjhipxnslrncczopn.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
  );

  const PAGE_SLUG = 'payroll';              // ← row in page_roles
  const FALLBACK_ALLOWED = ['gm','owner','ad','hr']; // used if the query fails
  const role = localStorage.getItem('currentUserRole');

  /* no session → bounce immediately */
  if(!role){
    location.href='index.html';
  }else{
    /* check page_roles */
    let allowed = false;
    try{
      const {data,error} = await supabase
        .from('page_roles')
        .select('*')
        .eq('page_slug', PAGE_SLUG)
        .single();
      if(!error && data && data[role]===true) allowed = true;
    }catch(e){ /* network / table error – ignore */ }

    /* fallback static check */
    if(!allowed && FALLBACK_ALLOWED.includes(role)) allowed = true;

    if(!allowed){
      location.href='index.html';
    }
  }
</script>
</head>

<body>

<h1>Artists Payroll</h1>

<!-- ── MAIN UI (shown only if role is authorised) ── -->
<div id="payroll-card" class="card hidden">
  <div class="top-bar">
    <button id="back-btn"   class="btn-grey">← Back</button>
    <button id="theme-btn"  class="btn-grey">Light&nbsp;mode</button>
    <button id="logout-btn" class="btn-grey">Logout</button>
  </div>

  <h2>Generate Payroll</h2>

  <label>Location</label>
  <select id="loc-select"><option value="">-- All Locations --</option></select>

  <label>Start Date</label><input id="start-date" type="date">
  <label>End Date</label><input  id="end-date"   type="date">

  <button id="gen-btn" class="btn-accent">Generate Payroll</button>
  <div id="pay-msg" class="message"></div>

  <div class="table-wrap" style="margin-top:14px">
    <table>
      <thead><tr>
        <th>Artist</th><th>Total Price</th><th>Total Tip</th><th>Split %</th><th>Earnings</th>
      </tr></thead>
      <tbody id="pay-body"></tbody>
    </table>
  </div>
</div>

<script>
/* ---------- Supabase (same client as module) ---------- */
const supabase = window.supabase.createClient(
  'https://shlvjhipxnslrncczopn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
);

/* ---------- DOM ---------- */
const payCard = document.getElementById('payroll-card');
const backBtn = document.getElementById('back-btn');
const themeBtn= document.getElementById('theme-btn');
const logoutBtn=document.getElementById('logout-btn');

const locSel = document.getElementById('loc-select');
const sDate  = document.getElementById('start-date');
const eDate  = document.getElementById('end-date');
const genBtn = document.getElementById('gen-btn');
const payMsg = document.getElementById('pay-msg');
const tbody  = document.getElementById('pay-body');

/* ---------- SESSION ---------- */
const role     = localStorage.getItem('currentUserRole') || '';
const scopeLoc = localStorage.getItem('currentUserLoc')  || '';

/* ---------- NAV ---------- */
backBtn.onclick   = ()=>location.href='index.html';
logoutBtn.onclick = ()=>{localStorage.clear();location.href='index.html';};

/* ---------- THEME ---------- */
(()=>{if(localStorage.getItem('ui-theme')==='light'){document.body.classList.add('light');themeBtn.textContent='Dark mode';}})();
themeBtn.onclick=()=>{
  const l=document.body.classList.toggle('light');
  themeBtn.textContent=l?'Dark mode':'Light mode';
  localStorage.setItem('ui-theme',l?'light':'dark');
};

/* ---------- INIT ---------- */
init();
async function init(){
  payCard.classList.remove('hidden');
  await loadLocations();
}

/* ---------- LOCATIONS DROPDOWN ---------- */
async function loadLocations(){
  locSel.innerHTML='<option value="">-- All Locations --</option>';
  const {data}=await supabase.from('locations').select('*').order('location_name',{ascending:true});
  data?.forEach(l=>{
    const opt=document.createElement('option');opt.value=l.id;opt.textContent=l.location_name;
    locSel.appendChild(opt);
  });
}

/* ---------- GENERATE PAYROLL ---------- */
genBtn.onclick=async()=>{
  payMsg.textContent='';tbody.innerHTML='';
  if(!sDate.value||!eDate.value){payMsg.textContent='Start & End dates required.';return;}
  if(eDate.value < sDate.value){payMsg.textContent='End date can’t be before Start date.';return;}

  let q=supabase.from('artist_appointments')
        .select('price,tip,artist_id,appointment_type, artists!inner(artist_name,percentage_split,location_id)')
        .gte('date',sDate.value).lte('date',eDate.value)
        .in('appointment_type',['walk-in','completed']);

  /* location scoping */
  if(locSel.value)          q=q.eq('artists.location_id',locSel.value);
  else if(role!=='gm'&&role!=='owner'&&scopeLoc) q=q.eq('artists.location_id',scopeLoc);

  const {data,error}=await q;
  if(error){console.error(error);payMsg.textContent='Error fetching appointments.';return;}
  if(!data?.length){payMsg.textContent='No qualifying appointments.';return;}

  const sum={};
  data.forEach(ap=>{
    if(!sum[ap.artist_id]){
      sum[ap.artist_id]={name:ap.artists.artist_name,split:ap.artists.percentage_split||0,price:0,tip:0};
    }
    sum[ap.artist_id].price += ap.price||0;
    sum[ap.artist_id].tip   += ap.tip  ||0;
  });

  Object.values(sum).forEach(r=>{
    const earnings=(r.price*(r.split/100))+r.tip;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.name}</td>
      <td>${r.price.toFixed(2)}</td>
      <td>${r.tip.toFixed(2)}</td>
      <td>${r.split}%</td>
      <td>${earnings.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
};
</script>
</body>
</html>
