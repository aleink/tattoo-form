<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Artists Payroll</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <!-- ✦ same dark / light palette used everywhere else ✦ -->
  <style>
    :root{
      --bg0:#111; --bg1:#222; --bg2:#333;
      --border:#444; --txt:#fff; --txt-dim:#ccc;
      --accent:#28a745; --info:#1976d2; --danger:#f44336;
    }
    body.light{
      --bg0:#f7f7f7; --bg1:#fff; --bg2:#e4e4e4;
      --border:#bbb; --txt:#000; --txt-dim:#555;
      --accent:#0d6efd; --info:#0d6efd; --danger:#c62828;
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:'Helvetica Neue',Arial,sans-serif}
    body{background:var(--bg0);color:var(--txt);max-width:900px;margin:32px auto;padding:28px;transition:.25s background}

    h1{text-align:center;margin-bottom:24px;font-size:1.8rem}
    h2{margin:10px 0 14px}

    label{display:block;font-weight:700;margin:10px 0 4px}
    input,select{
      width:100%;padding:8px;background:var(--bg2);color:var(--txt);
      border:1px solid var(--border);border-radius:4px;margin-bottom:12px
    }
    input:focus,select:focus{outline:2px solid var(--accent)}

    button{
      padding:8px 16px;border:none;border-radius:4px;
      background:var(--bg2);color:var(--txt);cursor:pointer;
      transition:filter .2s
    }
    button:hover{filter:brightness(1.1)}
    .btn-green {background:var(--accent);color:#fff}
    .btn-grey  {background:var(--bg2);color:var(--txt)}
    .card{background:var(--bg1);border:1px solid var(--border);border-radius:6px;padding:22px;margin-bottom:30px}
    .hidden{display:none}
    .message{color:var(--danger);font-size:.9em;margin-top:6px}

    .top-bar{display:flex;align-items:center;gap:14px;margin-bottom:18px;flex-wrap:wrap}
    .table-wrap{max-height:340px;overflow-y:auto;border:1px solid var(--border);border-radius:4px}
    table{width:100%;border-collapse:collapse;font-size:.9em}
    th,td{border:1px solid var(--border);padding:8px;text-align:left}
    th{background:var(--bg2)}
  </style>
</head>
<body>

<h1>Artists Payroll</h1>

<!-- ── MAIN UI (shown only if role is authorised) ── -->
<div id="payroll-card" class="card hidden">
  <div class="top-bar">
    <button id="back-btn"   class="btn-grey">← Back</button>
    <button id="theme-btn"  class="btn-grey">Light mode</button>
    <button id="logout-btn" class="btn-grey">Logout</button>
  </div>

  <h2>Generate Payroll</h2>

  <label>Location</label>
  <select id="loc-select"><option value="">-- All Locations --</option></select>

  <label>Start Date</label><input id="start-date" type="date">
  <label>End Date</label><input id="end-date"   type="date">

  <button id="gen-btn" class="btn-green">Generate Payroll</button>
  <div id="pay-msg" class="message"></div>

  <div class="table-wrap" style="margin-top:14px">
    <table>
      <thead><tr><th>Artist</th><th>Total Price</th><th>Total Tip</th><th>Split %</th><th>Earnings</th></tr></thead>
      <tbody id="pay-body"></tbody>
    </table>
  </div>
</div>

<!-- ── NO-ACCESS notice ── -->
<div id="no-access" class="card hidden" style="border-color:var(--danger);text-align:center;color:var(--danger)">
  You do not have access to the Payroll page.
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
<script>
/* ---------- Supabase ---------- */
const supabase = window.supabase.createClient(
  'https://shlvjhipxnslrncczopn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
);

/* ---------- DOM ---------- */
const payrollCard = document.getElementById('payroll-card');
const noAccess    = document.getElementById('no-access');
const locSelect   = document.getElementById('loc-select');
const sDate       = document.getElementById('start-date');
const eDate       = document.getElementById('end-date');
const genBtn      = document.getElementById('gen-btn');
const payMsg      = document.getElementById('pay-msg');
const tbody       = document.getElementById('pay-body');
const themeBtn    = document.getElementById('theme-btn');
const logoutBtn   = document.getElementById('logout-btn');
const backBtn     = document.getElementById('back-btn');

/* ---------- Roles ---------- */
const allowedRoles = ['gm','owner','hr','ad'];   // payroll only

/* ---------- Auth inherited from index ---------- */
const role = localStorage.getItem('currentUserRole');
if (!allowedRoles.includes(role)) {
  // not authorised → kick back to index
  window.location.href = 'index.html';
}

/* ---------- UI set-up ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  // theme
  if (localStorage.getItem('ui-theme') === 'light') {
    document.body.classList.add('light');
    themeBtn.textContent = 'Dark mode';
  }

  // show the correct section
  payrollCard.classList.remove('hidden');

  await loadLocations();
});

/* ---------- Theme toggle ---------- */
themeBtn.onclick = () => {
  const light = document.body.classList.toggle('light');
  themeBtn.textContent = light ? 'Dark mode' : 'Light mode';
  localStorage.setItem('ui-theme', light ? 'light' : 'dark');
};

/* ---------- Back & Logout ---------- */
backBtn.onclick   = () => window.location.href = 'index.html';
logoutBtn.onclick = () => { localStorage.clear(); window.location.href = 'index.html'; };

/* ---------- Load locations ---------- */
async function loadLocations(){
  locSelect.innerHTML = '<option value="">-- All Locations --</option>';
  const { data } = await supabase.from('locations').select('*');
  data?.forEach(l => {
    const o = document.createElement('option');
    o.value = l.id; o.textContent = l.location_name;
    locSelect.appendChild(o);
  });
}

/* ---------- Generate payroll ---------- */
genBtn.onclick = async () => {
  payMsg.textContent = ''; tbody.innerHTML = '';

  if (!sDate.value || !eDate.value) {
    payMsg.textContent = 'Start & End dates are required.'; return;
  }
  if (eDate.value < sDate.value) {
    payMsg.textContent = 'End date cannot be before Start date.'; return;
  }

  /* completed appointments + all walk-ins */
  let q = supabase.from('artist_appointments')
      .select('price,tip,artist_id,appointment_type, artists!inner(artist_name,percentage_split,location_id)')
      .gte('date', sDate.value).lte('date', eDate.value)
      .in('appointment_type', ['walk-in','completed']);

  if (locSelect.value) q = q.eq('artists.location_id', locSelect.value);

  const { data, error } = await q;
  if (error) { payMsg.textContent = 'Fetch error.'; console.error(error); return; }
  if (!data.length) { payMsg.textContent = 'No qualifying appointments found.'; return; }

  const bucket = {};
  data.forEach(ap => {
    if (!bucket[ap.artist_id]) {
      bucket[ap.artist_id] = {
        name:  ap.artists.artist_name,
        split: ap.artists.percentage_split || 0,
        price: 0,
        tip:   0
      };
    }
    bucket[ap.artist_id].price += ap.price || 0;
    bucket[ap.artist_id].tip   += ap.tip   || 0;
  });

  Object.values(bucket).forEach(r => {
    const earnings = (r.price * r.split / 100) + r.tip;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.name}</td>
      <td>${r.price.toFixed(2)}</td>
      <td>${r.tip.toFixed(2)}</td>
      <td>${r.split}%</td>
      <td>${earnings.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
};
</script>
</body>
</html>
