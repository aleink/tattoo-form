<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    /* -------- dark PC layout (unchanged styles) -------- */
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Helvetica Neue',Arial,sans-serif;background:#111;color:#fff;max-width:1200px;margin:20px auto;padding:10px;}
    header{background:#000;border-bottom:2px solid #444;padding:20px;text-align:center;}
    header h1{margin:0;font-size:1.8rem;color:#fff;}
    .top-controls{display:flex;align-items:center;gap:20px;margin:15px 0;}
    #logout-btn{background:#f44336;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;}
    select,input[type="date"],input[type="time"],input[type="text"],input[type="number"],input[type="email"],textarea{background:#222;color:#fff;border:1px solid #444;border-radius:4px;padding:6px;}
    select option{color:#000;}

    /* daily scheduler */
    #daily-scheduler{position:relative;height:960px;border:1px solid #444;overflow-y:auto;margin-top:10px;background:#222;}
    .hour-line{position:absolute;left:0;width:100%;border-top:1px dashed #444;color:#bbb;font-size:12px;padding-left:5px;}
    .schedule-block{position:absolute;background:rgba(255,255,255,.05);color:#ddd;padding:2px;font-size:.75em;box-sizing:border-box;border-left:4px solid #555;pointer-events:none;}
    .schedule-artist-name{display:block;margin-bottom:2px;font-weight:bold;color:#fff;}
    .appointment-block{position:absolute;background:#444;color:#fff;border-radius:4px;padding:2px 4px;font-size:.85em;box-sizing:border-box;cursor:pointer;}

    /* modal */
    #appt-modal{display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#222;border:1px solid #444;padding:20px;width:320px;box-shadow:0 2px 10px rgba(0,0,0,.2);color:#fff;z-index:999;}
    #appt-modal input,#appt-modal select,#appt-modal textarea{width:100%;background:#333;border:1px solid #555;color:#fff;border-radius:4px;padding:6px;}
    .modal-field{margin-bottom:10px;}
    .modal-buttons{text-align:right;margin-top:10px;}
    .modal-buttons button{margin-left:8px;background:#333;color:#fff;border:1px solid #555;padding:6px 10px;border-radius:4px;cursor:pointer;}
    .modal-buttons button:hover{background:#555;}

    /* artist filter */
    #artist-filter-container{margin-top:10px;}
    .artist-filter-item{display:inline-block;margin-right:10px;}
    .artist-filter-item label{margin-left:4px;}

    /* appointments list */
    #appointments-list-section{margin-top:20px;background:#222;border:1px solid #444;border-radius:6px;padding:15px;}
    #appointments-list-section h2{margin-bottom:10px;}
    .filters-row{display:flex;align-items:center;gap:15px;margin-bottom:10px;flex-wrap:wrap;}
    .appointments-container{max-height:300px;overflow-y:auto;border:1px solid #444;padding:10px;}
    .appt-item{background:#333;border:1px solid #555;padding:8px;border-radius:4px;margin-bottom:8px;cursor:pointer;}
    .appt-item h4{margin-bottom:3px;font-size:1rem;color:#fff;}
    .appt-item p{margin-bottom:2px;font-size:.85rem;color:#bbb;}
  </style>
</head>
<body>
  <header><h1>Calendar</h1></header>

  <div class="top-controls">
    <button id="logout-btn">Logout</button>
    <label for="location-filter">Location:</label>
    <select id="location-filter"><option value="">-- Select Location --</option></select>
    <label for="day-input">Date:</label>
    <input type="date" id="day-input">
  </div>

  <div id="artist-filter-container"></div>
  <div id="daily-scheduler"></div>

  <!-- ---------- APPOINTMENT MODAL ---------- -->
  <div id="appt-modal">
    <h3 id="modal-title">New Appointment</h3>
    <div class="modal-field"><label>Start Time (5-min):</label><input type="time" id="modal-start-time" step="300"></div>
    <div class="modal-field"><label>End Time (5-min):</label><input type="time" id="modal-end-time" step="300"></div>
    <div class="modal-field"><label>Artist:</label><select id="modal-artist"></select></div>
    <div class="modal-field"><label>Client Name:</label><input type="text" id="modal-client-name"></div>
    <div class="modal-field"><label>Client Phone:</label><input type="text" id="modal-client-phone"></div>
    <div class="modal-field"><label>Client Email:</label><input type="email" id="modal-email"></div>
    <div class="modal-field"><label>Tattoo Description:</label><textarea id="modal-description"></textarea></div>
    <div class="modal-field"><label>Deposit:</label><input type="number" id="modal-deposit"></div>
    <div class="modal-field"><label>Price:</label><input type="number" id="modal-price"></div>
    <div class="modal-field"><label>Tip:</label><input type="number" id="modal-tip"></div>
    <div class="modal-field"><label>Appointment Type:</label>
      <select id="modal-appt-type"><option value="walk-in">Walk-in</option><option value="appointment">Appointment</option></select>
    </div>
    <div class="modal-buttons">
      <button id="save-appt-btn">Save</button>
      <button id="cancel-appt-btn">Cancel</button>
      <button id="delete-appt-btn" style="display:none;">Delete</button>
      <button id="complete-appt-btn" style="display:none;">Mark Completed</button>
    </div>
  </div>

  <!-- ---------- BOTTOM LIST ---------- -->
  <div id="appointments-list-section">
    <h2>Appointments &amp; Walk-ins</h2>
    <div class="filters-row">
      <label>From: <input type="date" id="range-start"></label>
      <label>To:   <input type="date" id="range-end"></label>
      <label>Client search: <input type="text" id="client-search" placeholder="name / phone / email"></label>
      <div>
        <label><input type="checkbox" id="cb-appointments" checked> Appointments</label>
        <label><input type="checkbox" id="cb-walkins" checked> Walk-ins</label>
      </div>
    </div>
    <div class="appointments-container" id="appointments-list"></div>
  </div>

  <!-- ---------- SUPABASE ---------- -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    /* -------- CONFIG -------- */
    const supabase = window.supabase.createClient(
      'https://shlvjhipxnslrncczopn.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
    );

    /* -------- HELPERS -------- */
    const toMinutes=t=>{if(!t)return 0;const[h,m]=t.split(':').map(Number);return h*60+m;};
    const overlaps=(a,b)=>a&&b&&(toMinutes(a.start_time)<toMinutes(b.end_time)&&toMinutes(b.start_time)<toMinutes(a.end_time));
    const weekdayIndex=d=>{const[y,m,dd]=d.split('-').map(Number);return new Date(Date.UTC(y,m-1,dd)).getUTCDay();};

    /* -------- DOM refs -------- */
    const logoutBtn=document.getElementById('logout-btn');
    const locationFilter=document.getElementById('location-filter');
    const dayInput=document.getElementById('day-input');
    const dailyScheduler=document.getElementById('daily-scheduler');
    const artistFilterContainer=document.getElementById('artist-filter-container');
    const modalArtist=document.getElementById('modal-artist');

    const apptModal=document.getElementById('appt-modal');
    const modalTitle=document.getElementById('modal-title');
    const modalStart=document.getElementById('modal-start-time');
    const modalEnd=document.getElementById('modal-end-time');
    const modalClientName=document.getElementById('modal-client-name');
    const modalClientPhone=document.getElementById('modal-client-phone');
    const modalEmail=document.getElementById('modal-email');
    const modalDesc=document.getElementById('modal-description');
    const modalDeposit=document.getElementById('modal-deposit');
    const modalPrice=document.getElementById('modal-price');
    const modalTip=document.getElementById('modal-tip');
    const modalType=document.getElementById('modal-appt-type');
    const saveBtn=document.getElementById('save-appt-btn');
    const cancelBtn=document.getElementById('cancel-appt-btn');
    const deleteBtn=document.getElementById('delete-appt-btn');
    const completeBtn=document.getElementById('complete-appt-btn');

    const rangeStart=document.getElementById('range-start');
    const rangeEnd=document.getElementById('range-end');
    const cbAppt=document.getElementById('cb-appointments');
    const cbWalk=document.getElementById('cb-walkins');
    const appointmentsList=document.getElementById('appointments-list');
    const clientSearch=document.getElementById('client-search');

    /* -------- STATE -------- */
    let artistMap={}, currentApptId=null;

    /* -------- AUTH -------- */
    if(!localStorage.getItem('currentUserId')) location.href='login.html';
    logoutBtn.onclick=()=>{localStorage.clear();location.href='login.html';};

    /* -------- INIT -------- */
    document.addEventListener('DOMContentLoaded',async()=>{
      await loadLocations();
      dayInput.value=new Date().toISOString().split('T')[0];
      await loadArtistsForLocation(locationFilter.value);
      setDefaultRange();
      loadDay();
      loadAppointmentsList();
    });

    /* -------- EVENT WIRING -------- */
    dayInput.onchange=loadDay;
    locationFilter.onchange=async()=>{await loadArtistsForLocation(locationFilter.value);loadDay();loadAppointmentsList();};
    artistFilterContainer.addEventListener('change',()=>{loadDay();loadAppointmentsList();});
    [rangeStart,rangeEnd,cbAppt,cbWalk].forEach(el=>el.addEventListener('change',loadAppointmentsList));
    clientSearch.addEventListener('input',loadAppointmentsList);

    /* -------- LOAD LOCATIONS -------- */
    async function loadLocations(){
      const {data}=await supabase.from('locations').select('*');
      locationFilter.innerHTML='<option value="">-- Select Location --</option>';
      data?.forEach(l=>{
        const o=document.createElement('option');o.value=l.id;o.textContent=l.location_name;
        locationFilter.appendChild(o);
      });
    }

    /* -------- LOAD ARTISTS -------- */
    async function loadArtistsForLocation(locId){
      artistMap={};modalArtist.innerHTML='';artistFilterContainer.innerHTML='';
      if(!locId) return;
      const {data}=await supabase.from('artists').select('*').eq('location_id',locId);
      data?.sort((a,b)=>a.artist_name.localeCompare(b.artist_name)).forEach(a=>{
        artistMap[a.id]=a;
        const opt=document.createElement('option');opt.value=a.id;opt.textContent=a.artist_name;modalArtist.appendChild(opt);
        const wrap=document.createElement('div');wrap.className='artist-filter-item';
        const cb=document.createElement('input');cb.type='checkbox';cb.value=a.id;cb.checked=true;
        const lb=document.createElement('label');lb.textContent=a.artist_name;wrap.append(cb,lb);
        artistFilterContainer.appendChild(wrap);
      });
    }
    const filteredIds=()=>[...artistFilterContainer.querySelectorAll('input[type=checkbox]')].filter(cb=>cb.checked).map(cb=>cb.value);

    /* -------- DAILY VIEW -------- */
    async function loadDay(){
      dailyScheduler.innerHTML='';
      const date=dayInput.value;if(!date) return;
      for(let h=8;h<=24;h++){
        const div=document.createElement('div');div.className='hour-line';div.style.top=(h-8)*60+'px';
        const hr=((h+11)%12)+1;div.textContent=`${hr}:00 ${h<12?'AM':'PM'}`;dailyScheduler.appendChild(div);
      }
      const ids=filteredIds();if(!ids.length) return;

      const wIdx=weekdayIndex(date);
      const cols=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
      const cStart=cols[wIdx]+'_start', cEnd=cols[wIdx]+'_end';

      /* vacation set */
      const {data:vac}=await supabase.from('artist_vacations')
        .select('artist_id').in('artist_id',ids)
        .lte('vacation_start',date).gte('vacation_end',date);
      const vacationSet=new Set(vac?.map(v=>v.artist_id)||[]);

      const artists=ids.map(id=>artistMap[id]).filter(Boolean).sort((a,b)=>a.artist_name.localeCompare(b.artist_name));

      /* schedule blocks */
      artists.forEach((a,i)=>{
        const st=a[cStart],en=a[cEnd];if(!st||!en) return;
        const block=document.createElement('div');block.className='schedule-block';
        const top=toMinutes(st)-480, ht=toMinutes(en)-toMinutes(st);
        block.style.cssText=`left:${80+i*120}px;width:110px;top:${top}px;height:${ht}px;`;
        const vac=vacationSet.has(a.id);
        block.style.borderLeftColor=vac?'#888':(a.color||'#999');
        if(vac){block.style.background='rgba(128,128,128,.4)';}
        block.innerHTML=`<span class="schedule-artist-name">${a.artist_name}${vac?' (vacation)':''}</span>${st}-${en}`;
        dailyScheduler.appendChild(block);
      });

      /* appointments */
      const {data:appts}=await supabase.from('artist_appointments').select('*').eq('date',date).in('artist_id',ids);
      const byA={};artists.forEach(a=>byA[a.id]=[]);
      appts?.forEach(ap=>byA[ap.artist_id]?.push(ap));

      artists.forEach((a,col)=>{
        const list=byA[a.id].sort((x,y)=>toMinutes(x.start_time)-toMinutes(y.start_time));
        const subs=[];list.forEach(ap=>{
          let placed=false;
          for(const s of subs){if(!overlaps(s[s.length-1],ap)){s.push(ap);placed=true;break;}}
          if(!placed) subs.push([ap]);
        });
        subs.forEach((sub,subIdx)=>{
          sub.forEach(ap=>{
            const t0=toMinutes(ap.start_time)-480, ht=toMinutes(ap.end_time)-toMinutes(ap.start_time);
            const w=110/subs.length, left=80+col*120+subIdx*w;
            const div=document.createElement('div');div.className='appointment-block';
            div.style.cssText=`left:${left}px;top:${t0}px;width:${w-2}px;height:${ht}px;background:${a.color||'#444'}`;
            div.textContent=`${a.artist_name} – ${ap.client_name||'N/A'} (${ap.appointment_type})`;
            div.onclick=e=>{e.stopPropagation();openExistingApptModal(ap.id);};
            dailyScheduler.appendChild(div);
          });
        });
      });

      dailyScheduler.onclick=e=>{
        if(['appointment-block','schedule-block','hour-line'].some(c=>e.target.classList.contains(c))) return;
        const y=e.clientY-dailyScheduler.getBoundingClientRect().top;
        const mins=Math.floor(y), h=Math.floor(mins/60)+8, m=String(mins%60).padStart(2,'0');
        openNewApptModal(`${String(h).padStart(2,'0')}:${m}`,date);
      };
    }

    /* -------- MODAL CRUD -------- */
    function openNewApptModal(slot,date){
      currentApptId=null;modalTitle.textContent='New Appointment';
      modalStart.value=slot;modalEnd.value=slot;modalArtist.value='';
      modalClientName.value=modalClientPhone.value=modalEmail.value=modalDesc.value='';
      modalDeposit.value=modalPrice.value=modalTip.value='';modalType.value='walk-in';
      deleteBtn.style.display=completeBtn.style.display='none';apptModal.style.display='block';
    }
    async function openExistingApptModal(id){
      currentApptId=id;
      const {data,error}=await supabase.from('artist_appointments').select('*').eq('id',id);
      if(error||!data||!data.length){alert('Error loading');return;}
      const ap=data[0];
      modalTitle.textContent='Edit Appointment';
      modalStart.value=ap.start_time;modalEnd.value=ap.end_time;modalArtist.value=ap.artist_id;
      modalClientName.value=ap.client_name||'';modalClientPhone.value=ap.client_phone||'';
      modalEmail.value=ap.email||'';modalDesc.value=ap.notes||'';modalDeposit.value=ap.deposit||'';
      modalPrice.value=ap.price||'';modalTip.value=ap.tip||'';modalType.value=ap.appointment_type;
      deleteBtn.style.display=completeBtn.style.display='inline-block';apptModal.style.display='block';
    }
    cancelBtn.onclick=()=>apptModal.style.display='none';

    saveBtn.onclick=async()=>{
      const day=dayInput.value;if(!day){alert('Select date first');return;}
      if(!modalStart.value||!modalEnd.value){alert('Start/End required');return;}
      const {data:conflict}=await supabase.from('artist_appointments').select('*')
                               .eq('date',day).eq('artist_id',modalArtist.value);
      if(conflict&&isOverlap(conflict,modalStart.value,modalEnd.value,currentApptId)){alert('Overlap');return;}

      const payload={
        artist_id:modalArtist.value,date:day,start_time:modalStart.value,end_time:modalEnd.value,
        appointment_type:modalType.value,client_name:modalClientName.value,client_phone:modalClientPhone.value,
        email:modalEmail.value,notes:modalDesc.value,deposit:modalDeposit.value?parseFloat(modalDeposit.value):null,
        price:modalPrice.value?parseFloat(modalPrice.value):null,tip:modalTip.value?parseFloat(modalTip.value):null
      };
      let err;
      if(currentApptId){
        ({error:err}=await supabase.from('artist_appointments').update(payload).eq('id',currentApptId));
      }else{
        ({error:err}=await supabase.from('artist_appointments').insert([payload]));
      }
      if(err){console.error(err);alert('Error saving');return;}
      apptModal.style.display='none';loadDay();loadAppointmentsList();
    };
    function isOverlap(list,s,e,skip){
      const sN=toMinutes(s), eN=toMinutes(e);
      return list.some(ap=>ap.id!==skip&&sN<toMinutes(ap.end_time)&&toMinutes(ap.start_time)<eN);
    }
    deleteBtn.onclick=async()=>{
      if(!currentApptId||!confirm('Delete this appointment?'))return;
      const {error}=await supabase.from('artist_appointments').delete().eq('id',currentApptId);
      if(error){console.error(error);alert('Error deleting');return;}
      apptModal.style.display='none';loadDay();loadAppointmentsList();
    };
    completeBtn.onclick=async()=>{
      if(!currentApptId)return;
      const {error}=await supabase.from('artist_appointments').update({appointment_type:'completed'}).eq('id',currentApptId);
      if(error){console.error(error);alert('Error');return;}
      apptModal.style.display='none';loadDay();loadAppointmentsList();
    };

    /* -------- APPOINTMENTS LIST -------- */
    function setDefaultRange(){
      const now=new Date();
      rangeStart.value=new Date(now-7*86400000).toISOString().split('T')[0];
      rangeEnd.value  =new Date(now.getTime()+7*86400000).toISOString().split('T')[0];
    }
    async function loadAppointmentsList(){
      appointmentsList.innerHTML='';
      const ids=filteredIds();if(!ids.length){appointmentsList.textContent='No artists selected.';return;}
      if(!rangeStart.value||!rangeEnd.value){appointmentsList.textContent='Select a date range.';return;}
      const types=[];
      if(cbAppt.checked) types.push('appointment');
      if(cbWalk.checked) types.push('walk-in');
      if(!types.length){appointmentsList.textContent='No types selected.';return;}

      let q=supabase.from('artist_appointments')
        .select('*, artists!inner(location_id,artist_name)')
        .gte('date',rangeStart.value).lte('date',rangeEnd.value)
        .in('appointment_type',types).in('artist_id',ids);
      if(locationFilter.value) q=q.eq('artists.location_id',locationFilter.value);

      const term=clientSearch.value.trim();
      if(term){
        q=q.or(`client_name.ilike.*${term}*,client_phone.ilike.*${term}*,email.ilike.*${term}*`);
      }

      const {data,error}=await q;
      if(error){console.error(error);appointmentsList.textContent='Error.';return;}
      if(!data||!data.length){appointmentsList.textContent='No matching records.';return;}

      data.sort((a,b)=>a.date===b.date?toMinutes(a.start_time)-toMinutes(b.start_time):(a.date<b.date?-1:1));
      data.forEach(ap=>{
        const div=document.createElement('div');div.className='appt-item';
        div.innerHTML=`<h4>${ap.date} ${ap.start_time}-${ap.end_time} [${ap.appointment_type}]</h4>
          <p>Artist: ${ap.artists?.artist_name||ap.artist_id}</p>
          <p>Client: ${ap.client_name||'N/A'}</p>
          <p>Price: ${ap.price||0}, Tip: ${ap.tip||0}</p>`;
        div.onclick=()=>{dayInput.value=ap.date;loadDay();};
        appointmentsList.appendChild(div);
      });
    }
  </script>
</body>
</html>
