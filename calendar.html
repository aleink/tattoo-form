<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 
    CSP allows 'unsafe-eval' so Supabase can function, 
    and connect-src includes your domain
  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 10px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .top-bar h1 {
      margin: 0;
    }
    #logout-btn {
      margin-left: 20px;
      background: #f44336;
      color: #fff;
      cursor: pointer;
      padding: 6px 12px;
      border: none;
    }
    .view-buttons button {
      margin-right: 8px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #yearly-view, #monthly-view, #daily-view {
      display: none;
      margin-top: 20px;
    }
    .calendar-grid {
      display: grid;
      gap: 10px;
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
    }
    .month-grid {
      grid-template-columns: repeat(7, 1fr);
    }
    .calendar-cell {
      border: 1px solid #ccc;
      padding: 8px;
      min-height: 80px;
      position: relative;
      cursor: pointer;
    }
    /* Daily container from 8:00 -> midnight => 960 minutes */
    #daily-container {
      position: relative;
      height: 960px;
      border: 1px solid #ccc;
      overflow-y: auto;
      margin-top: 20px;
      background: #f9f9f9;
    }
    .hour-line {
      position: absolute;
      left: 0;
      width: 100%;
      border-top: 1px dashed #ccc;
      color: #777;
      font-size: 12px;
      padding-left: 5px;
    }
    /* Schedule block (translucent) */
    .schedule-block {
      position: absolute;
      background: rgba(0,0,0,0.05);
      color: #000;
      padding: 2px;
      font-size: 0.75em;
      box-sizing: border-box;
      border-left: 4px solid #aaa;
      pointer-events: none;
    }
    .schedule-artist-name {
      font-weight: bold;
      display: block;
      margin-bottom: 2px;
    }
    /* Appointment block (solid) */
    .appointment-block {
      position: absolute;
      background: #ddd;
      color: #000;
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 0.85em;
      box-sizing: border-box;
      cursor: pointer;
    }
    /* Columns: each artist's schedule or appointments appear in their own column 
       We'll do the same offset logic as appointments => left base + index*colWidth */
    #appt-modal {
      display: none;
      position: fixed;
      top: 15%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 2px solid #ccc;
      padding: 20px;
      width: 300px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .modal-field {
      margin-bottom: 10px;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 10px;
    }
    .modal-buttons button {
      margin-left: 8px;
    }
    #manage-schedules-link {
      margin-left: 15px;
      text-decoration: none;
      background: #1b8adb;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
    }
    #artist-filter-container {
      margin-top: 10px;
    }
    .artist-filter-item {
      display: inline-block;
      margin-right: 10px;
    }
    #location-filter {
      margin-top: 10px;
      padding: 6px;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>Calendar</h1>
    <div>
      <a id="manage-schedules-link" href="manage_schedules.html">Manage Schedules</a>
      <button id="logout-btn">Logout</button>
    </div>
  </div>

  <!-- Location Filter so the user picks which location to load artists from -->
  <div>
    <label for="location-filter">Location:</label>
    <select id="location-filter">
      <option value="">-- Select Location --</option>
    </select>
  </div>

  <div class="view-buttons">
    <button id="year-btn">Yearly View</button>
    <button id="month-btn">Monthly View</button>
    <button id="day-btn">Daily View</button>
  </div>

  <!-- YEARLY VIEW -->
  <div id="yearly-view">
    <h2>Yearly View (Placeholder)</h2>
    <p>Switch to Month or Day for detailed scheduling.</p>
  </div>

  <!-- MONTHLY VIEW -->
  <div id="monthly-view">
    <h2>Monthly View</h2>
    <label for="month-input">Month:</label>
    <input type="month" id="month-input" />
    <button id="load-month">Load Month</button>
    <div class="calendar-grid month-grid" id="month-grid"></div>
  </div>

  <!-- DAILY VIEW -->
  <div id="daily-view">
    <h2>Daily View</h2>
    <label for="day-input">Date:</label>
    <input type="date" id="day-input" />
    <button id="load-day">Load Day</button>

    <!-- Artist Filter -->
    <div id="artist-filter-container"></div>

    <div id="daily-container"></div>
  </div>

  <!-- Appointment Modal -->
  <div id="appt-modal">
    <h3 id="modal-title">New Appointment</h3>
    <div class="modal-field">
      <label for="modal-start-time">Start Time:</label>
      <input type="time" id="modal-start-time" />
    </div>
    <div class="modal-field">
      <label for="modal-end-time">End Time:</label>
      <input type="time" id="modal-end-time" />
    </div>
    <div class="modal-field">
      <label for="modal-artist">Artist:</label>
      <select id="modal-artist" title="Appointment Artist"></select>
    </div>
    <div class="modal-field">
      <label for="modal-client-name">Client Name:</label>
      <input type="text" id="modal-client-name" />
    </div>
    <div class="modal-field">
      <label for="modal-client-phone">Client Phone:</label>
      <input type="text" id="modal-client-phone" />
    </div>
    <div class="modal-field">
      <label for="modal-email">Client Email:</label>
      <input type="email" id="modal-email" />
    </div>
    <div class="modal-field">
      <label for="modal-description">Tattoo Description:</label>
      <textarea id="modal-description"></textarea>
    </div>
    <div class="modal-field">
      <label for="modal-deposit">Deposit:</label>
      <input type="number" id="modal-deposit" />
    </div>
    <div class="modal-field">
      <label for="modal-price">Price:</label>
      <input type="number" id="modal-price" />
    </div>
    <div class="modal-field">
      <label for="modal-tip">Tip:</label>
      <input type="number" id="modal-tip" />
    </div>
    <div class="modal-field">
      <label for="modal-appt-type" title="Appointment Type">Appointment Type:</label>
      <select id="modal-appt-type" title="Appointment Type">
        <option value="walk-in">Walk-in</option>
        <option value="appointment">Appointment</option>
      </select>
    </div>
    <div class="modal-buttons">
      <button id="save-appt-btn">Save</button>
      <button id="cancel-appt-btn">Cancel</button>
      <button id="delete-appt-btn" style="display: none;">Delete</button>
      <button id="complete-appt-btn" style="display: none;">Mark Completed</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    function checkAuth() {
      const userId = localStorage.getItem('currentUserId');
      if (!userId) {
        window.location.href = 'login.html';
      }
    }

    const supabaseUrl = 'https://shlvjhipxnslrncczopn.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const logoutBtn = document.getElementById('logout-btn');
    const yearBtn = document.getElementById('year-btn');
    const monthBtn = document.getElementById('month-btn');
    const dayBtn = document.getElementById('day-btn');
    const yearlyView = document.getElementById('yearly-view');
    const monthlyView = document.getElementById('monthly-view');
    const dailyView = document.getElementById('daily-view');
    const monthInput = document.getElementById('month-input');
    const loadMonthBtn = document.getElementById('load-month');
    const monthGrid = document.getElementById('month-grid');
    const dayInput = document.getElementById('day-input');
    const loadDayBtn = document.getElementById('load-day');
    const dailyContainer = document.getElementById('daily-container');
    const artistFilterContainer = document.getElementById('artist-filter-container');
    const locationFilter = document.getElementById('location-filter');

    // Modal references
    const apptModal = document.getElementById('appt-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalStartTime = document.getElementById('modal-start-time');
    const modalEndTime = document.getElementById('modal-end-time');
    const modalArtist = document.getElementById('modal-artist');
    const modalClientName = document.getElementById('modal-client-name');
    const modalClientPhone = document.getElementById('modal-client-phone');
    const modalEmail = document.getElementById('modal-email');
    const modalDescription = document.getElementById('modal-description');
    const modalDeposit = document.getElementById('modal-deposit');
    const modalPrice = document.getElementById('modal-price');
    const modalTip = document.getElementById('modal-tip');
    const modalApptType = document.getElementById('modal-appt-type');
    const saveApptBtn = document.getElementById('save-appt-btn');
    const cancelApptBtn = document.getElementById('cancel-appt-btn');
    const deleteApptBtn = document.getElementById('delete-appt-btn');
    const completeApptBtn = document.getElementById('complete-appt-btn');

    let currentApptId = null;
    let currentDateSelected = null;
    let artistMap = {}; // Each artist's row from the `artists` table
    let scheduleColumns = []; // We'll place each filtered artist in its own column

    const dayCols = {
      0: { startCol: 'sunday_start', endCol: 'sunday_end' },
      1: { startCol: 'monday_start', endCol: 'monday_end' },
      2: { startCol: 'tuesday_start', endCol: 'tuesday_end' },
      3: { startCol: 'wednesday_start', endCol: 'wednesday_end' },
      4: { startCol: 'thursday_start', endCol: 'thursday_end' },
      5: { startCol: 'friday_start', endCol: 'friday_end' },
      6: { startCol: 'saturday_start', endCol: 'saturday_end' }
    };

    logoutBtn.addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'login.html';
    });

    yearBtn.addEventListener('click', () => {
      yearlyView.style.display = 'block';
      monthlyView.style.display = 'none';
      dailyView.style.display = 'none';
    });
    monthBtn.addEventListener('click', () => {
      yearlyView.style.display = 'none';
      monthlyView.style.display = 'block';
      dailyView.style.display = 'none';
    });
    dayBtn.addEventListener('click', () => {
      yearlyView.style.display = 'none';
      monthlyView.style.display = 'none';
      dailyView.style.display = 'block';
    });

    // 1) Load all locations
    async function loadLocations() {
      const { data, error } = await supabase
        .from('locations')
        .select('*');
      if (error) {
        console.error(error);
        return;
      }
      locationFilter.innerHTML = '<option value="">-- Select Location --</option>';
      data.forEach(loc => {
        const opt = document.createElement('option');
        opt.value = loc.id;
        opt.textContent = loc.location_name;
        locationFilter.appendChild(opt);
      });
    }

    locationFilter.addEventListener('change', () => {
      loadArtistsForLocation(locationFilter.value);
    });

    // 2) Load artists for chosen location => store in artistMap
    async function loadArtistsForLocation(locId) {
      artistMap = {};
      modalArtist.innerHTML = '';
      artistFilterContainer.innerHTML = '';

      if (!locId) return;
      // fetch columns from `artists`
      const { data, error } = await supabase
        .from('artists')
        .select(`
          id, artist_name, color,
          sunday_start, sunday_end,
          monday_start, monday_end,
          tuesday_start, tuesday_end,
          wednesday_start, wednesday_end,
          thursday_start, thursday_end,
          friday_start, friday_end,
          saturday_start, saturday_end
        `)
        .eq('location_id', locId);
      if (error) {
        console.error(error);
        return;
      }

      // Sort artists by name or ID so we have a consistent column order
      data.sort((a,b) => a.artist_name.localeCompare(b.artist_name));

      // Build map + checkboxes
      data.forEach((art, idx) => {
        artistMap[art.id] = art;

        // For new appt modal
        const opt = document.createElement('option');
        opt.value = art.id;
        opt.textContent = art.artist_name;
        modalArtist.appendChild(opt);

        // Filter checkboxes
        const wrapper = document.createElement('div');
        wrapper.classList.add('artist-filter-item');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = 'artist-filter-' + art.id;
        cb.value = art.id;
        cb.checked = true;

        const label = document.createElement('label');
        label.htmlFor = cb.id;
        label.textContent = art.artist_name;

        wrapper.appendChild(cb);
        wrapper.appendChild(label);
        artistFilterContainer.appendChild(wrapper);
      });
    }

    function getFilteredArtistIds() {
      const cbs = artistFilterContainer.querySelectorAll('input[type="checkbox"]');
      let arr = [];
      cbs.forEach(cb => {
        if (cb.checked) arr.push(cb.value);
      });
      return arr;
    }

    // 3) Month view
    loadMonthBtn.addEventListener('click', () => {
      monthGrid.innerHTML = '';
      const mVal = monthInput.value;
      if (!mVal) return;
      const [yyyy, mm] = mVal.split('-').map(Number);
      const lastDay = new Date(yyyy, mm, 0).getDate();

      for(let d=1; d<=lastDay; d++){
        const cell=document.createElement('div');
        cell.classList.add('calendar-cell');
        cell.innerHTML=`<div class="day-label">${d}</div>`;
        cell.addEventListener('click', () => openDay(yyyy, mm-1, d));
        monthGrid.appendChild(cell);
      }
    });

    function openDay(year, month, day) {
      dayBtn.click();
      const dateStr = new Date(Date.UTC(year, month, day)).toISOString().split('T')[0];
      dayInput.value = dateStr;
      loadDay();
    }

    // 4) Day view
    loadDayBtn.addEventListener('click', loadDay);

    async function loadDay() {
      dailyContainer.innerHTML = '';
      const dayVal = dayInput.value;
      if (!dayVal) return;
      currentDateSelected = dayVal;

      // show hour lines
      for(let hr=8; hr<=24; hr++){
        const minFrom8=(hr-8)*60;
        const line=document.createElement('div');
        line.classList.add('hour-line');
        line.style.top=minFrom8+'px';
        let h=hr; let ampm='AM';
        if(h>=12) ampm='PM';
        if(h>12) h-=12;
        if(h===24){ h=12; ampm='AM';}
        line.textContent=`${h}:00 ${ampm}`;
        dailyContainer.appendChild(line);
      }

      // parse day-of-week index as UTC
      const dayDate = new Date(`${dayVal}T00:00:00Z`);
      // getUTCDay => 0=Sun,1=Mon,...,6=Sat
      const dayIndex = dayDate.getUTCDay();
      const { startCol, endCol } = dayCols[dayIndex];

      // Build a sorted list of filtered artists
      const filteredIds = getFilteredArtistIds();
      const colArtists = Object.values(artistMap)
        .filter(a => filteredIds.includes(a.id))
        .sort((a,b)=>a.artist_name.localeCompare(b.artist_name));

      // For each artist => place schedule block in a separate column
      colArtists.forEach((art, colIndex) => {
        const st = art[startCol];
        const en = art[endCol];
        if (!st || !en) return; // no schedule
        const sNum = toMinutes(st);
        const eNum = toMinutes(en);
        if (sNum>=eNum) return;

        // offset by 8
        const top = sNum - 8*60;
        const height = eNum - sNum;

        // column offset
        const leftBase = 0; // schedule blocks start at left=0
        const colWidth = 120; 
        const x = leftBase + colIndex*colWidth;

        const div=document.createElement('div');
        div.classList.add('schedule-block');
        div.style.left= x+'px';
        div.style.width= (colWidth-10)+'px';
        div.style.top= top+'px';
        div.style.height= height+'px';

        const color=art.color||'#aaa';
        div.style.borderLeftColor=color;
        div.innerHTML=`
          <span class="schedule-artist-name">${art.artist_name}</span>
          ${st} - ${en}
        `;
        dailyContainer.appendChild(div);
      });

      // fetch appointments
      let { data:appts, error }=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('date', dayVal);
      if(error){console.error(error);return;}

      // filter by colArtists
      let filteredAppts = appts.filter(a => filteredIds.includes(a.artist_id));
      // sort by start time
      filteredAppts.sort((a,b)=>toMinutes(a.start_time)-toMinutes(b.start_time));

      // We'll group appointments by **artist** first, then do overlap columns within that artist's column
      // So each artist is a "main column," and if that artist has multiple overlapping appts, we do subcolumns
      const apptsByArtist = {};
      colArtists.forEach(a=> { apptsByArtist[a.id]=[]; });
      filteredAppts.forEach(a=> {
        apptsByArtist[a.artist_id].push(a);
      });

      // For each artist's list, do overlap logic
      colArtists.forEach((art, mainColIdx) => {
        const mainColAppts = apptsByArtist[art.id]||[];
        let subColumns = []; // each is array of appointments that don't overlap each other
        mainColAppts.forEach(ap => {
          let placed=false;
          for(let col of subColumns){
            let last=col[col.length-1];
            if(!appointmentsOverlap(last, ap)){
              col.push(ap);
              placed=true;
              break;
            }
          }
          if(!placed) subColumns.push([ap]);
        });

        // Now render each subcolumn
        subColumns.forEach((subCol, subColIdx) => {
          subCol.forEach(ap => {
            const sNum = toMinutes(ap.start_time)-8*60;
            const eNum = toMinutes(ap.end_time)-8*60;
            const top=Math.max(sNum,0);
            const ht=Math.max(eNum-sNum,5);

            const block=document.createElement('div');
            block.classList.add('appointment-block');
            const c=art.color||'#ddd';
            block.style.backgroundColor=c;

            // main column offset
            const leftBase=0 + mainColIdx*120; 
            // each subcol ~110px wide within that main column
            const subWidth=110/subColumns.length;
            // shift sub-col horizontally within main column
            const blockLeft = leftBase + subColIdx*(subWidth);
            block.style.left= blockLeft+'px';
            block.style.width= (subWidth-10)+'px';
            block.style.top= top+'px';
            block.style.height= ht+'px';

            block.textContent=`${art.artist_name} - ${ap.client_name||'N/A'} (${ap.appointment_type})`;

            block.addEventListener('click',(evt)=>{
              evt.stopPropagation();
              openExistingApptModal(ap.id);
            });
            dailyContainer.appendChild(block);
          });
        });
      });

      dailyContainer.addEventListener('click', onDailyContainerClick);
    }

    function toMinutes(hhmm){
      if(!hhmm)return 0;
      const [h,m]=hhmm.split(':').map(Number);
      return h*60 + m;
    }
    function appointmentsOverlap(a,b){
      if(!a||!b)return false;
      const aS=toMinutes(a.start_time);
      const aE=toMinutes(a.end_time);
      const bS=toMinutes(b.start_time);
      const bE=toMinutes(b.end_time);
      return(aS<bE && bS<aE);
    }
    function onDailyContainerClick(e){
      if(
        e.target.classList.contains('appointment-block')||
        e.target.classList.contains('schedule-block')||
        e.target.classList.contains('hour-line')
      )return;
      const rect=dailyContainer.getBoundingClientRect();
      const clickY=e.clientY-rect.top;
      const mins=Math.floor(clickY);
      const hr=Math.floor(mins/60)+8;
      const mm=(mins%60).toString().padStart(2,'0');
      const hh=hr.toString().padStart(2,'0');
      openNewApptModal(`${hh}:${mm}`, dayInput.value);
    }

    async function openNewApptModal(slot, dateStr){
      currentApptId=null;
      modalTitle.textContent='New Appointment';
      modalStartTime.value=slot;
      modalEndTime.value=slot;
      modalArtist.value='';
      modalClientName.value='';
      modalClientPhone.value='';
      modalEmail.value='';
      modalDescription.value='';
      modalDeposit.value='';
      modalPrice.value='';
      modalTip.value='';
      modalApptType.value='walk-in';
      deleteApptBtn.style.display='none';
      completeApptBtn.style.display='none';
      apptModal.style.display='block';
    }
    async function openExistingApptModal(apptId){
      currentApptId=apptId;
      const {data,error}=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('id',apptId);
      if(error||!data||data.length===0){
        console.error(error);
        alert('Error loading appointment.');
        return;
      }
      const ap=data[0];
      modalTitle.textContent='Edit Appointment';
      modalStartTime.value=ap.start_time||'';
      modalEndTime.value=ap.end_time||'';
      modalArtist.value=ap.artist_id;
      modalClientName.value=ap.client_name||'';
      modalClientPhone.value=ap.client_phone||'';
      modalEmail.value=ap.email||'';
      modalDescription.value=ap.notes||'';
      modalDeposit.value=ap.deposit||'';
      modalPrice.value=ap.price||'';
      modalTip.value=ap.tip||'';
      modalApptType.value=ap.appointment_type||'walk-in';
      deleteApptBtn.style.display='inline-block';
      completeApptBtn.style.display='inline-block';
      apptModal.style.display='block';
    }

    saveApptBtn.addEventListener('click', async ()=>{
      const sVal=modalStartTime.value;
      const eVal=modalEndTime.value;
      const aVal=modalArtist.value;
      const cName=modalClientName.value;
      const cPhone=modalClientPhone.value;
      const eMail=modalEmail.value;
      const dVal=modalDescription.value;
      const dep=modalDeposit.value?parseFloat(modalDeposit.value):null;
      const pr=modalPrice.value?parseFloat(modalPrice.value):null;
      const tp=modalTip.value?parseFloat(modalTip.value):null;
      const apType=modalApptType.value;

      if(!sVal||!eVal){
        alert('Start and End time are required.');
        return;
      }
      let { data: ex, error }=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('date', dayInput.value)
        .eq('artist_id', aVal);
      if(error){console.error(error);alert('Error checking overlap.');return;}

      if(checkOverlap(ex, sVal, eVal)){
        alert('That slot overlaps an existing appointment.');
        return;
      }
      if(!currentApptId){
        // Insert
        const {error:insE}=await supabase
          .from('artist_appointments')
          .insert([{
            artist_id:aVal,
            date: dayInput.value,
            start_time:sVal,
            end_time:eVal,
            appointment_type:apType,
            client_name:cName,
            client_phone:cPhone,
            email:eMail,
            notes:dVal,
            deposit:dep,
            price:pr,
            tip:tp
          }]);
        if(insE){console.error(insE);alert('Error inserting appt.');return;}
      }else{
        // Update
        const {error:updE}=await supabase
          .from('artist_appointments')
          .update({
            artist_id:aVal,
            start_time:sVal,
            end_time:eVal,
            appointment_type:apType,
            client_name:cName,
            client_phone:cPhone,
            email:eMail,
            notes:dVal,
            deposit:dep,
            price:pr,
            tip:tp
          })
          .eq('id',currentApptId);
        if(updE){console.error(updE);alert('Error updating appt.');return;}
      }
      reloadDay();
    });

    function checkOverlap(existing, st, en){
      const sN=toMinutes(st);
      const eN=toMinutes(en);
      for(let ap of existing){
        if(ap.id!==currentApptId){
          const aS=toMinutes(ap.start_time);
          const aE=toMinutes(ap.end_time);
          if(sN<aE && aS<eN)return true;
        }
      }
      return false;
    }
    function reloadDay(){
      apptModal.style.display='none';
      dailyContainer.removeEventListener('click', onDailyContainerClick, false);
      loadDay().then(()=>{
        dailyContainer.addEventListener('click', onDailyContainerClick);
      });
    }
    deleteApptBtn.addEventListener('click', async ()=>{
      if(!currentApptId)return;
      const c=confirm('Are you sure you want to delete this?');
      if(!c)return;
      const {error}=await supabase
        .from('artist_appointments')
        .delete()
        .eq('id',currentApptId);
      if(error){console.error(error);alert('Error deleting.');return;}
      reloadDay();
    });
    completeApptBtn.addEventListener('click', async ()=>{
      if(!currentApptId)return;
      const {error}=await supabase
        .from('artist_appointments')
        .update({appointment_type:'completed'})
        .eq('id',currentApptId);
      if(error){console.error(error);alert('Error marking completed.');return;}
      reloadDay();
    });
    cancelApptBtn.addEventListener('click', ()=>{
      apptModal.style.display='none';
    });

    window.addEventListener('DOMContentLoaded', async ()=>{
      checkAuth();
      await loadLocations();
      showMonthly(); // default to monthly
    });
  </script>
</body>
</html>
