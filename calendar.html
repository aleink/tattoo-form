<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 
    Content Security Policy:
    - 'unsafe-eval' to fix eval blocking for Supabase
    - 'unsafe-inline' for inline scripts
    - connect-src for your Supabase domain
  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 10px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .top-bar h1 {
      margin: 0;
    }
    #logout-btn {
      margin-left: 20px;
      background: #f44336;
      color: #fff;
      cursor: pointer;
      padding: 6px 12px;
      border: none;
    }
    .view-buttons button {
      margin-right: 8px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #yearly-view, #monthly-view, #daily-view {
      display: none;
      margin-top: 20px;
    }
    .calendar-grid {
      display: grid;
      gap: 10px;
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
    }
    .month-grid {
      grid-template-columns: repeat(7, 1fr);
    }
    .calendar-cell {
      border: 1px solid #ccc;
      padding: 8px;
      min-height: 80px;
      position: relative;
      cursor: pointer;
    }
    #daily-container {
      position: relative;
      height: 960px; /* 8:00 AM - midnight => 16 hours => 16*60=960 minutes */
      border: 1px solid #ccc;
      overflow-y: auto;
      margin-top: 20px;
      background: #f9f9f9;
    }
    .hour-line {
      position: absolute;
      left: 0;
      width: 100%;
      border-top: 1px dashed #ccc;
      color: #777;
      font-size: 12px;
      padding-left: 5px;
    }
    .schedule-block {
      position: absolute;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.05);
      color: #000;
      padding: 2px;
      font-size: 0.75em;
      box-sizing: border-box;
      border-left: 4px solid #aaa;
      pointer-events: none; 
    }
    .schedule-artist-name {
      font-weight: bold;
      display: block;
      margin-bottom: 2px;
    }
    .vacation-block {
      position: absolute;
      left: 0;
      right: 0;
      background-color: rgba(128,128,128,0.2);
      border-left: 4px solid #888;
      color: #222;
      padding: 2px;
      font-size: 0.8em;
      box-sizing: border-box;
      pointer-events: none;
      font-weight: bold;
    }
    .appointment-block {
      position: absolute;
      background: #ddd;
      color: #000;
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 0.85em;
      box-sizing: border-box;
      cursor: pointer;
    }
    #appt-modal {
      display: none;
      position: fixed;
      top: 15%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 2px solid #ccc;
      padding: 20px;
      width: 300px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .modal-field {
      margin-bottom: 10px;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 10px;
    }
    .modal-buttons button {
      margin-left: 8px;
    }
    #manage-schedules-link {
      margin-left: 15px;
      text-decoration: none;
      background: #1b8adb;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
    }
    #artist-filter-container {
      margin-top: 10px;
    }
    .artist-filter-item {
      display: inline-block;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>Calendar</h1>
    <div>
      <a id="manage-schedules-link" href="manage_schedules.html">Manage Schedules</a>
      <button id="logout-btn">Logout</button>
    </div>
  </div>

  <div class="view-buttons">
    <button id="year-btn">Yearly View</button>
    <button id="month-btn">Monthly View</button>
    <button id="day-btn">Daily View</button>
  </div>

  <!-- YEARLY VIEW -->
  <div id="yearly-view">
    <h2>Yearly View (Placeholder)</h2>
    <p>Switch to Month or Day for detailed scheduling.</p>
  </div>

  <!-- MONTHLY VIEW -->
  <div id="monthly-view">
    <h2>Monthly View</h2>
    <label for="month-input">Month:</label>
    <input type="month" id="month-input" placeholder="Pick a month" title="Month" />
    <button id="load-month">Load Month</button>
    <div class="calendar-grid month-grid" id="month-grid"></div>
  </div>

  <!-- DAILY VIEW -->
  <div id="daily-view">
    <h2>Daily View</h2>
    <label for="day-input">Date:</label>
    <input type="date" id="day-input" placeholder="Pick a date" title="Date" />
    <button id="load-day">Load Day</button>

    <!-- Artist Filter -->
    <div id="artist-filter-container"></div>

    <div id="daily-container"></div>
  </div>

  <!-- Appointment Modal -->
  <div id="appt-modal">
    <h3 id="modal-title">New Appointment</h3>
    <div class="modal-field">
      <label for="modal-start-time">Start Time:</label>
      <input type="time" id="modal-start-time" />
    </div>
    <div class="modal-field">
      <label for="modal-end-time">End Time:</label>
      <input type="time" id="modal-end-time" />
    </div>
    <div class="modal-field">
      <label for="modal-artist">Artist:</label>
      <select id="modal-artist" title="Appointment Artist"></select>
    </div>
    <div class="modal-field">
      <label for="modal-client-name">Client Name:</label>
      <input type="text" id="modal-client-name" placeholder="Client name" />
    </div>
    <div class="modal-field">
      <label for="modal-client-phone">Client Phone:</label>
      <input type="text" id="modal-client-phone" placeholder="Client phone" />
    </div>
    <div class="modal-field">
      <label for="modal-email">Client Email:</label>
      <input type="email" id="modal-email" placeholder="Client email" />
    </div>
    <div class="modal-field">
      <label for="modal-description">Tattoo Description:</label>
      <textarea id="modal-description" placeholder="Tattoo details"></textarea>
    </div>
    <div class="modal-field">
      <label for="modal-deposit">Deposit:</label>
      <input type="number" id="modal-deposit" placeholder="Deposit amount" />
    </div>
    <div class="modal-field">
      <label for="modal-price">Price:</label>
      <input type="number" id="modal-price" placeholder="Tattoo price" />
    </div>
    <div class="modal-field">
      <label for="modal-tip">Tip:</label>
      <input type="number" id="modal-tip" placeholder="Tip" />
    </div>
    <div class="modal-field">
      <label for="modal-appt-type" title="Appointment Type">Appointment Type:</label>
      <select id="modal-appt-type" title="Appointment Type">
        <option value="walk-in">Walk-in</option>
        <option value="appointment">Appointment</option>
      </select>
    </div>
    <div class="modal-buttons">
      <button id="save-appt-btn">Save</button>
      <button id="cancel-appt-btn">Cancel</button>
      <button id="delete-appt-btn" style="display: none;">Delete</button>
      <button id="complete-appt-btn" style="display: none;">Mark Completed</button>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    /* 1) Define checkAuth() so no error is thrown */
    function checkAuth() {
      const userId = localStorage.getItem('currentUserId');
      if (!userId) {
        window.location.href = 'login.html';
      }
    }

    const supabaseUrl = 'https://shlvjhipxnslrncczopn.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    /* The rest of your existing code is unchanged, except you call checkAuth() 
       in DOMContentLoaded so the function is recognized and no error occurs. */

    // Basic references
    const logoutBtn = document.getElementById('logout-btn');
    const yearBtn = document.getElementById('year-btn');
    const monthBtn = document.getElementById('month-btn');
    const dayBtn = document.getElementById('day-btn');
    const yearlyView = document.getElementById('yearly-view');
    const monthlyView = document.getElementById('monthly-view');
    const dailyView = document.getElementById('daily-view');
    const monthInput = document.getElementById('month-input');
    const loadMonthBtn = document.getElementById('load-month');
    const monthGrid = document.getElementById('month-grid');
    const dayInput = document.getElementById('day-input');
    const loadDayBtn = document.getElementById('load-day');
    const dailyContainer = document.getElementById('daily-container');
    const artistFilterContainer = document.getElementById('artist-filter-container');

    // Modal references
    const apptModal = document.getElementById('appt-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalStartTime = document.getElementById('modal-start-time');
    const modalEndTime = document.getElementById('modal-end-time');
    const modalArtist = document.getElementById('modal-artist');
    const modalClientName = document.getElementById('modal-client-name');
    const modalClientPhone = document.getElementById('modal-client-phone');
    const modalEmail = document.getElementById('modal-email');
    const modalDescription = document.getElementById('modal-description');
    const modalDeposit = document.getElementById('modal-deposit');
    const modalPrice = document.getElementById('modal-price');
    const modalTip = document.getElementById('modal-tip');
    const modalApptType = document.getElementById('modal-appt-type');
    const saveApptBtn = document.getElementById('save-appt-btn');
    const cancelApptBtn = document.getElementById('cancel-appt-btn');
    const deleteApptBtn = document.getElementById('delete-appt-btn');
    const completeApptBtn = document.getElementById('complete-appt-btn');

    // etc. (unchanged)...

    // Example: On page load
    window.addEventListener('DOMContentLoaded', async () => {
      checkAuth();  // call the newly defined function
      showMonthly(); // default
      await loadArtists();  // your existing function
    });
  </script>
</body>
</html>
