<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Club Tattoo Management Tool</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<style>
:root{--bg0:#111;--bg1:#222;--border:#444;--txt:#fff;--txt-dim:#ccc;--accent:#28a745}
body{margin:0;font-family:'Helvetica Neue',Arial,sans-serif;background:var(--bg0);color:var(--txt);min-height:100vh;display:flex;flex-direction:column}
h1,h2{margin:0}
header,footer{background:#000;padding:20px;text-align:center;border-bottom:2px solid var(--border)}
footer{border-top:2px solid var(--border);border-bottom:none}
header h1{font-size:2rem;margin-bottom:10px}
header p{font-size:1rem;color:#bbb}
main{flex:1;padding:40px 20px;display:flex;flex-direction:column;align-items:center;max-width:1200px;margin:0 auto}
.links-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-top:40px;width:100%;max-width:900px}
.card{background:var(--bg1);border:1px solid var(--border);border-radius:6px;padding:20px;text-align:center;transition:background .2s}
.card:hover{background:#333}
.card h2{font-size:1.25rem;margin:0 0 8px}
.card p{font-size:.9rem;color:var(--txt-dim);height:42px;margin:0 0 18px}
.card a{display:inline-block;background:#777;color:#fff;text-decoration:none;padding:8px 16px;border-radius:4px;transition:background .2s}
.card a:hover{background:#999}

/* Top bar (after login) */
#top-bar{display:none;background:#000;border-bottom:2px solid var(--border);padding:12px 20px;align-items:center;justify-content:space-between}
#logout-btn{background:var(--bg1);color:var(--txt);border:none;border-radius:4px;padding:6px 14px;cursor:pointer}
#logout-btn:hover{background:#444}

/* Login box */
#login-section{max-width:420px;margin:60px auto;background:var(--bg1);border:1px solid var(--border);border-radius:6px;padding:28px;display:none}
#login-section label{font-weight:700;display:block;margin:10px 0 4px}
#login-section input{width:100%;padding:8px;background:var(--bg0);color:var(--txt);border:1px solid var(--border);border-radius:4px;margin-bottom:12px}
#login-section button{width:100%;background:var(--accent);border:none;color:#fff;padding:10px;border-radius:4px;cursor:pointer}
#login-section button:hover{opacity:.85}
#login-msg{color:#ff6161;font-size:.9rem;margin-top:6px;text-align:center}
</style>

<!-- Supabase (same key / URL) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
</head>
<body>

<!-- top bar -->
<div id="top-bar">
  <div style="font-weight:600">Club Tattoo Dashboard</div>
  <button id="logout-btn">Logout</button>
</div>

<header>
  <h1>Club Tattoo Management Tool</h1>
  <p>Single portal for booking, scheduling, artist management, payroll, and more.</p>
</header>

<!-- login -->
<section id="login-section">
  <label>Email</label><input id="login-email" type="email" autocomplete="username">
  <label>Password</label><input id="login-pass" type="password" autocomplete="current-password">
  <button id="login-btn">Login</button>
  <div id="login-msg"></div>
</section>

<main id="main-content" style="display:none">
  <h2 style="font-size:1.35rem;margin-bottom:22px">Choose a Section</h2>

  <div class="links-grid">
    <!-- Calendar -->
    <div class="card" id="card-calendar">
      <h2>Calendar</h2><p>View &amp; manage all appointments and schedules.</p>
      <a href="calendar.html">Open Calendar</a>
    </div>
    <!-- Artists -->
    <div class="card" id="card-artists">
      <h2>Artists</h2><p>Add, edit, or remove tattoo artists.</p>
      <a href="manage_artists.html">Manage Artists</a>
    </div>
    <!-- Schedules -->
    <div class="card" id="card-schedules">
      <h2>Schedules</h2><p>Assign working days / hours to each artist.</p>
      <a href="manage_schedules.html">Manage Schedules</a>
    </div>
    <!-- Vacations -->
    <div class="card" id="card-vacations">
      <h2>Vacations</h2><p>Block out dates for artist vacations.</p>
      <a href="manage_vacations.html">Manage Vacations</a>
    </div>
    <!-- Payroll -->
    <div class="card" id="card-payroll">
      <h2>Payroll</h2><p>Calculate earnings and run accounting reports.</p>
      <a href="artists_payroll.html">Open Payroll</a>
    </div>
    <!-- Locations -->
    <div class="card" id="card-locations">
      <h2>Locations</h2><p>Create or edit shop locations &amp; hours.</p>
      <a href="manage_locations.html">Manage Locations</a>
    </div>
  </div>
</main>

<footer><p>&copy; <span id="year"></span> Club Tattoo — All rights reserved.</p></footer>

<script>
/* ========== Supabase init (reuse token) ========== */
const supabase = window.supabase.createClient(
  'https://shlvjhipxnslrncczopn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
);

/* ========== DOM refs ========== */
const loginSec   = document.getElementById('login-section');
const loginEmail = document.getElementById('login-email');
const loginPass  = document.getElementById('login-pass');
const loginBtn   = document.getElementById('login-btn');
const loginMsg   = document.getElementById('login-msg');

const topBar     = document.getElementById('top-bar');
const logoutBtn  = document.getElementById('logout-btn');
const mainCont   = document.getElementById('main-content');

/* current year */
document.getElementById('year').textContent = new Date().getFullYear();

/* ========== auto-login if role already saved ========== */
(function(){
  const r = localStorage.getItem('currentUserRole');
  if(r){
    showApp(r);
  }else{
    loginSec.style.display = 'block';
  }
})();

/* ========== login flow ========== */
loginBtn.onclick = async ()=>{
  loginMsg.textContent='';
  if(!loginEmail.value || !loginPass.value){
    loginMsg.textContent = 'Please enter e-mail & password.'; return;
  }
  const {data,error} = await supabase
        .from('users')
        .select('*')
        .eq('email', loginEmail.value.trim())
        .single();
  if(error || !data){ loginMsg.textContent='Invalid credentials.'; return; }
  if(data.password_hash !== loginPass.value.trim()){
    loginMsg.textContent='Invalid credentials.'; return;
  }

  /* store role, id & location for other pages */
  localStorage.setItem('currentUserRole', data.role);
  localStorage.setItem('currentUserId',   data.id);          /* ← NEW */
  if(data.location_id) localStorage.setItem('currentUserLoc', data.location_id);
  else localStorage.removeItem('currentUserLoc');

  showApp(data.role);
};

/* ========== show app & filter cards ========== */
function showApp(role){
  loginSec.style.display = 'none';
  topBar.style.display   = 'flex';
  mainCont.style.display = 'flex';
  filterCards(role);
}

/* access rules */
function filterCards(role){
  const show = id => document.getElementById(id).style.display='block';
  const hide = id => document.getElementById(id).style.display='none';

  /* default hide all */
  ['card-calendar','card-artists','card-schedules','card-vacations','card-payroll','card-locations']
  .forEach(hide);

  switch(role){
    case 'gm':
    case 'owner':
      ['card-calendar','card-artists','card-schedules','card-vacations','card-payroll','card-locations']
        .forEach(show);
      break;
    case 'sm':
      ['card-calendar','card-artists','card-schedules','card-vacations']
        .forEach(show);
      break;
    case 'fd':
      show('card-calendar');
      break;
    case 'ad':
      show('card-payroll');
      break;
    default:
      // any other role sees nothing
      break;
  }
}

/* ========== logout ========== */
logoutBtn.onclick = ()=>{
  localStorage.clear();
  location.reload();
};
</script>
</body>
</html>
