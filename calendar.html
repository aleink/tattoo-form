<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 
    CSP to allow 'unsafe-eval' and connect to your supabase
  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    /* Dark(ish) style, PC-friendly, similar to your updated pages */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #111;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #000;
      border-bottom: 2px solid #444;
      padding: 20px;
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
      color: #fff;
    }
    main {
      flex: 1;
      max-width: 1200px;
      margin: 20px auto;
      padding: 10px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    #logout-btn {
      background: #f44336;
      color: #fff;
      cursor: pointer;
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
    }
    /* Tabs for Calendar + Appointments */
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .tab-buttons button {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      padding: 8px 14px;
      cursor: pointer;
    }
    .tab-buttons button.active {
      background: #555;
    }
    .tab-content {
      display: none;
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 15px;
    }
    .tab-content.active {
      display: block;
    }

    /* DAILY VIEW STYLES */
    .daily-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    #daily-container {
      position: relative;
      height: 960px; /* 8:00 -> 24:00 => 16 hours => 960 minutes */
      border: 1px solid #444;
      background: #333;
      overflow-y: auto;
      margin-top: 10px;
      color: #000; /* appointment blocks are black text on lighter BG */
    }
    .hour-line {
      position: absolute;
      left: 0;
      width: 100%;
      border-top: 1px dashed #999;
      color: #bbb;
      font-size: 12px;
      padding-left: 5px;
    }
    .schedule-block {
      position: absolute;
      background: rgba(255,255,255,0.05);
      color: #fff;
      padding: 2px;
      font-size: 0.75em;
      box-sizing: border-box;
      border-left: 4px solid #aaa;
      pointer-events: none;
    }
    .schedule-artist-name {
      font-weight: bold;
      display: block;
      margin-bottom: 2px;
    }
    .appointment-block {
      position: absolute;
      background: #ddd;
      color: #000;
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 0.85em;
      box-sizing: border-box;
      cursor: pointer;
    }

    /* APPOINTMENTS TAB STYLES */
    .appt-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .appt-filters label {
      margin-bottom: 0;
    }
    .appt-table-container {
      border: 1px solid #444;
      border-radius: 4px;
      overflow-y: auto;
      max-height: 400px;
      background: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: #fff;
    }
    th, td {
      border: 1px solid #555;
      padding: 6px;
      text-align: left;
      font-size: 0.9rem;
    }
    th {
      background: #444;
      font-weight: bold;
    }

    /* Appointment Modal */
    #appt-modal {
      display: none;
      position: fixed;
      top: 15%;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: #fff;
      border: 2px solid #444;
      padding: 20px;
      width: 300px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.7);
      z-index: 999;
    }
    #appt-modal input, #appt-modal select, #appt-modal textarea {
      width: 100%;
      margin-bottom: 8px;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px;
    }
    #appt-modal button {
      background: #555;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px 12px;
      margin-right: 6px;
      cursor: pointer;
    }
    #appt-modal button:hover {
      background: #666;
    }
    .modal-field {
      margin-bottom: 10px;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header>
    <div class="top-bar">
      <h1>Calendar</h1>
      <button id="logout-btn">Logout</button>
    </div>
  </header>
  <main>
    <div class="tab-buttons">
      <button id="calendar-tab-btn" class="active">Daily Calendar</button>
      <button id="appointments-tab-btn">Appointments</button>
    </div>

    <!-- DAILY CALENDAR TAB -->
    <div class="tab-content active" id="calendar-tab">
      <h2>Daily Calendar</h2>
      <div class="daily-controls">
        <label for="daily-date">Date:</label>
        <input type="date" id="daily-date" />
        <label for="location-filter">Location:</label>
        <select id="location-filter">
          <option value="">-- Select Location --</option>
        </select>
        <div id="artist-filter-container" style="flex:1;"></div>
      </div>
      <div id="daily-container"></div>
    </div>

    <!-- APPOINTMENTS TAB -->
    <div class="tab-content" id="appointments-tab">
      <h2>Appointments</h2>
      <div class="appt-filters">
        <div>
          <label for="store-select">Store:</label>
          <select id="store-select">
            <option value="">-- Select Store --</option>
          </select>
        </div>
        <div>
          <label for="artist-select">Artist:</label>
          <select id="artist-select">
            <option value="">All Artists</option>
          </select>
        </div>
        <div>
          <label for="start-range">Start:</label>
          <input type="date" id="start-range" />
        </div>
        <div>
          <label for="end-range">End:</label>
          <input type="date" id="end-range" />
        </div>
        <div>
          <input type="checkbox" id="show-appointments" checked />
          <label for="show-appointments">Appointments</label>
          <input type="checkbox" id="show-walkins" checked />
          <label for="show-walkins">Walk-ins</label>
        </div>
      </div>
      <div class="appt-table-container">
        <table id="appt-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Artist</th>
              <th>Client</th>
              <th>Type</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <!-- filled dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Appointment Modal (Add/Edit) -->
  <div id="appt-modal">
    <h3 id="modal-title">New Appointment</h3>
    <div class="modal-field">
      <label for="modal-start-time">Start Time:</label>
      <input type="time" id="modal-start-time" />
    </div>
    <div class="modal-field">
      <label for="modal-end-time">End Time:</label>
      <input type="time" id="modal-end-time" />
    </div>
    <div class="modal-field">
      <label for="modal-artist">Artist:</label>
      <select id="modal-artist" title="Appointment Artist"></select>
    </div>
    <div class="modal-field">
      <label for="modal-client-name">Client Name:</label>
      <input type="text" id="modal-client-name" />
    </div>
    <div class="modal-field">
      <label for="modal-client-phone">Client Phone:</label>
      <input type="text" id="modal-client-phone" />
    </div>
    <div class="modal-field">
      <label for="modal-email">Client Email:</label>
      <input type="email" id="modal-email" />
    </div>
    <div class="modal-field">
      <label for="modal-description">Tattoo Description:</label>
      <textarea id="modal-description"></textarea>
    </div>
    <div class="modal-field">
      <label for="modal-deposit">Deposit:</label>
      <input type="number" id="modal-deposit" />
    </div>
    <div class="modal-field">
      <label for="modal-price">Price:</label>
      <input type="number" id="modal-price" />
    </div>
    <div class="modal-field">
      <label for="modal-tip">Tip:</label>
      <input type="number" id="modal-tip" />
    </div>
    <div class="modal-field">
      <label for="modal-appt-type" title="Appointment Type">Appointment Type:</label>
      <select id="modal-appt-type" title="Appointment Type">
        <option value="walk-in">Walk-in</option>
        <option value="appointment">Appointment</option>
      </select>
    </div>
    <div class="modal-buttons">
      <button id="save-appt-btn">Save</button>
      <button id="cancel-appt-btn">Cancel</button>
      <button id="delete-appt-btn" style="display: none;">Delete</button>
      <button id="complete-appt-btn" style="display: none;">Mark Completed</button>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    /****************************************************************
     *   Setup + Auth
     ****************************************************************/
    const supabaseUrl='https://shlvjhipxnslrncczopn.supabase.co';
    const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase=window.supabase.createClient(supabaseUrl,supabaseKey);

    function checkAuth(){
      const userId=localStorage.getItem('currentUserId');
      if(!userId) window.location.href='login.html';
    }

    /****************************************************************
     *   DOM references
     ****************************************************************/
    const logoutBtn=document.getElementById('logout-btn');
    const dailyDate=document.getElementById('daily-date');
    const dailyContainer=document.getElementById('daily-container');
    const locationFilter=document.getElementById('location-filter');
    const artistFilterContainer=document.getElementById('artist-filter-container');

    // Tab buttons
    const calendarTabBtn=document.getElementById('calendar-tab-btn');
    const appointmentsTabBtn=document.getElementById('appointments-tab-btn');
    // Tab contents
    const calendarTab=document.getElementById('calendar-tab');
    const appointmentsTab=document.getElementById('appointments-tab');

    // Appointment list tab references
    const storeSelect=document.getElementById('store-select');
    const artistSelect=document.getElementById('artist-select');
    const startRange=document.getElementById('start-range');
    const endRange=document.getElementById('end-range');
    const showAppointments=document.getElementById('show-appointments');
    const showWalkins=document.getElementById('show-walkins');
    const apptTableBody=document.querySelector('#appt-table tbody');

    // Appt modal
    const apptModal=document.getElementById('appt-modal');
    const modalTitle=document.getElementById('modal-title');
    const modalStartTime=document.getElementById('modal-start-time');
    const modalEndTime=document.getElementById('modal-end-time');
    const modalArtist=document.getElementById('modal-artist');
    const modalClientName=document.getElementById('modal-client-name');
    const modalClientPhone=document.getElementById('modal-client-phone');
    const modalEmail=document.getElementById('modal-email');
    const modalDescription=document.getElementById('modal-description');
    const modalDeposit=document.getElementById('modal-deposit');
    const modalPrice=document.getElementById('modal-price');
    const modalTip=document.getElementById('modal-tip');
    const modalApptType=document.getElementById('modal-appt-type');
    const saveApptBtn=document.getElementById('save-appt-btn');
    const cancelApptBtn=document.getElementById('cancel-appt-btn');
    const deleteApptBtn=document.getElementById('delete-appt-btn');
    const completeApptBtn=document.getElementById('complete-appt-btn');

    // Some variables
    let currentApptId=null;
    let currentDateSelected=null;
    let artistMap={};

    logoutBtn.addEventListener('click',()=>{
      localStorage.clear();
      window.location.href='login.html';
    });

    /****************************************************************
     *  Tabs
     ****************************************************************/
    calendarTabBtn.addEventListener('click',()=>{
      appointmentsTab.classList.remove('active');
      appointmentsTabBtn.classList.remove('active');
      calendarTab.classList.add('active');
      calendarTabBtn.classList.add('active');
    });
    appointmentsTabBtn.addEventListener('click',()=>{
      calendarTab.classList.remove('active');
      calendarTabBtn.classList.remove('active');
      appointmentsTab.classList.add('active');
      appointmentsTabBtn.classList.add('active');
      // load appointments
      loadStoreList();
      loadAppointmentsList(); // immediately
    });

    /****************************************************************
     *  Daily Calendar
     ****************************************************************/
    dailyDate.addEventListener('change', ()=>{
      loadDay();
    });
    locationFilter.addEventListener('change', ()=>{
      loadArtistsForLocation(locationFilter.value);
      loadDay();
    });

    function getFilteredArtistIds(){
      const cbs=artistFilterContainer.querySelectorAll('input[type="checkbox"]');
      let arr=[];
      cbs.forEach(cb=>{
        if(cb.checked) arr.push(cb.value);
      });
      return arr;
    }

    async function loadArtistsForLocation(locId){
      // clear old
      artistMap={};
      artistFilterContainer.innerHTML='';
      modalArtist.innerHTML='';

      if(!locId)return;

      const {data,error}=await supabase
        .from('artists')
        .select('*')
        .eq('location_id',locId);
      if(error){
        console.error(error);
        return;
      }
      data.forEach(art=>{
        artistMap[art.id]=art;
        // appointment modal
        const opt=document.createElement('option');
        opt.value=art.id;
        opt.textContent=art.artist_name;
        modalArtist.appendChild(opt);

        // daily filter checkboxes
        const wrap=document.createElement('div');
        wrap.style.marginRight='6px';
        const cb=document.createElement('input');
        cb.type='checkbox';
        cb.id='artist-filter-'+art.id;
        cb.value=art.id;
        cb.checked=true;
        const label=document.createElement('label');
        label.htmlFor=cb.id;
        label.textContent=art.artist_name;
        wrap.appendChild(cb);
        wrap.appendChild(label);
        artistFilterContainer.appendChild(wrap);
      });
    }

    async function loadDay(){
      dailyContainer.innerHTML='';
      currentDateSelected=dailyDate.value;
      if(!currentDateSelected)return;

      // draw hour lines
      for(let hr=8; hr<=24; hr++){
        const minFrom8=(hr-8)*60;
        const line=document.createElement('div');
        line.classList.add('hour-line');
        line.style.top=minFrom8+'px';

        let h=hr; 
        let ampm='AM';
        if(h>=12) ampm='PM';
        if(h>12) h-=12;
        if(h===24){h=12;ampm='AM';}
        line.textContent=`${h}:00 ${ampm}`;
        dailyContainer.appendChild(line);
      }

      // gather chosen artists
      const cbs=artistFilterContainer.querySelectorAll('input[type=checkbox]');
      let colArtists=[];
      cbs.forEach(cb=>{
        if(cb.checked){
          const art=artistMap[cb.value];
          if(art) colArtists.push(art);
        }
      });
      // daily schedules
      colArtists.sort((a,b)=> a.artist_name.localeCompare(b.artist_name));
      
      const dayIndex=new Date(currentDateSelected).getDay();
      const dayCols={
        0:{startCol:'sunday_start',endCol:'sunday_end'},
        1:{startCol:'monday_start',endCol:'monday_end'},
        2:{startCol:'tuesday_start',endCol:'tuesday_end'},
        3:{startCol:'wednesday_start',endCol:'wednesday_end'},
        4:{startCol:'thursday_start',endCol:'thursday_end'},
        5:{startCol:'friday_start',endCol:'friday_end'},
        6:{startCol:'saturday_start',endCol:'saturday_end'}
      };
      const {startCol,endCol}=dayCols[dayIndex];
      colArtists.forEach((art,colIndex)=>{
        const st=art[startCol];
        const en=art[endCol];
        if(!st||!en)return;
        const sN=toMinutes(st);
        const eN=toMinutes(en);
        if(sN>=eN)return;
        const top=sN-(8*60);
        const height=eN-sN;
        const leftOffset=80;
        const colWidth=120;
        const x=leftOffset+(colIndex*colWidth);

        const div=document.createElement('div');
        div.classList.add('schedule-block');
        div.style.left=x+'px';
        div.style.width=(colWidth-10)+'px';
        div.style.top=top+'px';
        div.style.height=height+'px';
        div.style.borderLeftColor=art.color||'#bbb';
        div.innerHTML=`
          <span class="schedule-artist-name">${art.artist_name}</span>
          ${st} - ${en}
        `;
        dailyContainer.appendChild(div);
      });

      // load appointments
      let {data:appts,error}=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('date',currentDateSelected);
      if(error){
        console.error(error);
        return;
      }
      // filter by chosen artists
      const filteredIds=colArtists.map(a=>a.id);
      appts=appts.filter(a=>filteredIds.includes(a.artist_id));

      // group by artist => subcolumns for overlap
      let byArtist={};
      colArtists.forEach(a=>byArtist[a.id]=[]);
      appts.forEach(ap=> byArtist[ap.artist_id].push(ap));

      colArtists.forEach((art,mainIndex)=>{
        const arr=byArtist[art.id];
        arr.sort((a,b)=> toMinutes(a.start_time)-toMinutes(b.start_time));
        let subColumns=[];
        arr.forEach(ap=>{
          let placed=false;
          for(let col of subColumns){
            let last=col[col.length-1];
            if(!appointmentsOverlap(last,ap)){
              col.push(ap);
              placed=true;break;
            }
          }
          if(!placed) subColumns.push([ap]);
        });
        subColumns.forEach((subCol, subIdx)=>{
          subCol.forEach(ap=>{
            const sN=toMinutes(ap.start_time)-(8*60);
            const eN=toMinutes(ap.end_time)-(8*60);
            const top=Math.max(sN,0);
            const ht=Math.max(eN-sN,5);

            const block=document.createElement('div');
            block.classList.add('appointment-block');
            block.style.backgroundColor=art.color||'#ddd';
            const leftOffset=80+(mainIndex*120);
            const colW=(120-10)/subColumns.length;
            const x=leftOffset+(subIdx*colW);
            block.style.left=x+'px';
            block.style.width=(colW-2)+'px';
            block.style.top=top+'px';
            block.style.height=ht+'px';
            const info=`${art.artist_name} - ${ap.client_name||'N/A'} (${ap.appointment_type})`;
            block.textContent=info;
            block.addEventListener('click',(evt)=>{
              evt.stopPropagation();
              openExistingApptModal(ap.id);
            });
            dailyContainer.appendChild(block);
          });
        });
      });

      dailyContainer.addEventListener('click',onDailyContainerClick);
    }

    function onDailyContainerClick(e){
      if(
        e.target.classList.contains('appointment-block')||
        e.target.classList.contains('schedule-block')||
        e.target.classList.contains('hour-line')
      )return;
      const rect=dailyContainer.getBoundingClientRect();
      const clickY=e.clientY-rect.top;
      const mins=Math.floor(clickY);
      const hr=Math.floor(mins/60)+8;
      const mm=(mins%60).toString().padStart(2,'0');
      const hh=hr.toString().padStart(2,'0');
      openNewApptModal(`${hh}:${mm}`,dailyDate.value);
    }
    function appointmentsOverlap(a,b){
      if(!a||!b)return false;
      const aS=toMinutes(a.start_time), aE=toMinutes(a.end_time);
      const bS=toMinutes(b.start_time), bE=toMinutes(b.end_time);
      return(aS<bE && bS<aE);
    }
    function toMinutes(hhmm){
      if(!hhmm)return 0;
      const [h,m]=hhmm.split(':').map(Number);
      return h*60+m;
    }

    // new appt
    function openNewApptModal(slot, dateStr){
      currentApptId=null;
      modalTitle.textContent='New Appointment';
      modalStartTime.value=slot;
      modalEndTime.value=slot;
      modalArtist.value='';
      modalClientName.value='';
      modalClientPhone.value='';
      modalEmail.value='';
      modalDescription.value='';
      modalDeposit.value='';
      modalPrice.value='';
      modalTip.value='';
      modalApptType.value='walk-in';
      deleteApptBtn.style.display='none';
      completeApptBtn.style.display='none';
      apptModal.style.display='block';
    }
    async function openExistingApptModal(apptId){
      currentApptId=apptId;
      const {data,error}=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('id',apptId);
      if(error||!data||data.length===0){
        console.error(error);
        alert('Error loading appointment.');
        return;
      }
      const ap=data[0];
      modalTitle.textContent='Edit Appointment';
      modalStartTime.value=ap.start_time||'';
      modalEndTime.value=ap.end_time||'';
      modalArtist.value=ap.artist_id||'';
      modalClientName.value=ap.client_name||'';
      modalClientPhone.value=ap.client_phone||'';
      modalEmail.value=ap.email||'';
      modalDescription.value=ap.notes||'';
      modalDeposit.value=ap.deposit||'';
      modalPrice.value=ap.price||'';
      modalTip.value=ap.tip||'';
      modalApptType.value=ap.appointment_type||'walk-in';
      deleteApptBtn.style.display='inline-block';
      completeApptBtn.style.display='inline-block';
      apptModal.style.display='block';
    }
    saveApptBtn.addEventListener('click',async()=>{
      const sVal=modalStartTime.value;
      const eVal=modalEndTime.value;
      const aVal=modalArtist.value;
      const cName=modalClientName.value;
      const cPhone=modalClientPhone.value;
      const eMail=modalEmail.value;
      const desc=modalDescription.value;
      const dep=modalDeposit.value?parseFloat(modalDeposit.value):null;
      const pr=modalPrice.value?parseFloat(modalPrice.value):null;
      const tp=modalTip.value?parseFloat(modalTip.value):null;
      const apType=modalApptType.value;
      if(!sVal||!eVal){
        alert('Start/End time required.');return;
      }

      // overlap check
      const {data:ex,error}=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('date',dailyDate.value)
        .eq('artist_id',aVal);
      if(error){
        console.error(error);
        alert('Error checking overlap.');
        return;
      }
      if(checkOverlap(ex,sVal,eVal)){
        alert('Overlap with an existing appointment.');
        return;
      }

      if(!currentApptId){
        // insert
        const {error:insE}=await supabase
          .from('artist_appointments')
          .insert([{
            artist_id:aVal,
            date: dailyDate.value,
            start_time:sVal,
            end_time:eVal,
            appointment_type:apType,
            client_name:cName,
            client_phone:cPhone,
            email:eMail,
            notes:desc,
            deposit:dep,
            price:pr,
            tip:tp
          }]);
        if(insE){
          console.error(insE);
          alert('Error inserting appt.');
          return;
        }
      } else {
        // update
        const {error:updE}=await supabase
          .from('artist_appointments')
          .update({
            artist_id:aVal,
            start_time:sVal,
            end_time:eVal,
            appointment_type:apType,
            client_name:cName,
            client_phone:cPhone,
            email:eMail,
            notes:desc,
            deposit:dep,
            price:pr,
            tip:tp
          })
          .eq('id',currentApptId);
        if(updE){
          console.error(updE);
          alert('Error updating appt.');
          return;
        }
      }
      apptModal.style.display='none';
      loadDay();
    });
    deleteApptBtn.addEventListener('click',async()=>{
      if(!currentApptId)return;
      const c=confirm('Delete this appointment?');
      if(!c)return;
      const {error}=await supabase
        .from('artist_appointments')
        .delete()
        .eq('id',currentApptId);
      if(error){
        console.error(error);
        alert('Error deleting appt.');
        return;
      }
      apptModal.style.display='none';
      loadDay();
    });
    completeApptBtn.addEventListener('click',async()=>{
      if(!currentApptId)return;
      const {error}=await supabase
        .from('artist_appointments')
        .update({appointment_type:'completed'})
        .eq('id',currentApptId);
      if(error){
        console.error(error);
        alert('Error marking completed.');
        return;
      }
      apptModal.style.display='none';
      loadDay();
    });
    cancelApptBtn.addEventListener('click',()=>{
      apptModal.style.display='none';
    });

    /****************************************************************
     *  APPOINTMENTS TAB => store / artist / date range / checkboxes
     ****************************************************************/
    storeSelect.addEventListener('change',()=>{
      loadArtistDropdown(storeSelect.value);
      loadAppointmentsList();
    });
    artistSelect.addEventListener('change',loadAppointmentsList);
    startRange.addEventListener('change',loadAppointmentsList);
    endRange.addEventListener('change',loadAppointmentsList);
    showAppointments.addEventListener('change',loadAppointmentsList);
    showWalkins.addEventListener('change',loadAppointmentsList);

    async function loadStoreList(){
      storeSelect.innerHTML='<option value="">-- Select Store --</option>';
      const {data,error}=await supabase
        .from('locations')
        .select('*');
      if(error){console.error(error);return;}
      data.forEach(loc=>{
        const opt=document.createElement('option');
        opt.value=loc.id;
        opt.textContent=loc.location_name;
        storeSelect.appendChild(opt);
      });
    }
    async function loadArtistDropdown(storeId){
      artistSelect.innerHTML='<option value="">All Artists</option>';
      if(!storeId)return;
      const {data,error}=await supabase
        .from('artists')
        .select('id, artist_name')
        .eq('location_id',storeId);
      if(error){console.error(error);return;}
      data.forEach(art=>{
        const opt=document.createElement('option');
        opt.value=art.id;
        opt.textContent=art.artist_name;
        artistSelect.appendChild(opt);
      });
    }
    async function loadAppointmentsList(){
      apptTableBody.innerHTML='';

      const stVal=startRange.value;
      const enVal=endRange.value;
      let typeFilter=[];
      if(showAppointments.checked) typeFilter.push('appointment');
      if(showWalkins.checked) typeFilter.push('walk-in');

      // if no box is checked => empty
      if(typeFilter.length===0){
        // no results
        return;
      }

      let query=supabase
        .from('artist_appointments')
        .select(`
          id, date, start_time, end_time, appointment_type, 
          client_name, artist_id,
          artists!inner(artist_name, location_id)
        `)
        .in('appointment_type',typeFilter)
        .order('date',{ascending:false})
        .order('start_time',{ascending:false});
      
      if(stVal && enVal){
        if(enVal<stVal) return; // invalid range
        query=query.gte('date',stVal).lte('date',enVal);
      } else if(stVal){
        query=query.gte('date',stVal);
      } else if(enVal){
        query=query.lte('date',enVal);
      }
      if(storeSelect.value){
        query=query.eq('artists.location_id',storeSelect.value);
      }
      if(artistSelect.value){
        query=query.eq('artist_id',artistSelect.value);
      }

      const {data:appts,error}=await query;
      if(error){
        console.error(error);
        return;
      }
      // fill table
      appts.forEach(ap=>{
        const tr=document.createElement('tr');
        const dateTd=document.createElement('td');
        const timeTd=document.createElement('td');
        const artistTd=document.createElement('td');
        const clientTd=document.createElement('td');
        const typeTd=document.createElement('td');
        const statusTd=document.createElement('td'); // completed? or ???

        dateTd.textContent=ap.date;
        timeTd.textContent=`${ap.start_time||''} - ${ap.end_time||''}`;
        artistTd.textContent=ap.artists.artist_name||'N/A';
        clientTd.textContent=ap.client_name||'N/A';
        typeTd.textContent=ap.appointment_type;
        statusTd.textContent=(ap.appointment_type==='completed'?'Completed':'Incomplete');

        tr.appendChild(dateTd);
        tr.appendChild(timeTd);
        tr.appendChild(artistTd);
        tr.appendChild(clientTd);
        tr.appendChild(typeTd);
        tr.appendChild(statusTd);
        apptTableBody.appendChild(tr);
      });
    }

    /****************************************************************
     *  On Load
     ****************************************************************/
    window.addEventListener('DOMContentLoaded', async ()=>{
      checkAuth();
      // default tab => daily
      calendarTab.classList.add('active');
      calendarTabBtn.classList.add('active');
      // set daily date => today
      const todayStr=new Date().toISOString().split('T')[0];
      dailyDate.value=todayStr;
      await loadLocations();
      loadDay();
    });
  </script>
</body>
</html>
