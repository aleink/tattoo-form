<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calendar</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- ─── CSP ─── -->
<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
        connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
        style-src 'self' 'unsafe-inline';
        object-src 'none';
      ">

<!-- ─── THEME ─── -->
<style>
:root{
  --bg0:#111;--bg1:#000;--bg2:#222;
  --border:#444;--txt:#fff;--txt-dim:#bbb;
  --accent:#28a745;--danger:#f44336;--info:#1976d2;
}
body.light{
  --bg0:#f7f7f7;--bg1:#fff;--bg2:#e6e6e6;
  --border:#bbb;--txt:#000;--txt-dim:#444;
  --accent:#0d6efd;--danger:#d32f2f;--info:#0d6efd;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Helvetica Neue',Arial,sans-serif}
body{background:var(--bg0);color:var(--txt);max-width:1200px;margin:20px auto;padding:10px;transition:background .25s}

header{background:var(--bg1);border-bottom:2px solid var(--border);padding:20px;text-align:center}
header h1{margin:0;font-size:1.8rem;color:var(--txt)}

.top-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.top-bar div{display:flex;align-items:center;gap:12px}
button{border:none;border-radius:4px;padding:8px 16px;cursor:pointer;transition:background .2s}
.btn-info{background:var(--info);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-toggle{background:var(--bg2);color:var(--txt)}
button:hover{filter:brightness(1.1)}

select,input[type="date"],input[type="time"],input[type="text"],input[type="number"],input[type="email"],textarea{
  background:var(--bg2);color:var(--txt);border:1px solid var(--border);border-radius:4px;padding:6px
}
select option{color:#000}

.hidden{display:none}

/* scheduler */
#daily-scheduler{position:relative;height:960px;border:1px solid var(--border);overflow-y:auto;margin-top:10px;background:var(--bg2)}
.hour-line{position:absolute;left:0;width:100%;border-top:1px dashed var(--border);color:var(--txt-dim);font-size:12px;padding-left:5px}
.schedule-block{position:absolute;background:rgba(255,255,255,.05);color:var(--txt-dim);padding:2px;font-size:.75em;border-left:4px solid var(--accent);pointer-events:none}
.schedule-artist-name{display:block;margin-bottom:2px;font-weight:bold;color:var(--txt)}
.schedule-block.vac{background:rgba(128,128,128,.35);border-left-color:#888}
.appointment-block{position:absolute;background:var(--accent);color:#fff;border-radius:4px;padding:2px 4px;font-size:.85em;cursor:pointer;box-sizing:border-box}

/* modal */
#appt-modal{display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:var(--bg1);border:1px solid var(--border);padding:20px;width:320px;box-shadow:0 2px 10px rgba(0,0,0,.25);z-index:999}
#appt-modal h3{margin-top:0;margin-bottom:10px}
#appt-modal .modal-field{margin-bottom:10px}
#appt-modal .modal-buttons{text-align:right;margin-top:10px}
#appt-modal .modal-buttons button{margin-left:8px;background:var(--bg2);color:var(--txt)}

/* artist filter */
#artist-filter-container{margin-top:10px}
.artist-filter-item{display:inline-block;margin-right:10px}
.artist-filter-item label{margin-left:4px}

/* list */
#appointments-list-section{margin-top:20px;background:var(--bg1);border:1px solid var(--border);border-radius:6px;padding:15px}
#appointments-list-section h2{margin-bottom:10px}
.filters-row{display:flex;align-items:center;gap:15px;margin-bottom:10px;flex-wrap:wrap}
.appointments-container{max-height:300px;overflow-y:auto;border:1px solid var(--border);padding:10px}
.appt-item{background:var(--bg2);border:1px solid var(--border);padding:8px;border-radius:4px;margin-bottom:8px;cursor:pointer}
.appt-item h4{margin-bottom:3px;font-size:1rem;color:var(--txt)}
.appt-item p{margin-bottom:2px;font-size:.85rem;color:var(--txt-dim)}
</style>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
</head>
<body>

<header><h1>Calendar</h1></header>

<!-- ─── TOP BAR with logout & theme ─── -->
<div class="top-bar">
  <button class="btn-danger" id="logout-btn">Logout</button>
  <div>
    <button class="btn-toggle" id="theme-btn">Light&nbsp;mode</button>
    <button class="btn-info" id="today-btn">Today</button>
  </div>
</div>

<!-- ─── MAIN CONTROLS (rendered after auth) ─── -->
<div class="top-controls" id="controls-bar">
  <label>Location:
    <select id="location-filter"><option value="">-- Select Location --</option></select>
  </label>

  <label>Date:
    <input type="date" id="day-input">
  </label>
</div>

<!-- checkboxes -->
<div id="artist-filter-container"></div>

<!-- scheduler grid -->
<div id="daily-scheduler"></div>

<!-- ---------- APPOINTMENT MODAL ---------- -->
<div id="appt-modal">
  <h3 id="modal-title">New Appointment</h3>
  <div class="modal-field"><label>Start Time (5-min):</label><input type="time" id="modal-start-time" step="300"></div>
  <div class="modal-field"><label>End Time (5-min):</label><input type="time" id="modal-end-time" step="300"></div>
  <div class="modal-field"><label>Artist:</label><select id="modal-artist"></select></div>
  <div class="modal-field"><label>Client Name:</label><input type="text" id="modal-client-name"></div>
  <div class="modal-field"><label>Client Phone:</label><input type="text" id="modal-client-phone"></div>
  <div class="modal-field"><label>Client Email:</label><input type="email" id="modal-email"></div>
  <div class="modal-field"><label>Tattoo Description:</label><textarea id="modal-description"></textarea></div>
  <div class="modal-field"><label>Deposit:</label><input type="number" id="modal-deposit"></div>
  <div class="modal-field"><label>Price:</label><input type="number" id="modal-price"></div>
  <div class="modal-field"><label>Tip:</label><input type="number" id="modal-tip"></div>
  <div class="modal-field"><label>Appointment Type:</label>
    <select id="modal-appt-type">
      <option value="walk-in">Walk-in</option>
      <option value="appointment">Appointment</option>
      <option value="tentative">Tentative</option>
    </select>
  </div>
  <div class="modal-buttons">
    <button id="save-appt-btn">Save</button>
    <button id="cancel-appt-btn">Cancel</button>
    <button id="delete-appt-btn"   style="display:none">Delete</button>
    <button id="complete-appt-btn" style="display:none">Mark Completed</button>
  </div>
</div>

<!-- ---------- APPT LIST ---------- -->
<div id="appointments-list-section">
  <h2>Appointments &amp; Walk-ins</h2>
  <div class="filters-row">
    <label>From: <input type="date" id="range-start"></label>
    <label>To:&nbsp;&nbsp;<input type="date" id="range-end"></label>
    <label>Client search: <input type="text" id="client-search" placeholder="name / phone / email"></label>
    <div>
      <label><input type="checkbox" id="cb-appointments" checked> Appointments</label>
      <label><input type="checkbox" id="cb-walkins" checked> Walk-ins</label>
    </div>
  </div>
  <div class="appointments-container" id="appointments-list"></div>
</div>

<script>
/* ─── Supabase init ─── */
const supabase = window.supabase.createClient(
  'https://shlvjhipxnslrncczopn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
);

/* ─── AUTH GUARD ─── */
const role = localStorage.getItem('currentUserRole');
const loc  = localStorage.getItem('currentUserLoc') || '';
if(!role || !['gm','owner','sm','fd'].includes(role)){
  // AD has no access – redirect
  window.location.href = 'index.html';
}

/* ─── DOM refs (same as previous version) ─── */
const logoutBtn=document.getElementById('logout-btn');
const themeBtn =document.getElementById('theme-btn');
const todayBtn =document.getElementById('today-btn');

const locationFilter=document.getElementById('location-filter');
const dayInput      =document.getElementById('day-input');
const dailyScheduler=document.getElementById('daily-scheduler');
const artistFilterContainer=document.getElementById('artist-filter-container');
const modalArtist=document.getElementById('modal-artist');

const apptModal=document.getElementById('appt-modal');
const modalTitle=document.getElementById('modal-title');
const modalStart=document.getElementById('modal-start-time');
const modalEnd=document.getElementById('modal-end-time');
const modalClientName=document.getElementById('modal-client-name');
const modalClientPhone=document.getElementById('modal-client-phone');
const modalEmail=document.getElementById('modal-email');
const modalDesc=document.getElementById('modal-description');
const modalDeposit=document.getElementById('modal-deposit');
const modalPrice=document.getElementById('modal-price');
const modalTip=document.getElementById('modal-tip');
const modalType=document.getElementById('modal-appt-type');
const saveBtn=document.getElementById('save-appt-btn');
const cancelBtn=document.getElementById('cancel-appt-btn');
const deleteBtn=document.getElementById('delete-appt-btn');
const completeBtn=document.getElementById('complete-appt-btn');

const rangeStart=document.getElementById('range-start');
const rangeEnd  =document.getElementById('range-end');
const cbAppt=document.getElementById('cb-appointments');
const cbWalk=document.getElementById('cb-walkins');
const appointmentsList=document.getElementById('appointments-list');
const clientSearch=document.getElementById('client-search');

/* ─── Helpers ─── */
const toMinutes=t=>{if(!t)return 0;const[h,m]=t.split(':').map(Number);return h*60+m};
const overlaps =(a,b)=>a&&b&&(toMinutes(a.start_time)<toMinutes(b.end_time)&&toMinutes(b.start_time)<toMinutes(a.end_time));
const weekdayIndex=d=>{const[y,m,dd]=d.split('-').map(Number);return new Date(Date.UTC(y,m-1,dd)).getUTCDay()};
const todayISO =()=>{const off=parseInt(currentTZ||'0',10);const now=new Date(Date.now()+off*3600000);return now.toISOString().split('T')[0]};

/* ─── THEME toggle ─── */
(function(){
  if(localStorage.getItem('ui-theme')==='light'){
    document.body.classList.add('light');
    themeBtn.textContent='Dark mode';
  }
})();
themeBtn.onclick=()=>{
  const light=document.body.classList.toggle('light');
  themeBtn.textContent=light?'Dark mode':'Light mode';
  localStorage.setItem('ui-theme',light?'light':'dark');
};

/* ─── Logout ─── */
logoutBtn.onclick=()=>{
  localStorage.clear();
  window.location.href='index.html';
};

/* ─── STATE ─── */
let artistMap={}, currentApptId=null, currentTZ='0';

/* ─── INIT ─── */
document.addEventListener('DOMContentLoaded',async()=>{
  await loadLocations();
  dayInput.value=todayISO();
  await loadArtistsForLocation(locationFilter.value);
  setDefaultRange();
  loadDay();
  loadAppointmentsList();
});

/* ─── Top-bar actions ─── */
todayBtn.onclick=()=>{dayInput.value=todayISO();loadDay();};
dayInput.onchange=loadDay;
locationFilter.onchange=async()=>{await loadArtistsForLocation(locationFilter.value);loadDay();loadAppointmentsList();};
artistFilterContainer.addEventListener('change',()=>{loadDay();loadAppointmentsList();});
[rangeStart,rangeEnd,cbAppt,cbWalk].forEach(el=>el.addEventListener('change',loadAppointmentsList));
clientSearch.addEventListener('input',loadAppointmentsList);

/* ─── LOAD LOCATIONS ─── */
async function loadLocations(){
  const {data}=await supabase.from('locations').select('*');
  locationFilter.innerHTML='<option value="">-- Select Location --</option>';
  data?.forEach(l=>{
    const o=document.createElement('option');o.value=l.id;o.textContent=l.location_name;
    locationFilter.appendChild(o);
  });

  /* FD & SM restricted to their own location */
  if(role==='sm'||role==='fd'){
    locationFilter.value=loc;
    locationFilter.disabled=true;
  }
  setTZ();
}
function setTZ(){
  const sel = locationFilter.value;
  supabase.from('locations').select('timezone').eq('id',sel).single().then(({data})=>{
    currentTZ = data?.timezone||'0';
    // refresh 'today' if user switched location
    todayBtn.click();
  });
}

/* ─── LOAD ARTISTS ─── */
async function loadArtistsForLocation(locId){
  artistMap={};modalArtist.innerHTML='';artistFilterContainer.innerHTML='';
  if(!locId) return;
  const {data}=await supabase.from('artists').select('*').eq('location_id',locId);
  data?.sort((a,b)=>a.artist_name.localeCompare(b.artist_name)).forEach(a=>{
    artistMap[a.id]=a;
    const opt=document.createElement('option');opt.value=a.id;opt.textContent=a.artist_name;modalArtist.appendChild(opt);
    const wrap=document.createElement('div');wrap.className='artist-filter-item';
    const cb=document.createElement('input');cb.type='checkbox';cb.value=a.id;cb.checked=true;
    const lb=document.createElement('label');lb.textContent=a.artist_name;wrap.append(cb,lb);
    artistFilterContainer.appendChild(wrap);
  });
}
const filteredIds=()=>[...artistFilterContainer.querySelectorAll('input[type=checkbox]')].filter(cb=>cb.checked).map(cb=>cb.value);

/* ─── DAILY VIEW ─── */
async function loadDay(){ /* identical to previous implementation – omitted for brevity */ }

/* ─── MODAL CRUD + LIST LOADING (same as before) ─── */
/* ...  (keep existing code unchanged) ... */

</script>
</body>
</html>
