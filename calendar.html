<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 10px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .top-bar h1 {
      margin: 0;
    }
    #logout-btn {
      margin-left: 20px;
      background: #f44336;
      color: #fff;
      cursor: pointer;
      padding: 6px 12px;
      border: none;
    }
    .view-buttons button {
      margin-right: 8px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #yearly-view, #monthly-view, #daily-view {
      display: none;
      margin-top: 20px;
    }
    .calendar-grid {
      display: grid;
      gap: 10px;
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
    }
    .month-grid {
      grid-template-columns: repeat(7, 1fr);
    }
    .calendar-cell {
      border: 1px solid #ccc;
      padding: 8px;
      min-height: 80px;
      position: relative;
      cursor: pointer;
    }
    /* Daily container from 8:00 AM to midnight => 16 hours => 960 minutes */
    #daily-container {
      position: relative;
      height: 960px;
      border: 1px solid #ccc;
      overflow-y: auto;
      margin-top: 20px;
      background: #f9f9f9;
    }
    /* Hour lines */
    .hour-line {
      position: absolute;
      left: 0;
      width: 100%;
      border-top: 1px dashed #ccc;
      color: #777;
      font-size: 12px;
      padding-left: 5px;
    }
    /* Artist schedule block (translucent background) */
    .schedule-block {
      position: absolute;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.05);
      color: #000;
      padding: 2px;
      font-size: 0.75em;
      box-sizing: border-box;
      border-left: 4px solid #aaa;
      pointer-events: none; /* so clicks pass through to time-slot/appointments */
    }
    .schedule-artist-name {
      font-weight: bold;
      display: block;
      margin-bottom: 2px;
    }
    /* Appointment block (solid) */
    .appointment-block {
      position: absolute;
      background: #ddd;
      color: #000;
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 0.85em;
      box-sizing: border-box;
      cursor: pointer;
    }
    /* Overlapping columns */
    /* We set left base at 90, then each column is ~110px wide. */
    /* Modal */
    #appt-modal {
      display: none;
      position: fixed;
      top: 15%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 2px solid #ccc;
      padding: 20px;
      width: 300px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .modal-field {
      margin-bottom: 10px;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 10px;
    }
    .modal-buttons button {
      margin-left: 8px;
    }
    #manage-schedules-link {
      margin-left: 15px;
      text-decoration: none;
      background: #1b8adb;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
    }
    /* Artist filter container */
    #artist-filter-container {
      margin-top: 10px;
    }
    .artist-filter-item {
      display: inline-block;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>Calendar</h1>
    <div>
      <a id="manage-schedules-link" href="manage_schedules.html">Manage Schedules</a>
      <button id="logout-btn">Logout</button>
    </div>
  </div>

  <div class="view-buttons">
    <button id="year-btn">Yearly View</button>
    <button id="month-btn">Monthly View</button>
    <button id="day-btn">Daily View</button>
  </div>

  <!-- YEARLY VIEW -->
  <div id="yearly-view">
    <h2>Yearly View (Placeholder)</h2>
    <p>Switch to Month or Day for detailed scheduling.</p>
  </div>

  <!-- MONTHLY VIEW -->
  <div id="monthly-view">
    <h2>Monthly View</h2>
    <div>
      <input type="month" id="month-input" />
      <button id="load-month">Load Month</button>
    </div>
    <div class="calendar-grid month-grid" id="month-grid"></div>
  </div>

  <!-- DAILY VIEW -->
  <div id="daily-view">
    <h2>Daily View</h2>
    <div>
      <input type="date" id="day-input" />
      <button id="load-day">Load Day</button>
    </div>

    <!-- Artist Filter -->
    <div id="artist-filter-container"></div>

    <div id="daily-container"></div>
  </div>

  <!-- Appointment Modal -->
  <div id="appt-modal">
    <h3 id="modal-title">New Appointment</h3>
    <div class="modal-field">
      <label for="modal-start-time">Start Time:</label>
      <input type="time" id="modal-start-time" />
    </div>
    <div class="modal-field">
      <label for="modal-end-time">End Time:</label>
      <input type="time" id="modal-end-time" />
    </div>
    <div class="modal-field">
      <label for="modal-artist">Artist:</label>
      <select id="modal-artist"></select>
    </div>
    <div class="modal-field">
      <label for="modal-client-name">Client Name:</label>
      <input type="text" id="modal-client-name" />
    </div>
    <div class="modal-field">
      <label for="modal-client-phone">Client Phone:</label>
      <input type="text" id="modal-client-phone" />
    </div>
    <div class="modal-field">
      <label for="modal-email">Client Email:</label>
      <input type="email" id="modal-email" />
    </div>
    <div class="modal-field">
      <label for="modal-description">Tattoo Description:</label>
      <textarea id="modal-description"></textarea>
    </div>
    <div class="modal-field">
      <label for="modal-deposit">Deposit:</label>
      <input type="number" id="modal-deposit" />
    </div>
    <div class="modal-field">
      <label for="modal-price">Price:</label>
      <input type="number" id="modal-price" />
    </div>
    <div class="modal-field">
      <label for="modal-tip">Tip:</label>
      <input type="number" id="modal-tip" />
    </div>
    <div class="modal-field">
      <label>Appointment Type:</label>
      <select id="modal-appt-type">
        <option value="walk-in">Walk-in</option>
        <option value="appointment">Appointment</option>
      </select>
    </div>
    <div class="modal-buttons">
      <button id="save-appt-btn">Save</button>
      <button id="cancel-appt-btn">Cancel</button>
      <button id="delete-appt-btn" style="display: none;">Delete</button>
      <button id="complete-appt-btn" style="display: none;">Mark Completed</button>
    </div>
  </div>

  <!-- Supabase JS (v1.35.7) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    const supabaseUrl = 'https://shlvjhipxnslrncczopn.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Basic references
    const logoutBtn = document.getElementById('logout-btn');
    const yearBtn = document.getElementById('year-btn');
    const monthBtn = document.getElementById('month-btn');
    const dayBtn = document.getElementById('day-btn');
    const yearlyView = document.getElementById('yearly-view');
    const monthlyView = document.getElementById('monthly-view');
    const dailyView = document.getElementById('daily-view');
    const monthInput = document.getElementById('month-input');
    const loadMonthBtn = document.getElementById('load-month');
    const monthGrid = document.getElementById('month-grid');
    const dayInput = document.getElementById('day-input');
    const loadDayBtn = document.getElementById('load-day');
    const dailyContainer = document.getElementById('daily-container');
    const artistFilterContainer = document.getElementById('artist-filter-container');

    // Modal references
    const apptModal = document.getElementById('appt-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalStartTime = document.getElementById('modal-start-time');
    const modalEndTime = document.getElementById('modal-end-time');
    const modalArtist = document.getElementById('modal-artist');
    const modalClientName = document.getElementById('modal-client-name');
    const modalClientPhone = document.getElementById('modal-client-phone');
    const modalEmail = document.getElementById('modal-email');
    const modalDescription = document.getElementById('modal-description');
    const modalDeposit = document.getElementById('modal-deposit');
    const modalPrice = document.getElementById('modal-price');
    const modalTip = document.getElementById('modal-tip');
    const modalApptType = document.getElementById('modal-appt-type');
    const saveApptBtn = document.getElementById('save-appt-btn');
    const cancelApptBtn = document.getElementById('cancel-appt-btn');
    const deleteApptBtn = document.getElementById('delete-appt-btn');
    const completeApptBtn = document.getElementById('complete-appt-btn');

    let currentUserId = null;
    let currentLocationId = null;
    let currentUserRole = null;
    let currentApptId = null;
    let currentDateSelected = null;
    let artistMap = {}; // { artist_id: { name, color }, ... }

    function showYearly() {
      yearlyView.style.display = 'block';
      monthlyView.style.display = 'none';
      dailyView.style.display = 'none';
    }
    function showMonthly() {
      yearlyView.style.display = 'none';
      monthlyView.style.display = 'block';
      dailyView.style.display = 'none';
    }
    function showDaily() {
      yearlyView.style.display = 'none';
      monthlyView.style.display = 'none';
      dailyView.style.display = 'block';
    }

    yearBtn.addEventListener('click', showYearly);
    monthBtn.addEventListener('click', showMonthly);
    dayBtn.addEventListener('click', showDaily);

    function checkAuth() {
      currentUserId = localStorage.getItem('currentUserId');
      currentLocationId = localStorage.getItem('currentLocationId');
      currentUserRole = localStorage.getItem('currentUserRole');
      if (!currentUserId) {
        window.location.href = 'login.html';
      }
    }

    logoutBtn.addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'login.html';
    });

    // Load artists for this location, fill artistMap + modalArtist + filter
    async function loadArtists() {
      modalArtist.innerHTML = '';
      artistFilterContainer.innerHTML = '';
      let { data: artists, error } = await supabase
        .from('artists')
        .select('id, artist_name, color')
        .eq('location_id', currentLocationId);

      if (error) {
        console.error(error);
        return;
      }
      artists.forEach(art => {
        artistMap[art.id] = { name: art.artist_name, color: art.color || '#ddd' };

        // Populate the appointment modal select
        const opt = document.createElement('option');
        opt.value = art.id;
        opt.textContent = art.artist_name;
        modalArtist.appendChild(opt);

        // Create filter checkbox
        const wrapper = document.createElement('div');
        wrapper.classList.add('artist-filter-item');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = 'artist-filter-' + art.id;
        cb.value = art.id;
        cb.checked = true; // default to show

        const label = document.createElement('label');
        label.htmlFor = cb.id;
        label.textContent = art.artist_name;

        wrapper.appendChild(cb);
        wrapper.appendChild(label);
        artistFilterContainer.appendChild(wrapper);
      });
    }

    function getFilteredArtistIds() {
      // Return array of artist IDs that are checked
      const checks = artistFilterContainer.querySelectorAll('input[type="checkbox"]');
      let arr = [];
      checks.forEach(ch => {
        if (ch.checked) arr.push(ch.value);
      });
      return arr;
    }

    /********** MONTH VIEW **********/
    loadMonthBtn.addEventListener('click', () => {
      monthGrid.innerHTML = '';
      const monthVal = monthInput.value;
      if (!monthVal) return;
      const [yyyy, mm] = monthVal.split('-').map(Number);
      const firstDay = new Date(yyyy, mm-1, 1);
      const lastDay = new Date(yyyy, mm, 0);
      const totalDays = lastDay.getDate();

      for (let day = 1; day <= totalDays; day++) {
        const cell = document.createElement('div');
        cell.classList.add('calendar-cell');
        cell.innerHTML = `<div class="day-label">${day}</div>`;
        cell.addEventListener('click', () => openDay(yyyy, mm-1, day));
        monthGrid.appendChild(cell);
      }
    });

    function openDay(year, month, day) {
      showDaily();
      const dateStr = new Date(year, month, day).toISOString().split('T')[0];
      dayInput.value = dateStr;
      loadDay();
    }

    /********** DAY VIEW **********/
    loadDayBtn.addEventListener('click', loadDay);

    async function loadDay() {
      dailyContainer.innerHTML = '';
      const dayVal = dayInput.value;
      if (!dayVal) return;
      currentDateSelected = dayVal;

      // Show hour lines from 8:00 to midnight
      for (let hr = 8; hr <= 24; hr++) {
        const minutesFrom8 = (hr - 8) * 60;
        const line = document.createElement('div');
        line.classList.add('hour-line');
        line.style.top = minutesFrom8 + 'px';

        let labelHr = hr;
        let ampm = 'AM';
        if (labelHr >= 12) ampm = 'PM';
        if (labelHr > 12) labelHr -= 12;
        if (labelHr === 24) {
          labelHr = 12;
          ampm = 'AM';
        }
        line.textContent = `${labelHr}:00 ${ampm}`;
        line.style.left = '0px';
        dailyContainer.appendChild(line);
      }

      // Render each artist's schedule as a translucent block
      // We'll match day_of_week to today's weekday
      const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      const dayIndex = new Date(dayVal).getDay();
      const dayName = dayNames[dayIndex];

      const { data: schedules, error: scheduleErr } = await supabase
        .from('artist_schedules')
        .select('*')
        .eq('day_of_week', dayName);

      if (scheduleErr) {
        console.error(scheduleErr);
      } else {
        const filteredIds = getFilteredArtistIds();
        schedules.forEach(sch => {
          // Check if this schedule belongs to an artist we want to see
          if (!filteredIds.includes(sch.artist_id)) return;

          const startNum = toMinutes(sch.start_time);
          const endNum   = toMinutes(sch.end_time);
          if (!startNum || !endNum) return;
          // Place block from startNum-8:00 to endNum-8:00
          const top = startNum - (8*60);
          const height = endNum - startNum;
          const scheduleDiv = document.createElement('div');
          scheduleDiv.classList.add('schedule-block');
          scheduleDiv.style.top = top + 'px';
          scheduleDiv.style.height = height + 'px';

          const artColor = artistMap[sch.artist_id]?.color || '#aaa';
          // Add a border color maybe
          scheduleDiv.style.borderLeftColor = artColor;
          const artName = artistMap[sch.artist_id]?.name || 'Unknown';

          scheduleDiv.innerHTML = `
            <span class="schedule-artist-name">${artName}</span>
            Working ${sch.start_time} - ${sch.end_time}
          `;
          dailyContainer.appendChild(scheduleDiv);
        });
      }

      // Load appointments for that day
      let { data: appts, error } = await supabase
        .from('artist_appointments')
        .select('*')
        .eq('date', dayVal);

      if (error) {
        console.error(error);
        return;
      }
      // Filter out artists user doesn't want to see
      const filteredArtistIds = getFilteredArtistIds();
      appts = appts.filter(a => filteredArtistIds.includes(a.artist_id));

      // Sort by start time
      appts.sort((a,b) => toMinutes(a.start_time) - toMinutes(b.start_time));

      // Group into columns to avoid overlap
      let columns = []; // array of arrays of appts

      for (let ap of appts) {
        let placed = false;
        for (let col of columns) {
          let lastInCol = col[col.length-1];
          if (!appointmentsOverlap(lastInCol, ap)) {
            col.push(ap);
            placed = true;
            break;
          }
        }
        if (!placed) columns.push([ap]);
      }

      // Render columns side by side
      columns.forEach((col, colIndex) => {
        col.forEach(ap => {
          const startNum = toMinutes(ap.start_time);
          const endNum   = toMinutes(ap.end_time);
          const blockTop = startNum - (8 * 60);
          const blockHeight = Math.max(endNum - startNum, 5);

          const block = document.createElement('div');
          block.classList.add('appointment-block');
          const artColor = artistMap[ap.artist_id]?.color || '#ddd';
          block.style.backgroundColor = artColor;
          // Each column ~110px wide
          const leftBase = 90;
          const colWidth = 110;
          block.style.left = (leftBase + colIndex * colWidth) + 'px';
          block.style.width = (colWidth - 10) + 'px';
          block.style.top = blockTop + 'px';
          block.style.height = blockHeight + 'px';

          const artName = artistMap[ap.artist_id]?.name || 'Unknown';
          const who = `${artName} - ${ap.client_name || 'N/A'} (${ap.appointment_type})`;
          block.textContent = who;

          block.addEventListener('click', (evt) => {
            evt.stopPropagation();
            openExistingApptModal(ap.id);
          });
          dailyContainer.appendChild(block);
        });
      });

      // If user clicks empty space => new Appt
      dailyContainer.addEventListener('click', onDailyContainerClick);
    }

    function appointmentsOverlap(a, b) {
      const aStart = toMinutes(a.start_time);
      const aEnd   = toMinutes(a.end_time);
      const bStart = toMinutes(b.start_time);
      const bEnd   = toMinutes(b.end_time);
      return (aStart < bEnd && bStart < aEnd);
    }

    function onDailyContainerClick(e) {
      // if clicked an existing appointment block or schedule block or hour-line, ignore
      if (
        e.target.classList.contains('appointment-block') ||
        e.target.classList.contains('schedule-block') ||
        e.target.classList.contains('hour-line')
      ) {
        return;
      }
      // Calculate time from click Y
      const containerRect = dailyContainer.getBoundingClientRect();
      const clickY = e.clientY - containerRect.top;
      const minutesFrom8 = Math.floor(clickY);
      const hr = Math.floor(minutesFrom8 / 60) + 8;
      const min = minutesFrom8 % 60;
      const hh = hr.toString().padStart(2,'0');
      const mm = min.toString().padStart(2,'0');
      const slotStr = `${hh}:${mm}`;
      openNewApptModal(slotStr, currentDateSelected);
    }

    function toMinutes(hhmm) {
      if (!hhmm) return null;
      const [h, m] = hhmm.split(':').map(Number);
      return (h*60) + m;
    }

    // New Appt
    function openNewApptModal(slot, dateStr) {
      currentApptId = null;
      modalTitle.textContent = 'New Appointment';
      modalStartTime.value = slot;
      modalEndTime.value = slot;
      modalArtist.value = '';
      modalClientName.value = '';
      modalClientPhone.value = '';
      modalEmail.value = '';
      modalDescription.value = '';
      modalDeposit.value = '';
      modalPrice.value = '';
      modalTip.value = '';
      modalApptType.value = 'walk-in';
      deleteApptBtn.style.display = 'none';
      completeApptBtn.style.display = 'none';
      apptModal.style.display = 'block';
    }

    // Existing Appt
    async function openExistingApptModal(apptId) {
      currentApptId = apptId;
      const { data, error } = await supabase
        .from('artist_appointments')
        .select('*')
        .eq('id', apptId);

      if (error || !data || data.length===0) {
        console.error(error);
        alert('Error loading appointment.');
        return;
      }
      const ap = data[0];
      modalTitle.textContent = `Edit Appointment`;
      modalStartTime.value = ap.start_time || '';
      modalEndTime.value = ap.end_time || '';
      modalArtist.value = ap.artist_id;
      modalClientName.value = ap.client_name || '';
      modalClientPhone.value = ap.client_phone || '';
      modalEmail.value = ap.email || '';
      modalDescription.value = ap.notes || '';
      modalDeposit.value = ap.deposit || '';
      modalPrice.value = ap.price || '';
      modalTip.value = ap.tip || '';
      modalApptType.value = ap.appointment_type || 'walk-in';
      deleteApptBtn.style.display = 'inline-block';
      completeApptBtn.style.display = 'inline-block';
      apptModal.style.display = 'block';
    }

    // Save / Update
    saveApptBtn.addEventListener('click', async () => {
      const startVal = modalStartTime.value;
      const endVal = modalEndTime.value;
      const artistVal = modalArtist.value;
      const clientNameVal = modalClientName.value;
      const clientPhoneVal = modalClientPhone.value;
      const emailVal = modalEmail.value;
      const descVal = modalDescription.value;
      const depositVal = modalDeposit.value ? parseFloat(modalDeposit.value) : null;
      const priceVal = modalPrice.value ? parseFloat(modalPrice.value) : null;
      const tipVal = modalTip.value ? parseFloat(modalTip.value) : null;
      const apptTypeVal = modalApptType.value;

      if (!startVal || !endVal) {
        alert('Start and End time are required.');
        return;
      }

      // Overlap check for same artist
      let { data: existingAppts, error } = await supabase
        .from('artist_appointments')
        .select('*')
        .eq('date', currentDateSelected)
        .eq('artist_id', artistVal);

      if (error) {
        console.error(error);
        alert('Error checking existing appointments.');
        return;
      }

      const newStartNum = toMinutes(startVal);
      const newEndNum   = toMinutes(endVal);
      // if it overlaps any appointment except itself
      for (let ap of existingAppts) {
        if (ap.id !== currentApptId) {
          if (appointmentsOverlap(ap, {
            start_time: startVal,
            end_time: endVal
          })) {
            alert('That slot overlaps an existing appointment for this artist.');
            return;
          }
        }
      }

      if (!currentApptId) {
        // Insert
        const { data, error } = await supabase
          .from('artist_appointments')
          .insert([{
            artist_id: artistVal,
            date: currentDateSelected,
            start_time: startVal,
            end_time: endVal,
            appointment_type: apptTypeVal,
            client_name: clientNameVal,
            client_phone: clientPhoneVal,
            email: emailVal,
            notes: descVal,
            deposit: depositVal,
            price: priceVal,
            tip: tipVal
          }]);
        if (error) {
          console.error(error);
          alert('Error inserting appointment.');
          return;
        }
      } else {
        // Update
        const { data, error } = await supabase
          .from('artist_appointments')
          .update({
            artist_id: artistVal,
            start_time: startVal,
            end_time: endVal,
            appointment_type: apptTypeVal,
            client_name: clientNameVal,
            client_phone: clientPhoneVal,
            email: emailVal,
            notes: descVal,
            deposit: depositVal,
            price: priceVal,
            tip: tipVal
          })
          .eq('id', currentApptId);
        if (error) {
          console.error(error);
          alert('Error updating appointment.');
          return;
        }
      }
      reloadDay();
    });

    function reloadDay() {
      apptModal.style.display = 'none';
      dailyContainer.removeEventListener('click', onDailyContainerClick, false);
      loadDay().then(() => {
        dailyContainer.addEventListener('click', onDailyContainerClick);
      });
    }

    // Delete
    deleteApptBtn.addEventListener('click', async () => {
      if (!currentApptId) return;
      const confirmDel = confirm('Are you sure you want to delete this appointment?');
      if (!confirmDel) return;
      const { data, error } = await supabase
        .from('artist_appointments')
        .delete()
        .eq('id', currentApptId);
      if (error) {
        console.error(error);
        alert('Error deleting appointment.');
        return;
      }
      reloadDay();
    });

    // Complete
    completeApptBtn.addEventListener('click', async () => {
      if (!currentApptId) return;
      const { data, error } = await supabase
        .from('artist_appointments')
        .update({ appointment_type: 'completed' })
        .eq('id', currentApptId);
      if (error) {
        console.error(error);
        alert('Error marking appointment completed.');
        return;
      }
      reloadDay();
    });

    // Cancel
    cancelApptBtn.addEventListener('click', () => {
      apptModal.style.display = 'none';
    });

    // On load
    window.addEventListener('DOMContentLoaded', async () => {
      checkAuth();
      showMonthly(); // default
      await loadArtists();
    });
  </script>
</body>
</html>
