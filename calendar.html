<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 
    Content-Security-Policy for production:
      - 'unsafe-eval' so Supabase can function
      - connect-src includes your Supabase domain
  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    /* Dark style reminiscent of your payroll/artist portal */
    * {
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #111;
      color: #fff;
      min-height: 100vh;
      max-width: 1200px;
      margin: 20px auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #000;
      border-bottom: 2px solid #444;
      padding: 20px;
      text-align: center;
      margin-bottom: 10px;
    }
    header h1 {
      font-size: 1.8rem;
      color: #fff;
      margin: 0;
    }
    main {
      flex: 1;
    }
    .top-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    #logout-btn {
      background: #f44336;
      color: #fff;
      cursor: pointer;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
      color: #ccc;
    }
    select, input[type="date"] {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px;
      margin-bottom: 5px;
    }
    /* Monthly Calendar */
    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .calendar-nav button {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
    }
    .calendar-nav button:hover {
      background: #444;
    }
    .calendar-month-label {
      font-weight: bold;
      font-size: 1rem;
      text-align: center;
    }
    .month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      border: 1px solid #444;
      padding: 6px;
      margin-bottom: 20px;
    }
    .calendar-cell {
      background: #222;
      border: 1px solid #444;
      min-height: 80px;
      padding: 4px;
      cursor: pointer;
      position: relative;
    }
    .calendar-cell:hover {
      background: #333;
    }
    .day-label {
      font-size: 0.9rem;
      margin-bottom: 4px;
      color: #fff;
    }
    .artist-filter-container {
      margin-top: 5px;
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .artist-filter-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .artist-filter-item label {
      margin: 0;
      font-weight: normal;
      color: #ccc;
    }
    /* Appointment Modal (unchanged) */
    #appt-modal {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      border: 2px solid #444;
      padding: 20px;
      width: 320px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.6);
      color: #fff;
      border-radius: 6px;
    }
    #appt-modal h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    .modal-field {
      margin-bottom: 10px;
    }
    .modal-field label {
      color: #ccc;
    }
    .modal-field input, .modal-field select, .modal-field textarea {
      width: 100%;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px;
      box-sizing: border-box;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 10px;
    }
    .modal-buttons button {
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px 10px;
      margin-left: 8px;
      cursor: pointer;
    }
    .modal-buttons button:hover {
      background: #444;
    }
    /* New “Appointments Box” */
    .appointments-box {
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .appointments-box h2 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    .appointments-filters {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .appointments-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 10px;
    }
    .appt-item {
      margin-bottom: 8px;
      background: #333;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 8px;
    }
    .appt-item h4 {
      margin-bottom: 4px;
      font-size: 1rem;
      color: #fff;
    }
    .appt-item p {
      margin-bottom: 2px;
      color: #ccc;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Calendar</h1>
  </header>
  <main>
    <!-- Top Row: location, logout, etc. -->
    <div class="top-controls">
      <label for="location-filter">Location:</label>
      <select id="location-filter">
        <option value="">-- Select Location --</option>
      </select>

      <button id="logout-btn">Logout</button>
    </div>

    <!-- Artist Filter -->
    <div class="artist-filter-container" id="artist-filter-container"></div>

    <!-- Monthly Calendar -->
    <div class="calendar-nav">
      <button id="prev-month-btn"><< Prev</button>
      <span id="month-label" class="calendar-month-label"></span>
      <button id="next-month-btn">Next >></button>
    </div>
    <div class="month-grid" id="month-grid"></div>

    <!-- Appointment Modal -->
    <div id="appt-modal">
      <h3 id="modal-title">New Appointment</h3>

      <div class="modal-field">
        <label for="modal-start-time">Start Time:</label>
        <input type="time" id="modal-start-time" />
      </div>
      <div class="modal-field">
        <label for="modal-end-time">End Time:</label>
        <input type="time" id="modal-end-time" />
      </div>
      <div class="modal-field">
        <label for="modal-artist">Artist:</label>
        <select id="modal-artist" title="Appointment Artist"></select>
      </div>
      <div class="modal-field">
        <label for="modal-client-name">Client Name:</label>
        <input type="text" id="modal-client-name" />
      </div>
      <div class="modal-field">
        <label for="modal-client-phone">Client Phone:</label>
        <input type="text" id="modal-client-phone" />
      </div>
      <div class="modal-field">
        <label for="modal-email">Client Email:</label>
        <input type="email" id="modal-email" />
      </div>
      <div class="modal-field">
        <label for="modal-description">Tattoo Description:</label>
        <textarea id="modal-description"></textarea>
      </div>
      <div class="modal-field">
        <label for="modal-deposit">Deposit:</label>
        <input type="number" id="modal-deposit" />
      </div>
      <div class="modal-field">
        <label for="modal-price">Price:</label>
        <input type="number" id="modal-price" />
      </div>
      <div class="modal-field">
        <label for="modal-tip">Tip:</label>
        <input type="number" id="modal-tip" />
      </div>
      <div class="modal-field">
        <label for="modal-appt-type">Appointment Type:</label>
        <select id="modal-appt-type" title="Appointment Type">
          <option value="walk-in">Walk-in</option>
          <option value="appointment">Appointment</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button id="save-appt-btn">Save</button>
        <button id="cancel-appt-btn">Cancel</button>
        <button id="delete-appt-btn" style="display: none;">Delete</button>
        <button id="complete-appt-btn" style="display: none;">Mark Completed</button>
      </div>
    </div>

    <!-- Box for appointments (past/upcoming) with date range + checkboxes for type -->
    <div class="appointments-box">
      <h2>Appointments</h2>
      <div class="appointments-filters">
        <label for="appts-start">Start Date:</label>
        <input type="date" id="appts-start" />

        <label for="appts-end">End Date:</label>
        <input type="date" id="appts-end" />

        <div>
          <input type="checkbox" id="check-appointment" value="appointment" checked />
          <label for="check-appointment">Appointments</label>
        </div>
        <div>
          <input type="checkbox" id="check-walkin" value="walk-in" checked />
          <label for="check-walkin">Walk-ins</label>
        </div>
      </div>
      <div class="appointments-list" id="appointments-list">
        <!-- we’ll fill with a list of appt items -->
      </div>
    </div>
  </main>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    /***************************************
     * AUTH + SUPABASE INIT
     ***************************************/
    function checkAuth(){
      const userId = localStorage.getItem('currentUserId');
      if(!userId) {
        window.location.href='login.html';
      }
    }
    const supabaseUrl='https://shlvjhipxnslrncczopn.supabase.co';
    const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase=window.supabase.createClient(supabaseUrl,supabaseKey);

    /***************************************
     * DOM REFS
     ***************************************/
    const logoutBtn=document.getElementById('logout-btn');
    const locationFilter=document.getElementById('location-filter');

    const prevMonthBtn=document.getElementById('prev-month-btn');
    const nextMonthBtn=document.getElementById('next-month-btn');
    const monthLabel=document.getElementById('month-label');
    const monthGrid=document.getElementById('month-grid');

    // Appt modal
    const apptModal=document.getElementById('appt-modal');
    const modalTitle=document.getElementById('modal-title');
    const modalStartTime=document.getElementById('modal-start-time');
    const modalEndTime=document.getElementById('modal-end-time');
    const modalArtist=document.getElementById('modal-artist');
    const modalClientName=document.getElementById('modal-client-name');
    const modalClientPhone=document.getElementById('modal-client-phone');
    const modalEmail=document.getElementById('modal-email');
    const modalDescription=document.getElementById('modal-description');
    const modalDeposit=document.getElementById('modal-deposit');
    const modalPrice=document.getElementById('modal-price');
    const modalTip=document.getElementById('modal-tip');
    const modalApptType=document.getElementById('modal-appt-type');
    const saveApptBtn=document.getElementById('save-appt-btn');
    const cancelApptBtn=document.getElementById('cancel-appt-btn');
    const deleteApptBtn=document.getElementById('delete-appt-btn');
    const completeApptBtn=document.getElementById('complete-appt-btn');

    // Artist filter
    const artistFilterContainer=document.getElementById('artist-filter-container');

    // Appts bottom box
    const apptsStart=document.getElementById('appts-start');
    const apptsEnd=document.getElementById('appts-end');
    const checkAppointment=document.getElementById('check-appointment');
    const checkWalkin=document.getElementById('check-walkin');
    const appointmentsList=document.getElementById('appointments-list');

    /***************************************
     * STATE
     ***************************************/
    let currentMonth = { year:0, month:0 };
    let artistMap={};
    let currentApptId=null;

    /***************************************
     * LOGOUT
     ***************************************/
    logoutBtn.addEventListener('click',()=>{
      localStorage.clear();
      window.location.href='login.html';
    });

    /***************************************
     * LOCATION + ARTISTS
     ***************************************/
    async function loadLocations(){
      const {data,error} = await supabase
        .from('locations')
        .select('*');
      if(error){console.error(error);return;}
      locationFilter.innerHTML='<option value="">-- Select Location --</option>';
      data.forEach(loc=>{
        const opt=document.createElement('option');
        opt.value=loc.id;
        opt.textContent=loc.location_name;
        locationFilter.appendChild(opt);
      });
    }
    locationFilter.addEventListener('change', ()=>{
      loadArtistsForLocation(locationFilter.value);
      // Also refresh the monthly calendar and the bottom appointments
      initMonth(new Date()); 
      loadAppointmentsBox();
    });

    async function loadArtistsForLocation(locId){
      artistMap={};
      modalArtist.innerHTML='';
      artistFilterContainer.innerHTML='';
      if(!locId)return;
      let {data,error}=await supabase
        .from('artists')
        .select('id, artist_name, color')
        .eq('location_id', locId);
      if(error){
        console.error(error);
        return;
      }
      data.sort((a,b)=>a.artist_name.localeCompare(b.artist_name));
      data.forEach(art=>{
        artistMap[art.id] = art;
        // Appt modal select
        const opt=document.createElement('option');
        opt.value=art.id;
        opt.textContent=art.artist_name;
        modalArtist.appendChild(opt);

        // top filter checkboxes
        const wrapper=document.createElement('div');
        wrapper.classList.add('artist-filter-item');
        const cb=document.createElement('input');
        cb.type='checkbox';
        cb.id='artist-filter-'+art.id;
        cb.value=art.id;
        cb.checked=true;
        const lbl=document.createElement('label');
        lbl.htmlFor=cb.id;
        lbl.textContent=art.artist_name;
        wrapper.appendChild(cb);
        wrapper.appendChild(lbl);
        artistFilterContainer.appendChild(wrapper);
      });
      // after we load new artists, reload the monthly cal & bottom list
      drawMonth();
      loadAppointmentsBox();
    }
    function getFilteredArtistIds(){
      const cbs=artistFilterContainer.querySelectorAll('input[type=checkbox]');
      let arr=[];
      cbs.forEach(cb=>{
        if(cb.checked) arr.push(cb.value);
      });
      return arr;
    }

    /***************************************
     * MONTHLY CALENDAR
     ***************************************/
    prevMonthBtn.addEventListener('click',()=>{
      currentMonth.month--;
      if(currentMonth.month<1){
        currentMonth.month=12;
        currentMonth.year--;
      }
      drawMonth();
    });
    nextMonthBtn.addEventListener('click',()=>{
      currentMonth.month++;
      if(currentMonth.month>12){
        currentMonth.month=1;
        currentMonth.year++;
      }
      drawMonth();
    });

    function initMonth(dateObj){
      currentMonth.year=dateObj.getFullYear();
      currentMonth.month=dateObj.getMonth()+1;
      drawMonth();
    }

    async function drawMonth(){
      monthGrid.innerHTML='';
      // label
      monthLabel.textContent= monthName(currentMonth.month) +' '+ currentMonth.year;

      const firstDate=new Date(currentMonth.year, currentMonth.month-1,1);
      const firstDayIndex=firstDate.getDay();
      const lastDate=new Date(currentMonth.year, currentMonth.month,0).getDate();

      // get all appointments for location + filtered artists, for the entire month
      const locationVal=locationFilter.value;
      if(!locationVal)return;

      const filteredArtistIds=getFilteredArtistIds();
      if(filteredArtistIds.length===0)return;

      const startStr=`${currentMonth.year}-${String(currentMonth.month).padStart(2,'0')}-01`;
      const endStr=`${currentMonth.year}-${String(currentMonth.month).padStart(2,'0')}-${lastDate}`;

      let {data:appts,error}=await supabase
        .from('artist_appointments')
        .select('artist_id,date')
        .gte('date',startStr)
        .lte('date',endStr);
      if(error){
        console.error(error);
        return;
      }
      // filter by artist + location
      appts=appts.filter(ap=> filteredArtistIds.includes(ap.artist_id));

      // collect days with appts
      let daysWithAppts={};
      appts.forEach(ap=>{
        const dNum=parseInt(ap.date.split('-')[2],10);
        daysWithAppts[dNum]=true;
      });

      // fill blank cells for offset
      for(let i=0; i<firstDayIndex;i++){
        const c=document.createElement('div');
        c.classList.add('calendar-cell');
        c.style.background='#000'; // blank
        monthGrid.appendChild(c);
      }
      // fill day cells
      for(let d=1; d<=lastDate; d++){
        const c=document.createElement('div');
        c.classList.add('calendar-cell');
        c.innerHTML=`<div class="day-label">${d}</div>`;
        if(daysWithAppts[d]){
          c.style.background='#333';
          c.title='Appointments on this day.';
        }
        // date click => open day in a "daily" sense or open modal?
        // We'll do: open a new Appt or show a day detail
        // For now, let's create a new Appt
        const dt=new Date(currentMonth.year, currentMonth.month-1,d);
        c.addEventListener('click',()=>{
          // you can do something, e.g. open daily or new Appt
          openNewApptModal('08:00', dt.toISOString().split('T')[0]);
        });
        monthGrid.appendChild(c);
      }
    }

    function monthName(m){
      const names=["January","February","March","April","May","June","July","August","September","October","November","December"];
      return names[m-1];
    }

    /***************************************
     * APPOINTMENTS BOX (Past / Upcoming)
     ***************************************/
    // date range + type check => automatically reload
    [apptsStart, apptsEnd, checkAppointment, checkWalkin].forEach(el=>{
      el.addEventListener('change', loadAppointmentsBox);
    });
    artistFilterContainer.addEventListener('change', loadAppointmentsBox);

    async function loadAppointmentsBox(){
      appointmentsList.innerHTML='';
      const startVal=apptsStart.value;
      const endVal=apptsEnd.value;
      if(!startVal||!endVal)return; // no load if incomplete

      const locationVal=locationFilter.value;
      if(!locationVal)return; // must pick location

      const selectedArtistIds=getFilteredArtistIds();
      if(selectedArtistIds.length===0)return;

      let types=[];
      if(checkAppointment.checked) types.push('appointment');
      if(checkWalkin.checked) types.push('walk-in');
      if(types.length===0)return; // nothing to show

      // query
      let {data:appts,error}=await supabase
        .from('artist_appointments')
        .select('*')
        .gte('date',startVal)
        .lte('date',endVal)
        .in('appointment_type', types);
      if(error){
        console.error(error);
        return;
      }
      // filter by location via artist => we need the location of each appointment’s artist
      // we can do an in statement? or we can just filter in JS
      // simpler: in JS for now
      appts=appts.filter(ap=> selectedArtistIds.includes(ap.artist_id));
      if(appts.length===0){
        const div=document.createElement('div');
        div.textContent='No appointments found.';
        div.style.color='#ccc';
        appointmentsList.appendChild(div);
        return;
      }
      // sort by date desc or asc?
      // let's do ascending
      appts.sort((a,b)=>{
        if(a.date===b.date){
          return (a.start_time||'00:00').localeCompare(b.start_time||'00:00');
        }
        return a.date.localeCompare(b.date);
      });
      appts.forEach(ap=>{
        const it=document.createElement('div');
        it.classList.add('appt-item');
        const dtLabel=`${ap.date} ${ap.start_time||''}-${ap.end_time||''}`;
        const tType=`${ap.appointment_type}`;
        it.innerHTML=`
          <h4>${dtLabel} (${tType})</h4>
          <p>Client: ${ap.client_name||'N/A'}</p>
          <p>Phone: ${ap.client_phone||'N/A'}</p>
          <p>Email: ${ap.email||'N/A'}</p>
          <p>Price: $${(ap.price||0).toFixed(2)}, Tip: $${(ap.tip||0).toFixed(2)}</p>
          <p>Notes: ${ap.notes||''}</p>
        `;
        appointmentsList.appendChild(it);
      });
    }

    /***************************************
     * APPT MODAL
     ***************************************/
    function openNewApptModal(slot,dateStr){
      currentApptId=null;
      modalTitle.textContent='New Appointment';
      modalStartTime.value=slot;
      modalEndTime.value=slot;
      modalArtist.value='';
      modalClientName.value='';
      modalClientPhone.value='';
      modalEmail.value='';
      modalDescription.value='';
      modalDeposit.value='';
      modalPrice.value='';
      modalTip.value='';
      modalApptType.value='walk-in';
      deleteApptBtn.style.display='none';
      completeApptBtn.style.display='none';
      apptModal.style.display='block';
    }
    async function openExistingApptModal(apptId){
      currentApptId=apptId;
      const {data,error}=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('id',apptId);
      if(error||!data||data.length===0){
        console.error(error);
        alert('Error loading appointment.');
        return;
      }
      const ap=data[0];
      modalTitle.textContent='Edit Appointment';
      modalStartTime.value=ap.start_time||'';
      modalEndTime.value=ap.end_time||'';
      modalArtist.value=ap.artist_id;
      modalClientName.value=ap.client_name||'';
      modalClientPhone.value=ap.client_phone||'';
      modalEmail.value=ap.email||'';
      modalDescription.value=ap.notes||'';
      modalDeposit.value=ap.deposit||'';
      modalPrice.value=ap.price||'';
      modalTip.value=ap.tip||'';
      modalApptType.value=ap.appointment_type||'walk-in';
      deleteApptBtn.style.display='inline-block';
      completeApptBtn.style.display='inline-block';
      apptModal.style.display='block';
    }

    saveApptBtn.addEventListener('click',saveAppt);
    async function saveAppt(){
      const sVal=modalStartTime.value;
      const eVal=modalEndTime.value;
      const aVal=modalArtist.value;
      const cName=modalClientName.value;
      const cPhone=modalClientPhone.value;
      const eMail=modalEmail.value;
      const desc=modalDescription.value;
      const dep=modalDeposit.value?parseFloat(modalDeposit.value):null;
      const pr=modalPrice.value?parseFloat(modalPrice.value):null;
      const tp=modalTip.value?parseFloat(modalTip.value):null;
      const apType=modalApptType.value;

      if(!sVal||!eVal){alert('Start and End time are required.');return;}

      // no date in this modal, so let's assume "today" or we can let user specify
      // for now, let's do:
      const dateStr=new Date().toISOString().split('T')[0];

      // Overlap check? Omitted for brevity or implement if needed
      if(!currentApptId){
        // Insert
        const { error:insE }=await supabase
          .from('artist_appointments')
          .insert([{
            artist_id:aVal,
            date: dateStr,
            start_time:sVal,
            end_time:eVal,
            appointment_type:apType,
            client_name:cName,
            client_phone:cPhone,
            email:eMail,
            notes:desc,
            deposit:dep,
            price:pr,
            tip:tp
          }]);
        if(insE){
          console.error(insE);
          alert('Error inserting appointment.');
          return;
        }
      } else {
        // Update
        const { error:updE }=await supabase
          .from('artist_appointments')
          .update({
            artist_id:aVal,
            start_time:sVal,
            end_time:eVal,
            appointment_type:apType,
            client_name:cName,
            client_phone:cPhone,
            email:eMail,
            notes:desc,
            deposit:dep,
            price:pr,
            tip:tp
          })
          .eq('id',currentApptId);
        if(updE){
          console.error(updE);
          alert('Error updating appointment.');
          return;
        }
      }
      apptModal.style.display='none';
      drawMonth();         // refresh calendar
      loadAppointmentsBox(); // refresh the bottom list
    }

    deleteApptBtn.addEventListener('click',async()=>{
      if(!currentApptId)return;
      const c=confirm('Delete this appointment?');
      if(!c)return;
      const { error }=await supabase
        .from('artist_appointments')
        .delete()
        .eq('id',currentApptId);
      if(error){
        console.error(error);
        alert('Error deleting appointment.');
        return;
      }
      apptModal.style.display='none';
      drawMonth();
      loadAppointmentsBox();
    });
    completeApptBtn.addEventListener('click',async()=>{
      if(!currentApptId)return;
      const { error }=await supabase
        .from('artist_appointments')
        .update({ appointment_type:'completed' })
        .eq('id',currentApptId);
      if(error){
        console.error(error);
        alert('Error marking completed.');
        return;
      }
      apptModal.style.display='none';
      drawMonth();
      loadAppointmentsBox();
    });
    cancelApptBtn.addEventListener('click',()=>{
      apptModal.style.display='none';
    });

    /***************************************
     * ON LOAD
     ***************************************/
    window.addEventListener('DOMContentLoaded', async()=>{
      checkAuth();         // ensure logged in
      await loadLocations();
      // init the month with “today”
      const now=new Date();
      currentMonth.year= now.getFullYear();
      currentMonth.month= now.getMonth()+1;
      drawMonth();

      // default date range for bottom box => last 7 days to next 30 days
      const nowStr= now.toISOString().split('T')[0];
      const past7=new Date(now);
      past7.setDate(past7.getDate()-7);
      const past7Str= past7.toISOString().split('T')[0];
      const next30=new Date(now);
      next30.setDate(next30.getDate()+30);
      const next30Str=next30.toISOString().split('T')[0];
      apptsStart.value= past7Str;
      apptsEnd.value= next30Str;

      loadAppointmentsBox();
    });
  </script>
</body>
</html>
