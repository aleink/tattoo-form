<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Calendar</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!--  CSP  -->
<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
        connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
        style-src 'self' 'unsafe-inline';
        object-src 'none';
      ">

<!-- ─── VISUAL THEME ─── -->
<style>
:root{
  --bg0:#111;--bg1:#222;--bg2:#333;
  --border:#444;--txt:#fff;--txt-dim:#ccc;
  --accent:#28a745;--info:#1976d2;--danger:#f44336;
}
body.light{
  --bg0:#f7f7f7;--bg1:#fff;--bg2:#e6e6e6;
  --border:#b7b7b7;--txt:#000;--txt-dim:#444;
  --accent:#0d6efd;--info:#0d6efd;--danger:#d32f2f;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Helvetica Neue',Arial,sans-serif}
body{
  background:var(--bg0);color:var(--txt);
  max-width:1200px;margin:32px auto;padding:28px;
  transition:background .25s,color .25s;
}
h1{font-size:1.8rem;text-align:center;margin-bottom:24px}

/*  login card (copied from Manage-Artists)  */
.card{
  background:var(--bg1);border:1px solid var(--border);
  border-radius:6px;padding:22px;max-width:420px;margin:0 auto 30px;
}
label{display:block;font-weight:700;margin:10px 0 4px}
input,select,textarea{
  width:100%;padding:8px;background:var(--bg0);color:var(--txt);
  border:1px solid var(--border);border-radius:4px;margin-bottom:12px;
}
input:focus,select:focus,textarea:focus{outline:2px solid var(--accent)}
button{
  background:var(--bg2);color:var(--txt);border:none;border-radius:4px;
  padding:8px 16px;cursor:pointer;transition:background .2s
}
button:hover{background:#555}
.btn-mini{padding:4px 10px;font-size:.85em;margin-right:6px}
.message{color:#ff6262;font-size:.9em;margin-top:8px}
.hidden{display:none}

/*  toggle buttons  */
.toggle-btn{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--bg2);color:var(--txt);border:1px solid var(--border);
  border-radius:4px;padding:6px 12px;margin:4px 6px 4px 0;font-size:.9rem;
  cursor:pointer;transition:background .15s,border .15s;
}
.toggle-btn span.icon{font-weight:bold}
.toggle-btn.active{
  background:var(--accent);border-color:var(--accent);color:#fff;
}
.toggle-btn.active span.icon::after{content:"✓"}
.toggle-btn:not(.active) span.icon::after{content:"✕"}

/*  top  */
.top-controls{display:flex;flex-wrap:wrap;gap:16px;margin-bottom:20px;align-items:center}

/*  scheduler  */
#daily-scheduler{
  position:relative;height:960px;overflow:auto;
  border:1px solid var(--border);background:var(--bg2)
}
.hour-line{
  position:absolute;left:0;right:0;
  border-top:1px dashed var(--border);
  color:var(--txt-dim);font-size:12px;padding-left:5px
}
.schedule-block{
  position:absolute;background:rgba(255,255,255,.05);
  color:var(--txt-dim);padding:2px;font-size:.75em;
  border-left:4px solid var(--accent);pointer-events:none
}
.schedule-block.vac{background:rgba(128,128,128,.35);border-left-color:#888}
.schedule-artist-name{display:block;margin-bottom:2px;font-weight:bold;color:var(--txt)}
.appointment-block{
  position:absolute;background:var(--accent);color:#fff;
  border-radius:4px;padding:2px 4px;font-size:.85em;cursor:pointer;box-sizing:border-box
}

/*  modal  */
#appt-modal{
  display:none;position:fixed;left:50%;top:10px;transform:translateX(-50%);
  background:var(--bg1);border:1px solid var(--border);padding:20px;width:320px;
  max-height:90vh;overflow:auto;z-index:999;
  box-shadow:0 2px 10px rgba(0,0,0,.25);
}
#appt-modal h3{margin:0 0 10px}
.modal-field{margin-bottom:10px}
.duration-wrap{margin-bottom:10px;display:flex;gap:6px}
.duration-wrap input{margin-bottom:0}
.modal-buttons{text-align:right;margin-top:10px;display:flex;flex-wrap:wrap;gap:8px}
#complete-appt-btn{margin-top:6px}

/*  list  */
#appointments-list-section{
  margin-top:24px;background:var(--bg1);border:1px solid var(--border);
  border-radius:6px;padding:15px
}
#appointments-list-section h2{margin-bottom:10px}
.filters-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.appointments-container{max-height:300px;overflow-y:auto;border:1px solid var(--border);padding:10px}
.appt-item{background:var(--bg2);border:1px solid var(--border);padding:8px;border-radius:4px;margin-bottom:8px;cursor:pointer}
.appt-item h4{margin-bottom:3px;font-size:1rem;color:var(--txt)}
.appt-item p{margin-bottom:2px;font-size:.85rem;color:var(--txt-dim)}
</style>
</head>
<body>

<h1>Calendar</h1>

<!-- LOGIN -->
<div id="login-section" class="card">
  <label>Email</label><input id="login-email" type="email" autocomplete="username">
  <label>Password</label><input id="login-pass" type="password" autocomplete="current-password">
  <button id="login-btn">Login</button>
  <div id="login-msg" class="message"></div>
</div>

<!-- MAIN -->
<div id="main-section" class="hidden">

  <div class="top-controls">
    <button id="theme-btn"  class="btn-mini">Light mode</button>
    <button id="logout-btn" class="btn-mini">Logout</button>
    <button id="today-btn">Today</button>

    <label>Location
      <select id="location-filter"><option value="">-- Select Location --</option></select>
    </label>

    <label>Date
      <input type="date" id="day-input">
    </label>
  </div>

  <div id="artist-filter-container"></div>
  <div id="daily-scheduler"></div>

  <!-- MODAL -->
  <div id="appt-modal">
    <h3 id="modal-title">New Appointment</h3>

    <div class="modal-field"><label>Start Time (5-min)</label><input type="time" id="modal-start-time" step="300"></div>

    <!-- Duration -->
    <div class="modal-field">
      <label>Duration</label>
      <div class="duration-wrap">
        <input id="modal-dur-h" type="number" min="0" step="1" placeholder="Hrs">
        <input id="modal-dur-m" type="number" min="0" max="55" step="5" placeholder="Min">
      </div>
    </div>

    <div class="modal-field"><label>End Time (5-min)</label><input  type="time" id="modal-end-time"   step="300"></div>

    <div class="modal-field"><label>Artist</label><select id="modal-artist"></select></div>
    <div class="modal-field"><label>Client Name</label><input type="text" id="modal-client-name"></div>
    <div class="modal-field"><label>Client Phone</label><input type="text" id="modal-client-phone"></div>
    <div class="modal-field"><label>Client Email</label><input type="email" id="modal-email"></div>
    <div class="modal-field"><label>Description</label><textarea id="modal-description"></textarea></div>
    <div class="modal-field"><label>Deposit</label><input type="number" id="modal-deposit"></div>
    <div class="modal-field"><label>Price</label><input type="number" id="modal-price"></div>
    <div class="modal-field"><label>Tip</label><input type="number" id="modal-tip"></div>
    <div class="modal-field"><label>Type</label>
      <select id="modal-appt-type">
        <option value="walk-in">Walk-in</option>
        <option value="appointment">Appointment</option>
        <option value="tentative">Tentative</option>
      </select>
    </div>

    <div class="modal-buttons">
      <button id="save-appt-btn">Save</button>
      <button id="cancel-appt-btn">Cancel</button>
      <button id="delete-appt-btn"   style="display:none">Delete</button>
      <button id="complete-appt-btn" style="display:none">Mark Completed</button>
    </div>
  </div>

  <!-- LIST -->
  <div id="appointments-list-section">
    <h2>Appointments &amp; Walk-ins</h2>

    <div class="filters-row">
      <label>From <input type="date" id="range-start"></label>
      <label>To <input type="date" id="range-end"></label>

      <div id="type-btns">
        <button id="btn-appt" class="toggle-btn active"><span class="icon"></span>Appointments</button>
        <button id="btn-walk" class="toggle-btn active"><span class="icon"></span>Walk-ins</button>
      </div>

      <input id="client-search" style="flex:1;min-width:200px" placeholder="Search client…">
    </div>

    <div class="appointments-container" id="appointments-list"></div>
  </div>
</div><!-- /MAIN -->

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
<script>
/* ---------- INIT / HELPERS ---------- */
const supabase = window.supabase.createClient(
  'https://shlvjhipxnslrncczopn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
);
const toMin=t=>{if(!t)return 0;const[h,m]=t.split(':').map(Number);return h*60+m};
const minToTime=m=>`${String(Math.floor(m/60)%24).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
const round5=v=>{const m=toMin(v);return minToTime(Math.round(m/5)*5)};
const overlaps=(a,b)=>toMin(a.start_time)<toMin(b.end_time)&&toMin(b.start_time)<toMin(a.end_time);
const todayISO=()=>new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().split('T')[0];
const dow=['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];

/* DOM refs – login */
const loginSec=document.getElementById('login-section'),loginEmail=document.getElementById('login-email'),loginPass=document.getElementById('login-pass'),loginBtn=document.getElementById('login-btn'),loginMsg=document.getElementById('login-msg');
/* main */
const mainSec=document.getElementById('main-section'),themeBtn=document.getElementById('theme-btn'),logoutBtn=document.getElementById('logout-btn'),todayBtn=document.getElementById('today-btn');
const locationFilter=document.getElementById('location-filter'),dayInput=document.getElementById('day-input');
const artistFilterContainer=document.getElementById('artist-filter-container'),dailyScheduler=document.getElementById('daily-scheduler');
/* modal */
const apptModal=document.getElementById('appt-modal'),modalTitle=document.getElementById('modal-title'),modalStart=document.getElementById('modal-start-time'),modalEnd=document.getElementById('modal-end-time'),modalArtist=document.getElementById('modal-artist'),modalDurH=document.getElementById('modal-dur-h'),modalDurM=document.getElementById('modal-dur-m'),modalClientName=document.getElementById('modal-client-name'),modalClientPhone=document.getElementById('modal-client-phone'),modalEmail=document.getElementById('modal-email'),modalDesc=document.getElementById('modal-description'),modalDeposit=document.getElementById('modal-deposit'),modalPrice=document.getElementById('modal-price'),modalTip=document.getElementById('modal-tip'),modalType=document.getElementById('modal-appt-type'),saveBtn=document.getElementById('save-appt-btn'),cancelBtn=document.getElementById('cancel-appt-btn'),deleteBtn=document.getElementById('delete-appt-btn'),completeBtn=document.getElementById('complete-appt-btn');
/* list */
const rangeStart=document.getElementById('range-start'),rangeEnd=document.getElementById('range-end'),btnAppt=document.getElementById('btn-appt'),btnWalk=document.getElementById('btn-walk'),appointmentsList=document.getElementById('appointments-list'),clientSearch=document.getElementById('client-search');

/* state */
let role='',allowedLocation='',artistMap={},currentApptId=null;

/* THEME */
(()=>{if(localStorage.getItem('ui-theme')==='light'){document.body.classList.add('light');themeBtn.textContent='Dark mode'}})();
themeBtn.onclick=()=>{const l=document.body.classList.toggle('light');themeBtn.textContent=l?'Dark mode':'Light mode';localStorage.setItem('ui-theme',l?'light':'dark')};

/* AUTO-LOGIN */
(()=>{const s=JSON.parse(localStorage.getItem('calendarUser')||'null');if(!s)return;role=s.role;allowedLocation=s.allowedLocation;loginSec.classList.add('hidden');mainSec.classList.remove('hidden');initApp();})();

/* LOGIN */
loginBtn.onclick=async()=>{
  loginMsg.textContent='';
  if(!loginEmail.value||!loginPass.value){loginMsg.textContent='Email & password required.';return;}
  const{data}=await supabase.from('users').select('*').eq('email',loginEmail.value.trim());
  if(!data?.length||data[0].password_hash!==loginPass.value.trim()){loginMsg.textContent='Invalid credentials.';return;}
  role=data[0].role;allowedLocation=data[0].location_id||'';if(!['gm','sm','fd'].includes(role)){loginMsg.textContent='Access denied.';return;}
  localStorage.setItem('calendarUser',JSON.stringify({role,allowedLocation}));
  loginSec.classList.add('hidden');mainSec.classList.remove('hidden');initApp();
};

/* LOGOUT */
logoutBtn.onclick=()=>{localStorage.removeItem('calendarUser');role='';allowedLocation='';artistMap={};currentApptId=null;mainSec.classList.add('hidden');loginSec.classList.remove('hidden')};

/* INIT after login */
async function initApp(){
  await loadLocations();
  dayInput.value=todayISO();
  await loadArtistsForLocation(locationFilter.value);
  setDefaultRange();
  renderDay();renderList();realtime();
}

/* LOCATIONS */
async function loadLocations(){
  locationFilter.innerHTML='<option value="">-- Select Location --</option>';
  let q=supabase.from('locations').select('*');if(role!=='gm')q=q.eq('id',allowedLocation);
  (await q).data.forEach(l=>locationFilter.add(new Option(l.location_name,l.id)));
  if(role!=='gm'){locationFilter.value=allowedLocation;locationFilter.disabled=true}else locationFilter.disabled=false;
}

/* ARTISTS */
async function loadArtistsForLocation(loc){
  artistMap={};modalArtist.innerHTML='';artistFilterContainer.innerHTML='';
  if(!loc)return;
  const arts=(await supabase.from('artists').select('*').eq('location_id',loc)).data||[];
  arts.sort((a,b)=>a.artist_name.localeCompare(b.artist_name)).forEach(a=>{
    artistMap[a.id]=a;
    modalArtist.add(new Option(a.artist_name,a.id));

    const btn=document.createElement('button');
    btn.className='toggle-btn active';btn.dataset.id=a.id;
    btn.innerHTML=`<span class="icon"></span>${a.artist_name}`;
    btn.onclick=()=>{btn.classList.toggle('active');renderDay();renderList()};
    artistFilterContainer.appendChild(btn);
  });
}
const visibleIds=()=>[...artistFilterContainer.querySelectorAll('.toggle-btn.active')].map(b=>b.dataset.id);

/* VACATIONS helper */
async function onVacation(id,date){
  const{data}=await supabase.from('artist_vacations').select('id').eq('artist_id',id).lte('vacation_start',date).gte('vacation_end',date);
  return !!data?.length;
}

/* TODAY */
todayBtn.onclick=()=>{dayInput.value=todayISO();renderDay()};

/* RENDER DAY */
dayInput.onchange=renderDay;
locationFilter.onchange=async()=>{await loadArtistsForLocation(locationFilter.value);renderDay();renderList()};

async function renderDay(){
  dailyScheduler.innerHTML='';
  /* hours */
  for(let h=8;h<=24;h++){
    const l=document.createElement('div');l.className='hour-line';
    l.style.top=(h-8)*60+'px';
    l.textContent=`${((h+11)%12)+1}:00 ${h<12?'AM':'PM'}`;
    dailyScheduler.appendChild(l);
  }
  const date=dayInput.value;if(!date)return;
  const ids=visibleIds();if(!ids.length)return;

  const idx=new Date(date+'T00:00').getDay(),kStart=dow[idx]+'_start',kEnd=dow[idx]+'_end';
  const arts=ids.map(id=>artistMap[id]).filter(Boolean);

  /* build columns (smart) */
  const COL_W=140,COL_X=100;
  const columns=[], artCol={};
  arts.forEach(a=>{
    const s=toMin(a[kStart]||'00:00'),e=toMin(a[kEnd]||'00:00');if(!s||!e)return;
    let placed=false;
    for(let i=0;i<columns.length;i++){
      if(columns[i].every(ax=>{
        const ss=toMin(ax[kStart]||'00:00'),ee=toMin(ax[kEnd]||'00:00');
        return e<=ss||s>=ee;
      })){columns[i].push(a);artCol[a.id]=i;placed=true;break;}
    }
    if(!placed){columns.push([a]);artCol[a.id]=columns.length-1;}
  });
  dailyScheduler.style.minWidth=(COL_X+columns.length*COL_W)+'px';

  const vacSet=new Set((await supabase.from('artist_vacations').select('artist_id').in('artist_id',ids).lte('vacation_start',date).gte('vacation_end',date)).data?.map(v=>v.artist_id)||[]);
  arts.forEach(a=>{
    const st=a[kStart],en=a[kEnd];if(!st||!en)return;
    const left=COL_X+artCol[a.id]*COL_W;
    const blk=document.createElement('div');blk.className='schedule-block';
    if(vacSet.has(a.id))blk.classList.add('vac');
    blk.style.cssText=`left:${left}px;width:${COL_W-10}px;top:${toMin(st)-480}px;height:${toMin(en)-toMin(st)}px;border-left-color:${a.color||'#888'}`;
    blk.innerHTML=`<span class="schedule-artist-name">${a.artist_name}${vacSet.has(a.id)?' (vacation)':''}</span>${st}-${en}`;
    dailyScheduler.appendChild(blk);
  });

  /* appointments */
  const appts=(await supabase.from('artist_appointments').select('*').eq('date',date).in('artist_id',ids)).data||[];
  const byArt={};ids.forEach(id=>byArt[id]=[]);
  appts.forEach(ap=>byArt[ap.artist_id].push(ap));

  arts.forEach(a=>{
    const col=artCol[a.id],x0=COL_X+col*COL_W;
    const lst=byArt[a.id].sort((x,y)=>toMin(x.start_time)-toMin(y.start_time));
    const layers=[];
    lst.forEach(ap=>{
      let ok=false;
      for(const layer of layers){
        if(!overlaps(layer[layer.length-1],ap)){layer.push(ap);ok=true;break;}
      }
      if(!ok)layers.push([ap]);
    });
    layers.forEach((layer,i)=>{
      layer.forEach(ap=>{
        const w=(COL_W-10)/layers.length;
        const div=document.createElement('div');
        div.className='appointment-block';
        div.style.cssText=`left:${x0+i*w}px;width:${w-2}px;top:${toMin(ap.start_time)-480}px;height:${toMin(ap.end_time)-toMin(ap.start_time)}px;background:${a.color||'#555'}`;
        div.textContent=`${a.artist_name} – ${ap.client_name||'N/A'} (${ap.appointment_type})`;
        div.onclick=e=>{e.stopPropagation();openExisting(ap.id)};
        dailyScheduler.appendChild(div);
      });
    });
  });

  dailyScheduler.onclick=e=>{
    if(['appointment-block','schedule-block','hour-line'].some(c=>e.target.classList.contains(c)))return;
    const y=e.clientY-dailyScheduler.getBoundingClientRect().top;
    const t=round5(minToTime(8*60+Math.max(0,Math.floor(y))));
    openNew(t,date);
  };
}

/* MODAL logic: duration ↔ end-time sync */
function updateEndFromDuration(){
  if(!modalStart.value)return;
  const base=toMin(round5(modalStart.value));
  const dur=(+modalDurH.value||0)*60+(+modalDurM.value||0);
  if(dur>0)modalEnd.value=minToTime(base+dur);
}
function updateDurationFromEnd(){
  if(!modalStart.value||!modalEnd.value)return;
  const diff=toMin(modalEnd.value)-toMin(modalStart.value);
  if(diff>0){
    modalDurH.value=Math.floor(diff/60);
    modalDurM.value=(diff%60);
  }
}
[modalDurH,modalDurM].forEach(i=>i.addEventListener('input',()=>{i.value=Math.max(0,Math.floor(+i.value||0));updateEndFromDuration()}));
modalStart.addEventListener('change',()=>{modalStart.value=round5(modalStart.value);updateEndFromDuration()});
modalEnd.addEventListener('change',()=>{modalEnd.value=round5(modalEnd.value);updateDurationFromEnd()});

/* open / fill modal */
function openNew(t,d){
  currentApptId=null;modalTitle.textContent='New Appointment';
  modalStart.value=t;modalDurH.value='';modalDurM.value='';modalEnd.value=t;
  [modalClientName,modalClientPhone,modalEmail,modalDesc,modalDeposit,modalPrice,modalTip].forEach(i=>i.value='');
  modalArtist.value='';modalType.value='walk-in';deleteBtn.style.display=completeBtn.style.display='none';
  apptModal.style.display='block';
}
async function openExisting(id){
  currentApptId=id;const ap=(await supabase.from('artist_appointments').select('*').eq('id',id)).data[0];
  modalTitle.textContent='Edit Appointment';
  modalStart.value=ap.start_time;modalEnd.value=ap.end_time;updateDurationFromEnd();
  modalArtist.value=ap.artist_id;modalType.value=ap.appointment_type;
  modalClientName.value=ap.client_name||'';modalClientPhone.value=ap.client_phone||'';
  modalEmail.value=ap.email||'';modalDesc.value=ap.notes||'';
  modalDeposit.value=ap.deposit||'';modalPrice.value=ap.price||'';modalTip.value=ap.tip||'';
  deleteBtn.style.display=completeBtn.style.display='inline-block';
  apptModal.style.display='block';
}
cancelBtn.onclick=()=>apptModal.style.display='none';

/* OVERLAP helper */
async function clash(artist,date,s,e,skip){
  const rows=(await supabase.from('artist_appointments').select('*').eq('artist_id',artist).eq('date',date)).data||[];
  return rows.some(r=>r.id!==skip&&overlaps({start_time:s,end_time:e},r));
}

/* SAVE / DELETE / COMPLETE (same validation) */
saveBtn.onclick=async()=>{
  const date=dayInput.value,artist=modalArtist.value,s=modalStart.value,e=modalEnd.value;
  if(!date||!artist||!s||!e){alert('Fill required fields');return;}
  if(await onVacation(artist,date)){alert('Artist on vacation');return;}
  if(await clash(artist,date,s,e,currentApptId)){alert('Time overlap');return;}
  const payload={
    artist_id:artist,date,start_time:s,end_time:e,appointment_type:modalType.value,
    client_name:modalClientName.value.trim(),client_phone:modalClientPhone.value.trim(),
    email:modalEmail.value.trim(),notes:modalDesc.value.trim(),
    deposit:modalDeposit.value?+modalDeposit.value:null,price:modalPrice.value?+modalPrice.value:null,tip:modalTip.value?+modalTip.value:null
  };
  const res=currentApptId?await supabase.from('artist_appointments').update(payload).eq('id',currentApptId)
                         :await supabase.from('artist_appointments').insert([payload]);
  if(res.error){alert('Save error');return;}apptModal.style.display='none';
};
deleteBtn.onclick=async()=>{if(currentApptId&&confirm('Delete?')){await supabase.from('artist_appointments').delete().eq('id',currentApptId);apptModal.style.display='none'}};
completeBtn.onclick=async()=>{if(currentApptId){await supabase.from('artist_appointments').update({appointment_type:'completed'}).eq('id',currentApptId);apptModal.style.display='none'}};

/* LIST  */
function setDefaultRange(){const n=new Date();rangeStart.value=new Date(n-7*864e5).toISOString().split('T')[0];rangeEnd.value=new Date(+n+7*864e5).toISOString().split('T')[0];}
[btnAppt,btnWalk].forEach(b=>b.onclick=()=>{b.classList.toggle('active');renderList()});
[rangeStart,rangeEnd].forEach(i=>i.addEventListener('change',renderList));clientSearch.addEventListener('input',renderList);

async function renderList(){
  appointmentsList.innerHTML='';
  const ids=visibleIds();if(!ids.length){appointmentsList.textContent='No artists selected.';return;}
  if(!rangeStart.value||!rangeEnd.value){appointmentsList.textContent='Select range.';return;}
  const types=[];if(btnAppt.classList.contains('active'))types.push('appointment','tentative');
  if(btnWalk.classList.contains('active'))types.push('walk-in');
  if(!types.length){appointmentsList.textContent='No types.';return;}
  let q=supabase.from('artist_appointments').select('*, artists!inner(location_id,artist_name)')
        .gte('date',rangeStart.value).lte('date',rangeEnd.value)
        .in('appointment_type',types).in('artist_id',ids);
  if(role!=='gm')q=q.eq('artists.location_id',allowedLocation);else if(locationFilter.value)q=q.eq('artists.location_id',locationFilter.value);
  if(clientSearch.value.trim())q=q.or(`client_name.ilike.*${clientSearch.value.trim()}*,client_phone.ilike.*${clientSearch.value.trim()}*,email.ilike.*${clientSearch.value.trim()}*`);
  const {data,error}=await q;if(error){appointmentsList.textContent='Error.';return;}
  if(!data?.length){appointmentsList.textContent='None.';return;}
  data.sort((a,b)=>a.date===b.date?toMin(a.start_time)-toMin(b.start_time):a.date<b.date?-1:1);
  data.forEach(ap=>{
    const div=document.createElement('div');div.className='appt-item';
    div.innerHTML=`<h4>${ap.date} ${ap.start_time}-${ap.end_time} [${ap.appointment_type}]</h4>
                   <p>Artist: ${ap.artists?.artist_name||ap.artist_id}</p>
                   <p>Client: ${ap.client_name||'N/A'}</p>
                   <p>Price: ${ap.price||0}, Tip: ${ap.tip||0}</p>`;
    div.onclick=()=>{dayInput.value=ap.date;renderDay()};
    appointmentsList.appendChild(div);
  });
}

/* REALTIME  */
function realtime(){
  supabase.from('artist_appointments').on('*',()=>{renderDay();renderList()}).subscribe();
  supabase.from('artist_vacations' ).on('*',renderDay).subscribe();
  supabase.from('artists'          ).on('*',()=>loadArtistsForLocation(locationFilter.value).then(renderDay)).subscribe();
}
</script>
</body>
</html>
