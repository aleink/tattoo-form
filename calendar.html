<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSP with 'unsafe-eval' for Supabase usage -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    /* Dark style for PC layout */
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Helvetica Neue',Arial,sans-serif;background:#111;color:#fff;max-width:1200px;margin:20px auto;padding:10px;}
    header{background:#000;border-bottom:2px solid #444;padding:20px;text-align:center;}
    header h1{color:#fff;margin:0;font-size:1.8rem;}
    .top-controls{display:flex;align-items:center;gap:20px;margin:15px 0;}
    #logout-btn{background:#f44336;color:#fff;border:none;border-radius:4px;padding:8px 16px;cursor:pointer;}
    select,input[type="date"],input[type="time"],input[type="text"],input[type="number"],input[type="email"],textarea{background:#222;color:#fff;border:1px solid #444;border-radius:4px;padding:6px;}
    select option{color:#000;}

    /* Daily scheduler */
    #daily-scheduler{position:relative;height:960px;border:1px solid #444;overflow-y:auto;margin-top:10px;background:#222;}
    .hour-line{position:absolute;left:0;width:100%;border-top:1px dashed #444;color:#bbb;font-size:12px;padding-left:5px;}
    .schedule-block{position:absolute;background:rgba(255,255,255,.05);color:#ddd;padding:2px;font-size:.75em;box-sizing:border-box;border-left:4px solid #555;pointer-events:none;}
    .schedule-artist-name{font-weight:bold;display:block;margin-bottom:2px;color:#fff;}
    .appointment-block{position:absolute;background:#444;color:#fff;border-radius:4px;padding:2px 4px;font-size:.85em;box-sizing:border-box;cursor:pointer;}

    /* Appointment Modal */
    #appt-modal{display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#222;border:1px solid #444;padding:20px;width:320px;box-shadow:0 2px 10px rgba(0,0,0,.2);color:#fff;z-index:999;}
    #appt-modal h3{margin-top:0;}
    #appt-modal input,#appt-modal select,#appt-modal textarea{width:100%;background:#333;border:1px solid #555;color:#fff;border-radius:4px;padding:6px;}
    .modal-field{margin-bottom:10px;}
    .modal-buttons{text-align:right;margin-top:10px;}
    .modal-buttons button{margin-left:8px;background:#333;color:#fff;border:1px solid #555;padding:6px 10px;border-radius:4px;cursor:pointer;}
    .modal-buttons button:hover{background:#555;}

    /* Artist filter checkboxes */
    #artist-filter-container{margin-top:10px;}
    .artist-filter-item{display:inline-block;margin-right:10px;}
    .artist-filter-item label{margin-left:4px;}

    /* bottom "Appointments & Walk-ins" box */
    #appointments-list-section{margin-top:20px;background:#222;border:1px solid #444;border-radius:6px;padding:15px;}
    #appointments-list-section h2{margin-bottom:10px;}
    .filters-row{display:flex;align-items:center;gap:15px;margin-bottom:10px;flex-wrap:wrap;}
    .appointments-container{max-height:300px;overflow-y:auto;border:1px solid #444;padding:10px;}
    .appt-item{background:#333;border:1px solid #555;padding:8px;border-radius:4px;margin-bottom:8px;}
    .appt-item h4{margin-bottom:3px;font-size:1rem;color:#fff;}
    .appt-item p{margin-bottom:2px;font-size:.85rem;color:#bbb;}
  </style>
</head>
<body>
  <header><h1>Calendar</h1></header>

  <div class="top-controls">
    <button id="logout-btn">Logout</button>

    <label for="location-filter">Location:</label>
    <select id="location-filter"><option value="">-- Select Location --</option></select>

    <label for="day-input">Date:</label>
    <input type="date" id="day-input" />
  </div>

  <div id="artist-filter-container"></div>
  <div id="daily-scheduler"></div>

  <!-- ----------------- Appointment MODAL (unchanged) ---------------- -->
  <div id="appt-modal">
    <h3 id="modal-title">New Appointment</h3>
    <div class="modal-field"><label for="modal-start-time">Start Time (5 min steps):</label><input type="time" id="modal-start-time" step="300"></div>
    <div class="modal-field"><label for="modal-end-time">End Time (5 min steps):</label><input type="time" id="modal-end-time" step="300"></div>
    <div class="modal-field"><label for="modal-artist">Artist:</label><select id="modal-artist"></select></div>
    <div class="modal-field"><label for="modal-client-name">Client Name:</label><input type="text" id="modal-client-name"></div>
    <div class="modal-field"><label for="modal-client-phone">Client Phone:</label><input type="text" id="modal-client-phone"></div>
    <div class="modal-field"><label for="modal-email">Client Email:</label><input type="email" id="modal-email"></div>
    <div class="modal-field"><label for="modal-description">Tattoo Description:</label><textarea id="modal-description"></textarea></div>
    <div class="modal-field"><label for="modal-deposit">Deposit:</label><input type="number" id="modal-deposit"></div>
    <div class="modal-field"><label for="modal-price">Price:</label><input type="number" id="modal-price"></div>
    <div class="modal-field"><label for="modal-tip">Tip:</label><input type="number" id="modal-tip"></div>
    <div class="modal-field"><label for="modal-appt-type">Appointment Type:</label><select id="modal-appt-type"><option value="walk-in">Walk-in</option><option value="appointment">Appointment</option></select></div>
    <div class="modal-buttons">
      <button id="save-appt-btn">Save</button><button id="cancel-appt-btn">Cancel</button>
      <button id="delete-appt-btn" style="display:none;">Delete</button>
      <button id="complete-appt-btn" style="display:none;">Mark Completed</button>
    </div>
  </div>

  <!-- ----------------- Bottom list (unchanged) ---------------- -->
  <div id="appointments-list-section">
    <h2>Appointments & Walk-ins</h2>
    <div class="filters-row">
      <label for="range-start">From:</label><input type="date" id="range-start">
      <label for="range-end">To:</label><input type="date" id="range-end">
      <div>
        <label><input type="checkbox" id="cb-appointments" checked> Appointments</label>
        <label><input type="checkbox" id="cb-walkins" checked> Walk-ins</label>
      </div>
    </div>
    <div class="appointments-container" id="appointments-list"></div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    /* ----------  CONFIG  ---------- */
    const supabase = window.supabase.createClient(
      'https://shlvjhipxnslrncczopn.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
    );

    /* ----------  DATE / TIME HELPERS ---------- */
    const toMinutes = str => { if(!str) return 0; const [h,m]=str.split(':').map(Number); return h*60+m; };
    const minsToHHMM = m => String(Math.floor(m/60)).padStart(2,'0') + ':' + String(m%60).padStart(2,'0');
    const overlaps = (a,b) => a && b && (toMinutes(a.start_time) < toMinutes(b.end_time) && toMinutes(b.start_time) < toMinutes(a.end_time));

    /**  FIX: map real weekday -> DB column weekday (+1 mod 7) */
    const fixDayOffset = (dateStr)=>{
      const dUTC = new Date(dateStr+'T00:00:00Z');      // always UTC midnight
      return (dUTC.getUTCDay()+1) % 7;                  // shift forward one
    };

    /* ----------  DOM REFS ---------- */
    const logoutBtn = document.getElementById('logout-btn');
    const locationFilter = document.getElementById('location-filter');
    const dayInput = document.getElementById('day-input');
    const dailyScheduler = document.getElementById('daily-scheduler');
    const artistFilterContainer = document.getElementById('artist-filter-container');
    /* modal refs & bottom-list refs remain unchanged */

    /* ----------  AUTH ---------- */
    if(!localStorage.getItem('currentUserId')) window.location.href='login.html';
    logoutBtn.onclick = ()=>{ localStorage.clear(); window.location.href='login.html'; };

    /* ----------  STATE ---------- */
    let artistMap = {};

    /* ----------  INIT ---------- */
    document.addEventListener('DOMContentLoaded', async()=>{
      await loadLocations();
      dayInput.value = new Date().toISOString().split('T')[0];
      await loadArtistsForLocation(locationFilter.value);
      loadDay();
      loadAppointmentsList();
    });

    /* ----------  LOCATION & ARTIST LOADERS ---------- */
    async function loadLocations(){
      const {data} = await supabase.from('locations').select('*');
      locationFilter.innerHTML='<option value="">-- Select Location --</option>';
      data?.forEach(l=>{
        const o=document.createElement('option');o.value=l.id;o.textContent=l.location_name;
        locationFilter.appendChild(o);
      });
    }

    async function loadArtistsForLocation(locId){
      artistMap={};
      document.getElementById('modal-artist').innerHTML='';
      artistFilterContainer.innerHTML='';
      if(!locId) return;

      const {data} = await supabase.from('artists').select('*').eq('location_id',locId);
      data?.sort((a,b)=>a.artist_name.localeCompare(b.artist_name)).forEach(a=>{
        artistMap[a.id]=a;

        // modal dropdown
        const opt=document.createElement('option');opt.value=a.id;opt.textContent=a.artist_name;
        document.getElementById('modal-artist').appendChild(opt);

        // filter checkbox
        const wrap=document.createElement('div');wrap.className='artist-filter-item';
        const cb=document.createElement('input');cb.type='checkbox';cb.value=a.id;cb.checked=true;
        const lbl=document.createElement('label');lbl.textContent=a.artist_name;
        wrap.append(cb,lbl);artistFilterContainer.appendChild(wrap);
      });
    }

    const getFilteredArtistIds = () => [...artistFilterContainer.querySelectorAll('input[type=checkbox]')]
                                       .filter(cb=>cb.checked).map(cb=>cb.value);

    /* ----------  DAILY VIEW ---------- */
    dayInput.onchange = loadDay;
    locationFilter.onchange = async ()=>{ await loadArtistsForLocation(locationFilter.value); loadDay(); loadAppointmentsList(); };
    artistFilterContainer.addEventListener('change', ()=>{ loadDay(); loadAppointmentsList(); });

    async function loadDay(){
      dailyScheduler.innerHTML='';
      const dayVal = dayInput.value; if(!dayVal) return;

      /* draw hour guide lines 8 AM- 12 AM */
      for(let h=8;h<=24;h++){
        const line=document.createElement('div');line.className='hour-line';
        line.style.top=(h-8)*60+'px';
        let disp=h>12?h-12:h; disp=disp===0?12:disp;
        line.textContent=`${disp}:00 ${h<12?'AM':'PM'}`;
        dailyScheduler.appendChild(line);
      }

      const filteredIds = getFilteredArtistIds(); if(!filteredIds.length) return;

      const cols = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
      const idx   = fixDayOffset(dayVal);          // **** FIX HERE ****
      const cStart= cols[idx]+'_start', cEnd=cols[idx]+'_end';

      /* Build artist column order */
      const colArtists = filteredIds.map(id=>artistMap[id]).filter(Boolean)
                        .sort((a,b)=>a.artist_name.localeCompare(b.artist_name));

      /* Draw schedule blocks */
      colArtists.forEach((art,i)=>{
        const st=art[cStart], en=art[cEnd]; if(!st||!en) return;
        const top=toMinutes(st)-480, ht=toMinutes(en)-toMinutes(st);
        const div=document.createElement('div');div.className='schedule-block';
        div.style.cssText=`left:${80+i*120}px;width:110px;top:${top}px;height:${ht}px;border-left-color:${art.color||'#999'};`;
        div.innerHTML=`<span class="schedule-artist-name">${art.artist_name}</span>${st}-${en}`;
        dailyScheduler.appendChild(div);
      });

      /* Load appointments for that date & those artists */
      const {data:appts} = await supabase
            .from('artist_appointments')
            .select('*')
            .eq('date',dayVal)
            .in('artist_id',filteredIds);

      const byArtist={};colArtists.forEach(a=>byArtist[a.id]=[]);
      appts?.forEach(a=>{ if(byArtist[a.artist_id]) byArtist[a.artist_id].push(a); });

      /* Lay out appointments with overlap sub-columns */
      colArtists.forEach((art,main)=>{
        const list=(byArtist[art.id]||[]).sort((a,b)=>toMinutes(a.start_time)-toMinutes(b.start_time));
        const cols=[];                             // sub-columns
        list.forEach(ap=>{
          let placed=false;
          for(const col of cols){
            if(!overlaps(col[col.length-1],ap)){ col.push(ap); placed=true; break; }
          }
          if(!placed) cols.push([ap]);
        });
        cols.forEach((subCol,subIdx)=>{
          subCol.forEach(ap=>{
            const t0=toMinutes(ap.start_time)-480, h=toMinutes(ap.end_time)-toMinutes(ap.start_time);
            const base=80+main*120, each=110/cols.length;
            const block=document.createElement('div');block.className='appointment-block';
            block.style.cssText=`left:${base+subIdx*each}px;top:${t0}px;width:${each-2}px;height:${h}px;background:${art.color||'#444'};`;
            block.textContent=`${art.artist_name} â€“ ${ap.client_name||'N/A'} (${ap.appointment_type})`;
            block.onclick=e=>{e.stopPropagation();openExistingApptModal(ap.id);};
            dailyScheduler.appendChild(block);
          });
        });
      });

      dailyScheduler.onclick = e=>{
        if(['appointment-block','schedule-block','hour-line'].some(cls=>e.target.classList.contains(cls))) return;
        const y=e.clientY-dailyScheduler.getBoundingClientRect().top;
        const mins=Math.floor(y); const hr=Math.floor(mins/60)+8; const mm=String(mins%60).padStart(2,'0');
        openNewApptModal(`${String(hr).padStart(2,'0')}:${mm}`, dayVal);
      };
    }

    /* ----------  MODAL & CRUD  (unchanged from your version) ---------- */
    /* ... existing modal handling code stays as-is ... */

    /* ----------  APPOINTMENTS LIST  (unchanged) ---------- */
    /* ... existing appointments list code stays as-is ... */
  </script>
</body>
</html>