<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 
    Content-Security-Policy for production:
      - 'unsafe-eval' so Supabase can function
      - connect-src includes your .supabase.co domain
      - style-src allows inline for simplicity
  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    /* Dark theme + mobile friendly, akin to your index/artist portal */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #111;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #000;
      border-bottom: 2px solid #444;
      padding: 20px;
      text-align: center;
    }
    header h1 {
      font-size: 1.8rem;
      color: #fff;
      margin-bottom: 5px;
    }
    main {
      flex: 1;
      max-width: 900px;
      margin: 20px auto;
      padding: 10px;
    }
    /* Top bar for logout + schedules link */
    .top-links {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    a {
      text-decoration: none;
      color: #fff;
      background: #1b8adb;
      padding: 6px 12px;
      border-radius: 4px;
    }
    a:hover {
      background: #3aa0f3;
    }
    #logout-btn {
      background: #f44336;
      color: #fff;
      border: none;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 4px;
    }
    #logout-btn:hover {
      background: #d32f2f;
    }

    /* Tab buttons row */
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .tab-buttons button {
      background: #333;
      border: 1px solid #555;
      color: #fff;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
    }
    .tab-buttons button.active {
      background: #555;
    }

    .tab-content {
      display: none;
      margin-top: 10px;
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 15px;
    }
    .tab-content.active {
      display: block;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button:hover {
      background: #444;
    }

    /* Calendar grid for monthly */
    .month-header {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .month-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      border: 1px solid #444;
      padding: 4px;
    }
    .calendar-cell {
      border: 1px solid #444;
      min-height: 70px;
      padding: 5px;
      background: #333;
      cursor: pointer;
    }
    .calendar-cell:hover {
      background: #444;
    }
    .day-label {
      font-size: 0.9rem;
      margin-bottom: 3px;
    }

    /* The appointments tab styling */
    .check-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .appt-list {
      margin-top: 10px;
    }
    .appt-item {
      background: #333;
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 6px;
      border-radius: 4px;
    }
    .appt-item h4 {
      margin-bottom: 5px;
      font-size: 1rem;
      color: #fff;
    }
    .appt-item p {
      color: #ccc;
      margin-bottom: 3px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Calendar</h1>
  </header>
  <main>
    <div class="top-links">
      <a id="manage-schedules-link" href="manage_schedules.html">Manage Schedules</a>
      <button id="logout-btn">Logout</button>
    </div>

    <div class="tab-buttons">
      <button id="calendar-tab-btn" class="active">Calendar</button>
      <button id="appointments-tab-btn">Appointments</button>
    </div>

    <!-- CALENDAR TAB -->
    <div id="calendar-tab" class="tab-content active">
      <h2>Calendar</h2>
      <label for="month-input">Select Month:</label>
      <input type="month" id="month-input" />

      <!-- Days of the week row -->
      <div class="month-header" id="month-header"></div>
      <div class="month-grid" id="month-grid"></div>
    </div>

    <!-- APPOINTMENTS TAB -->
    <div id="appointments-tab" class="tab-content">
      <h2>Appointments</h2>
      <div style="margin-bottom:10px;">
        <label for="start-date">Start Date</label>
        <input type="date" id="start-date" />
        <label for="end-date">End Date</label>
        <input type="date" id="end-date" />
      </div>
      <div class="check-row">
        <label>
          <input type="checkbox" id="chk-appointment" checked />
          Appointments
        </label>
        <label>
          <input type="checkbox" id="chk-walkin" checked />
          Walk-ins
        </label>
      </div>
      <div id="appts-list" class="appt-list">
        <!-- We'll fill with appointments based on the filters -->
      </div>
    </div>
  </main>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    // Basic setup
    const supabaseUrl='https://shlvjhipxnslrncczopn.supabase.co';
    const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase=window.supabase.createClient(supabaseUrl,supabaseKey);

    const logoutBtn=document.getElementById('logout-btn');
    const calendarTabBtn=document.getElementById('calendar-tab-btn');
    const appointmentsTabBtn=document.getElementById('appointments-tab-btn');
    const calendarTab=document.getElementById('calendar-tab');
    const appointmentsTab=document.getElementById('appointments-tab');

    logoutBtn.addEventListener('click',()=>{
      localStorage.clear();
      window.location.href='login.html';
    });

    // Tab logic
    calendarTabBtn.addEventListener('click', ()=>{
      showTab('calendar');
    });
    appointmentsTabBtn.addEventListener('click', ()=>{
      showTab('appointments');
    });
    function showTab(tabName){
      calendarTabBtn.classList.remove('active');
      appointmentsTabBtn.classList.remove('active');
      calendarTab.classList.remove('active');
      appointmentsTab.classList.remove('active');
      if(tabName==='calendar'){
        calendarTabBtn.classList.add('active');
        calendarTab.classList.add('active');
      }else{
        appointmentsTabBtn.classList.add('active');
        appointmentsTab.classList.add('active');
      }
    }

    // 1) Calendar tab => monthly
    const monthInput=document.getElementById('month-input');
    const monthHeader=document.getElementById('month-header');
    const monthGrid=document.getElementById('month-grid');
    const dayOfWeekShort=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    monthInput.addEventListener('change', loadMonth);

    function loadMonth(){
      // Clear
      monthHeader.innerHTML='';
      monthGrid.innerHTML='';
      // Day headers
      dayOfWeekShort.forEach(d=>{
        const div=document.createElement('div');
        div.textContent=d;
        div.style.textAlign='center';
        div.style.fontWeight='bold';
        monthHeader.appendChild(div);
      });
      const mVal=monthInput.value;
      if(!mVal)return;
      const [yyyy,mm]=mVal.split('-').map(Number);
      // first day
      const firstDate=new Date(yyyy,mm-1,1);
      const firstDayIndex=firstDate.getDay();
      // last day
      const lastDate=new Date(yyyy,mm,0);
      const totalDays=lastDate.getDate();
      // fill blank
      for(let i=0;i<firstDayIndex;i++){
        const cell=document.createElement('div');
        cell.classList.add('calendar-cell');
        cell.style.background='#222';
        monthGrid.appendChild(cell);
      }
      // fill days
      for(let d=1; d<=totalDays; d++){
        const cell=document.createElement('div');
        cell.classList.add('calendar-cell');
        cell.innerHTML=`<div class="day-label">${d}</div>`;
        // Maybe future: click => daily detail
        monthGrid.appendChild(cell);
      }
    }

    // 2) Appointments tab => date range + checkboxes
    const startDate=document.getElementById('start-date');
    const endDate=document.getElementById('end-date');
    const chkAppt=document.getElementById('chk-appointment');
    const chkWalkin=document.getElementById('chk-walkin');
    const apptsList=document.getElementById('appts-list');

    // Whenever user changes date or checkboxes => reload
    [startDate,endDate,chkAppt,chkWalkin].forEach(el=>{
      el.addEventListener('change', loadAppointments);
    });

    async function loadAppointments(){
      apptsList.innerHTML='';
      const sVal=startDate.value;
      const eVal=endDate.value;
      if(!sVal||!eVal)return; // need both
      // gather types
      let arrTypes=[];
      if(chkAppt.checked) arrTypes.push('appointment');
      if(chkWalkin.checked) arrTypes.push('walk-in');
      if(arrTypes.length===0){
        apptsList.innerHTML='<p>You have unchecked both Appointment and Walk-in.</p>';
        return;
      }

      // fetch
      let query=supabase
        .from('artist_appointments')
        .select('*')
        .gte('date', sVal)
        .lte('date', eVal)
        .in('appointment_type', arrTypes)
        .order('date',{ascending:false});

      const {data:appts,error}=await query;
      if(error){
        console.error(error);
        apptsList.innerHTML='<p>Error loading appointments.</p>';
        return;
      }
      if(!appts||appts.length===0){
        apptsList.innerHTML='<p>No appointments found for the selected range and types.</p>';
        return;
      }
      // Sort ascending or descending as you want
      // let's do descending by date
      appts.sort((a,b)=>{
        let da=new Date(a.date+'T'+(a.start_time||'00:00'));
        let db=new Date(b.date+'T'+(b.start_time||'00:00'));
        return db-da; // descending
      });
      // build
      appts.forEach(ap=>{
        const div=document.createElement('div');
        div.classList.add('appt-item');
        div.innerHTML=`
          <h4>${ap.date} ${ap.start_time||''}-${ap.end_time||''}</h4>
          <p>Type: ${ap.appointment_type}</p>
          <p>Client: ${ap.client_name||'N/A'}</p>
          <p>Phone: ${ap.client_phone||'N/A'}</p>
          <p>Email: ${ap.email||'N/A'}</p>
          <p>Price: $${(ap.price||0).toFixed(2)} (Deposit: $${(ap.deposit||0).toFixed(2)})</p>
          <p>Notes: ${ap.notes||''}</p>
        `;
        apptsList.appendChild(div);
      });
    }

    // On load => check Auth, set default month to current
    window.addEventListener('DOMContentLoaded',()=>{
      // check user auth
      const userId=localStorage.getItem('currentUserId');
      if(!userId){
        window.location.href='login.html';
        return;
      }
      // default month => this month
      const now=new Date();
      const y=now.getFullYear();
      const m=(now.getMonth()+1).toString().padStart(2,'0');
      document.getElementById('month-input').value=`${y}-${m}`;
      loadMonth();
      // default appointments => no range set yet
      // user can set range & type
    });
  </script>
</body>
</html>
