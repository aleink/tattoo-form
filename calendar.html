<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 
    Content Security Policy allowing 'unsafe-eval' and 'unsafe-inline' for Supabase,
    plus connect-src for your domain. Adjust as needed.
  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 10px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .top-bar h1 {
      margin: 0;
    }
    #logout-btn {
      margin-left: 20px;
      background: #f44336;
      color: #fff;
      cursor: pointer;
      padding: 6px 12px;
      border: none;
    }
    .view-buttons button {
      margin-right: 8px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #yearly-view, #monthly-view, #daily-view {
      display: none;
      margin-top: 20px;
    }
    .calendar-grid {
      display: grid;
      gap: 10px;
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
    }
    .month-grid {
      grid-template-columns: repeat(7, 1fr);
    }
    .calendar-cell {
      border: 1px solid #ccc;
      padding: 8px;
      min-height: 80px;
      position: relative;
      cursor: pointer;
    }
    #daily-container {
      position: relative;
      height: 960px; /* 8:00 -> 24:00 => 16 hours => 16*60=960 minutes */
      border: 1px solid #ccc;
      overflow-y: auto;
      margin-top: 20px;
      background: #f9f9f9;
    }
    /* Hour lines */
    .hour-line {
      position: absolute;
      left: 0;
      width: 100%;
      border-top: 1px dashed #ccc;
      color: #777;
      font-size: 12px;
      padding-left: 5px;
    }
    /* Artist schedule block (translucent) */
    .schedule-block {
      position: absolute;
      left: 0;
      right: 0;
      background-color: rgba(0,0,0,0.05);
      border-left: 4px solid #aaa;
      color: #000;
      padding: 2px;
      font-size: 0.75em;
      box-sizing: border-box;
      pointer-events: none; /* so clicks pass through to time slots/appointments */
    }
    /* Vacation block (grey override) */
    .vacation-block {
      position: absolute;
      left: 0;
      right: 0;
      background-color: rgba(128,128,128,0.2);
      border-left: 4px solid #888;
      color: #222;
      padding: 2px;
      font-size: 0.8em;
      box-sizing: border-box;
      pointer-events: none;
      font-weight: bold;
    }
    /* Appointment block */
    .appointment-block {
      position: absolute;
      background: #ddd;
      color: #000;
      border-radius: 4px;
      padding: 2px 4px;
      font-size: 0.85em;
      box-sizing: border-box;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>Calendar</h1>
    <div>
      <button id="logout-btn">Logout</button>
    </div>
  </div>

  <div class="view-buttons">
    <button id="year-btn">Yearly View</button>
    <button id="month-btn">Monthly View</button>
    <button id="day-btn">Daily View</button>
  </div>

  <!-- YEARLY VIEW -->
  <div id="yearly-view">
    <h2>Yearly View (Placeholder)</h2>
    <p>Switch to Month or Day for detailed scheduling.</p>
  </div>

  <!-- MONTHLY VIEW -->
  <div id="monthly-view">
    <h2>Monthly View</h2>
    <div>
      <input type="month" id="month-input" />
      <button id="load-month">Load Month</button>
    </div>
    <div class="calendar-grid month-grid" id="month-grid"></div>
  </div>

  <!-- DAILY VIEW -->
  <div id="daily-view">
    <h2>Daily View</h2>
    <div>
      <input type="date" id="day-input" />
      <button id="load-day">Load Day</button>
    </div>

    <!-- Artist Filter Checkboxes -->
    <div id="artist-filter-container" style="margin-top:10px;"></div>

    <div id="daily-container"></div>
  </div>

  <!-- Supabase JS (v1.35.7) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    const supabaseUrl = 'https://shlvjhipxnslrncczopn.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const logoutBtn = document.getElementById('logout-btn');
    const yearBtn = document.getElementById('year-btn');
    const monthBtn = document.getElementById('month-btn');
    const dayBtn = document.getElementById('day-btn');
    const yearlyView = document.getElementById('yearly-view');
    const monthlyView = document.getElementById('monthly-view');
    const dailyView = document.getElementById('daily-view');
    const monthInput = document.getElementById('month-input');
    const loadMonthBtn = document.getElementById('load-month');
    const monthGrid = document.getElementById('month-grid');
    const dayInput = document.getElementById('day-input');
    const loadDayBtn = document.getElementById('load-day');
    const dailyContainer = document.getElementById('daily-container');
    const artistFilterContainer = document.getElementById('artist-filter-container');

    let currentUserId = localStorage.getItem('currentUserId');
    let currentLocationId = localStorage.getItem('currentLocationId');
    let currentUserRole = localStorage.getItem('currentUserRole');
    if (!currentUserId) {
      // If no user logged in, redirect to login
      window.location.href = 'login.html';
    }

    logoutBtn.addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'login.html';
    });

    function showYearly() {
      yearlyView.style.display = 'block';
      monthlyView.style.display = 'none';
      dailyView.style.display = 'none';
    }
    function showMonthly() {
      yearlyView.style.display = 'none';
      monthlyView.style.display = 'block';
      dailyView.style.display = 'none';
    }
    function showDaily() {
      yearlyView.style.display = 'none';
      monthlyView.style.display = 'none';
      dailyView.style.display = 'block';
    }
    yearBtn.addEventListener('click', showYearly);
    monthBtn.addEventListener('click', showMonthly);
    dayBtn.addEventListener('click', showDaily);

    // On page load => default monthly view
    function checkAuth() {
      if (!currentUserId) {
        window.location.href = 'login.html';
      }
    }

    function initPage() {
      showMonthly();
      loadArtistsForUserLocation();
    }

    // 1. Load artists for the userâ€™s location into checkboxes
    async function loadArtistsForUserLocation() {
      artistFilterContainer.innerHTML = '';
      // If user has location, filter by that. If no location, consider showing all or none
      let { data: artists, error } = await supabase
        .from('artists')
        .select('id, artist_name, color, location_id');

      if (error) {
        console.error(error);
        return;
      }
      // If user only sees their location:
      if (currentLocationId) {
        artists = artists.filter(a => a.location_id === currentLocationId);
      }

      artists.forEach(art => {
        const div = document.createElement('div');
        div.style.display = 'inline-block';
        div.style.marginRight = '10px';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = art.id;
        cb.id = 'artist-filter-' + art.id;
        cb.checked = true; // default show
        div.appendChild(cb);

        const label = document.createElement('label');
        label.htmlFor = cb.id;
        label.textContent = art.artist_name;
        div.appendChild(label);

        artistFilterContainer.appendChild(div);
      });
    }

    function getSelectedArtistIds() {
      const cbs = artistFilterContainer.querySelectorAll('input[type="checkbox"]');
      let arr = [];
      cbs.forEach(cb => {
        if (cb.checked) arr.push(cb.value);
      });
      return arr;
    }

    /********** MONTH VIEW **********/
    loadMonthBtn.addEventListener('click', () => {
      monthGrid.innerHTML = '';
      const monthVal = monthInput.value;
      if (!monthVal) return;
      const [yyyy, mm] = monthVal.split('-').map(Number);
      const firstDay = new Date(yyyy, mm-1, 1);
      const lastDay = new Date(yyyy, mm, 0);
      const totalDays = lastDay.getDate();

      for (let day = 1; day <= totalDays; day++) {
        const cell = document.createElement('div');
        cell.classList.add('calendar-cell');
        cell.innerHTML = `<div class="day-label">${day}</div>`;
        cell.addEventListener('click', () => openDay(yyyy, mm-1, day));
        monthGrid.appendChild(cell);
      }
    });

    function openDay(year, month, day) {
      showDaily();
      const dateStr = new Date(year, month, day).toISOString().split('T')[0];
      dayInput.value = dateStr;
      loadDay();
    }

    /********** DAY VIEW **********/
    loadDayBtn.addEventListener('click', loadDay);

    async function loadDay() {
      dailyContainer.innerHTML = '';
      const dayVal = dayInput.value;
      if (!dayVal) return;

      // Hour lines from 8:00 to midnight
      for (let hr = 8; hr <= 24; hr++) {
        const minutesFrom8 = (hr - 8) * 60;
        const line = document.createElement('div');
        line.classList.add('hour-line');
        line.style.top = minutesFrom8 + 'px';
        let labelHr = hr;
        let ampm = 'AM';
        if (labelHr >= 12) ampm = 'PM';
        if (labelHr > 12) labelHr -= 12;
        if (labelHr === 24) {
          labelHr = 12; 
          ampm = 'AM';
        }
        line.textContent = `${labelHr}:00 ${ampm}`;
        dailyContainer.appendChild(line);
      }

      // 1. Get selected artists
      const artistIds = getSelectedArtistIds();
      if (artistIds.length === 0) return;

      // 2. For each artist, fetch row from `artists` (for schedule) + check if day is in a vacation
      // We'll do a single query for all artists, or we can do them individually
      let { data: artists, error: artErr } = await supabase
        .from('artists')
        .select('*')
        .in('id', artistIds);
      if (artErr) {
        console.error(artErr);
        return;
      }

      // Also fetch `artist_vacations` for this date
      // We'll see which artists have a vacation that covers dayVal
      let { data: vacs, error: vacErr } = await supabase
        .from('artist_vacations')
        .select('*')
        .lte('vacation_start', dayVal)
        .gte('vacation_end', dayVal); 
      // This means vacation_start <= dayVal <= vacation_end
      // If the vacation_end < dayVal or vacation_start> dayVal, not a match
      if (vacErr) {
        console.error(vacErr);
        return;
      }

      // Let's parse the dayOfWeek
      const dayNames = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
      const dayIndex = new Date(dayVal).getDay();
      const dayName = dayNames[dayIndex]; // e.g. 'monday'

      // Build a map so we can quickly see if an artist is on vacation
      // We'll store vacMap[artist_id] = true if dayVal is in that range
      let vacMap = {};
      vacs.forEach(v => {
        vacMap[v.artist_id] = true;
      });

      // For each artist => schedule block
      for (let art of artists) {
        const startCol = dayName + '_start';
        const endCol   = dayName + '_end';
        let stVal = art[startCol];
        let enVal = art[endCol];
        // If they don't have a schedule for this day, skip
        if (!stVal || !enVal) continue;

        const topMin = toMinutes(stVal) - 8*60;
        const endMin = toMinutes(enVal) - 8*60;
        if (topMin >= endMin) continue; // invalid or zero-length

        // Check if they're on vacation => override
        if (vacMap[art.id]) {
          // Show a grey vacation block from schedule start to end
          const vacDiv = document.createElement('div');
          vacDiv.classList.add('vacation-block');
          const label = `${art.artist_name} (Vacation)`;
          vacDiv.textContent = label;
          vacDiv.style.top = Math.max(topMin, 0) + 'px';
          vacDiv.style.height = Math.min(endMin, 960) - Math.max(topMin,0) + 'px';
          dailyContainer.appendChild(vacDiv);
        } else {
          // Show schedule block with a partial alpha
          const schedDiv = document.createElement('div');
          schedDiv.classList.add('schedule-block');
          // Make it tinted with artist's color if you prefer, or just a generic alpha
          // We'll color the left border with their color
          if (art.color) schedDiv.style.borderLeftColor = art.color;
          const label = `${art.artist_name} (Working Hours)`;
          schedDiv.textContent = label;
          schedDiv.style.top = Math.max(topMin, 0) + 'px';
          schedDiv.style.height = Math.min(endMin, 960) - Math.max(topMin,0) + 'px';
          dailyContainer.appendChild(schedDiv);
        }
      }

      // 3. Fetch appointments for the day
      let { data: appts, error: apptErr } = await supabase
        .from('artist_appointments')
        .select('*')
        .eq('date', dayVal);
      if (apptErr) {
        console.error(apptErr);
        return;
      }
      // filter out artists not in selected
      appts = appts.filter(a => artistIds.includes(a.artist_id));

      // 4. Overlapping columns logic for appointments
      appts.sort((a,b) => toMinutes(a.start_time) - toMinutes(b.start_time));
      let columns = [];
      function appointmentsOverlap(a, b) {
        const aStart = toMinutes(a.start_time);
        const aEnd   = toMinutes(a.end_time);
        const bStart = toMinutes(b.start_time);
        const bEnd   = toMinutes(b.end_time);
        return (aStart < bEnd && bStart < aEnd);
      }
      for (let ap of appts) {
        let placed = false;
        for (let col of columns) {
          let lastInCol = col[col.length - 1];
          if (!appointmentsOverlap(lastInCol, ap)) {
            col.push(ap);
            placed = true;
            break;
          }
        }
        if (!placed) columns.push([ap]);
      }

      columns.forEach((col, colIndex) => {
        col.forEach(ap => {
          const startNum = toMinutes(ap.start_time) - 8*60;
          const endNum   = toMinutes(ap.end_time) - 8*60;
          const blockTop = Math.max(startNum, 0);
          const blockHeight = Math.max(endNum - startNum, 5);
          const block = document.createElement('div');
          block.classList.add('appointment-block');

          // color
          // if the artist has a color, we use it
          let artColor = '#ddd';
          const theArtist = artists.find(a => a.id === ap.artist_id);
          if (theArtist && theArtist.color) artColor = theArtist.color;
          block.style.backgroundColor = artColor;

          const leftBase = 90;
          const colWidth = 110;
          block.style.left = (leftBase + colIndex * colWidth) + 'px';
          block.style.width = (colWidth - 10) + 'px';
          block.style.top = blockTop + 'px';
          block.style.height = Math.min(blockHeight, 960 - blockTop) + 'px';

          // label
          const artName = theArtist ? theArtist.artist_name : '???';
          const who = `${artName} - ${ap.client_name || 'N/A'} (${ap.appointment_type})`;
          block.textContent = who;

          block.addEventListener('click', (evt) => {
            evt.stopPropagation();
            openExistingApptModal(ap.id);
          });
          dailyContainer.appendChild(block);
        });
      });
    }

    function toMinutes(hhmm) {
      if (!hhmm) return 0;
      const [h,m] = hhmm.split(':').map(Number);
      return h*60 + m;
    }

    // open existing appointment modal
    function openExistingApptModal(apptId) {
      // redirect or open your existing logic
      alert(`Open/modify appointment ID: ${apptId} (Implement as needed)`);
    }

    window.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      initPage();
    });
  </script>
</body>
</html>
