<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Artists</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <!-- ─────  VISUAL THEMES  ───── -->
  <style>
    :root{          /* dark – default */
      --bg-0:#111; --bg-1:#222; --bg-2:#333;
      --border:#444; --text:#fff;--text-dim:#ccc;--accent:#28a745;
    }
    body.light{     /* light override */
      --bg-0:#f5f5f5;--bg-1:#fff;--bg-2:#e4e4e4;
      --border:#bbb;--text:#000;--text-dim:#444;--accent:#0d6efd;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Helvetica Neue',Arial,sans-serif}
    body{background:var(--bg-0);color:var(--text);max-width:780px;margin:20px auto;padding:20px;transition:.25s background}
    h1{text-align:center;margin-bottom:18px}
    h2{margin:8px 0 14px}
    .login-section,.manage-section{background:var(--bg-1);border:1px solid var(--border);border-radius:6px;padding:18px;margin-bottom:24px}
    label{font-weight:700;display:block;margin:10px 0 4px}
    input,select,textarea{
      width:100%;padding:8px;background:var(--bg-0);color:var(--text);
      border:1px solid var(--border);border-radius:4px;margin-bottom:12px;resize:vertical
    }
    input:focus,select:focus,textarea:focus{outline:2px solid var(--accent)}
    button{background:var(--bg-2);color:var(--text);border:none;border-radius:4px;padding:8px 16px;cursor:pointer;transition:background .2s}
    button:hover{background:#555}
    .btn-mini{padding:4px 10px;font-size:.85em;margin-right:6px}
    .switch-wrap{display:flex;align-items:center;gap:8px;margin-bottom:12px}
    .message{color:#ff6b6b;margin-top:8px;font-size:.9em}
    .hidden{display:none}
    .table-container{max-height:320px;overflow-y:auto;margin-top:10px;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;font-size:.9em}
    th{position:sticky;top:0;background:var(--bg-1);color:var(--text);border-bottom:2px solid var(--border);padding:10px}
    td{padding:8px;border-bottom:1px solid var(--border);color:var(--text-dim)}
    tr:nth-child(even){background:var(--bg-0)}
  </style>
</head>
<body>
  <h1>Manage Artists</h1>

  <!-- theme switch -->
  <div class="switch-wrap">
    <label><input type="checkbox" id="theme-toggle"> Light&nbsp;mode</label>
  </div>

  <!-- Login Section -->
  <div class="login-section" id="login-section">
    <label>Email</label><input type="email" id="email">
    <label>Password</label><input type="password" id="password">
    <button id="login-btn">Login</button>
    <div class="message" id="login-message"></div>
  </div>

  <!-- Artist Management Section -->
  <div class="manage-section hidden" id="manage-section">
    <h2>Add / Edit Artist</h2>

    <label>Artist Name</label><input id="artist-name" type="text">
    <label>Phone</label><input id="artist-phone" type="text">
    <label>Email</label><input id="artist-email" type="email">
    <label>Calendar ID (optional)</label><input id="artist-calendar" type="text">
    <label>Percentage Split</label><input id="artist-split" type="number">
    <label>Portfolio link</label><input id="artist-portfolio" type="url">
    <label>About the artist</label><textarea id="artist-bio" rows="3"></textarea>

    <label>Color</label>
    <select id="artist-color">
      <option value="">-- Random on Insert --</option>
      <option value="#FF0000">Red</option><option value="#00FF00">Green</option>
      <option value="#0000FF">Blue</option><option value="#FFA500">Orange</option>
      <option value="#1abc9c">Teal</option><option value="#ddd">Gray</option>
    </select>

    <label>Location</label><select id="artist-location"></select>

    <div>
      <button id="save-artist-btn">Save Artist</button>
      <button id="clear-artist-btn">Clear Fields</button>
      <div class="message" id="artist-message"></div>
    </div>

    <hr style="border-color:var(--border);margin:20px 0">

    <label>Filter by Location</label>
    <select id="filter-location"><option value="">-- All Locations --</option></select>

    <div class="table-container">
      <table id="artists-table">
        <thead>
          <tr><th>Name</th><th>Phone</th><th>Email</th><th>Split</th><th>Location</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    /* ---------- Supabase init ---------- */
    const supabase=window.supabase.createClient(
      'https://shlvjhipxnslrncczopn.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
    );

    /* ---------- DOM refs ---------- */
    const loginSec=document.getElementById('login-section');
    const manageSec=document.getElementById('manage-section');
    const emailInp=document.getElementById('email');
    const passInp=document.getElementById('password');
    const loginBtn=document.getElementById('login-btn');
    const loginMsg=document.getElementById('login-message');

    const nameInp=document.getElementById('artist-name');
    const phoneInp=document.getElementById('artist-phone');
    const mailInp=document.getElementById('artist-email');
    const calInp=document.getElementById('artist-calendar');
    const splitInp=document.getElementById('artist-split');
    const colorSel=document.getElementById('artist-color');
    const locSel=document.getElementById('artist-location');
    const portInp=document.getElementById('artist-portfolio');
    const bioInp=document.getElementById('artist-bio');
    const saveBtn=document.getElementById('save-artist-btn');
    const clearBtn=document.getElementById('clear-artist-btn');
    const artMsg=document.getElementById('artist-message');

    const filterLoc=document.getElementById('filter-location');
    const tbody=document.querySelector('#artists-table tbody');

    /* ---------- SESSION ---------- */
    let role='', allowedLocation='';
    let currentArtistId=null;

    /* ---------- THEME SWITCH ---------- */
    const themeToggle=document.getElementById('theme-toggle');
    themeToggle.onchange=()=>document.body.classList.toggle('light',themeToggle.checked);

    /* ---------- LOGIN ---------- */
    loginBtn.onclick=async()=>{
      loginMsg.textContent='';
      if(!emailInp.value||!passInp.value){loginMsg.textContent='Email & password required.';return;}
      const {data,error}=await supabase.from('users').select('*').eq('email',emailInp.value.trim());
      if(error||!data.length){loginMsg.textContent='Invalid credentials.';return;}
      const u=data[0];
      if(u.password_hash!==passInp.value.trim()){loginMsg.textContent='Invalid credentials.';return;}

      role=u.role;allowedLocation=u.location_id||'';
      const allowed=['gm','hr','sr','sm'];
      if(!allowed.includes(role)){loginMsg.textContent='Access denied for this role.';return;}

      loginSec.classList.add('hidden');
      manageSec.classList.remove('hidden');
      await loadLocations();
      loadArtists();
    };

    /* ---------- LOAD LOCATIONS ---------- */
    async function loadLocations(){
      locSel.innerHTML='';
      filterLoc.innerHTML='<option value="">-- All Locations --</option>';
      let q=supabase.from('locations').select('*');
      if(['sr','sm'].includes(role))q=q.eq('id',allowedLocation);
      const {data}=await q;
      data.forEach(l=>{
        const o1=document.createElement('option');o1.value=l.id;o1.textContent=l.location_name;locSel.appendChild(o1);
        const o2=document.createElement('option');o2.value=l.id;o2.textContent=l.location_name;filterLoc.appendChild(o2);
      });
      if(['sr','sm'].includes(role)){
        filterLoc.value=allowedLocation;
        filterLoc.disabled=true;
      }
    }

    /* ---------- LOAD ARTISTS ---------- */
    async function loadArtists(){
      tbody.innerHTML='';
      let q=supabase.from('artists').select('*, locations(location_name)').order('artist_name',{ascending:true});
      if(filterLoc.value)q=q.eq('location_id',filterLoc.value);
      const {data}=await q;
      data.forEach(a=>{
        const tr=document.createElement('tr');
        tr.dataset.artist=JSON.stringify(a);
        tr.innerHTML=`<td>${a.artist_name}</td><td>${a.phone||''}</td><td>${a.email||''}</td>
          <td>${a.percentage_split||''}</td><td>${a.locations? a.locations.location_name:''}</td>
          <td><button class="btn-mini" onclick="editArtist('${a.id}')">Edit</button>
              <button class="btn-mini" onclick="deleteArtist('${a.id}')">Del</button></td>`;
        tbody.appendChild(tr);
      });
    }
    filterLoc.onchange=loadArtists;

    /* ---------- CRUD ---------- */
    window.editArtist=async(id)=>{
      const row=[...tbody.children].find(r=>JSON.parse(r.dataset.artist).id===id);
      if(!row)return;
      const a=JSON.parse(row.dataset.artist);currentArtistId=a.id;
      nameInp.value=a.artist_name||'';phoneInp.value=a.phone||'';mailInp.value=a.email||'';
      calInp.value=a.calendar_id||'';splitInp.value=a.percentage_split||'';
      colorSel.value=a.color||'';locSel.value=a.location_id||'';portInp.value=a.portfolio||'';bioInp.value=a.bio||'';
      artMsg.textContent='Editing – remember to Save.';
    };

    window.deleteArtist=async(id)=>{
      if(!confirm('Delete artist?'))return;
      const {error}=await supabase.from('artists').delete().eq('id',id);
      artMsg.textContent=error?'Error deleting.':'Deleted.';loadArtists();clearForm();
    };

    saveBtn.onclick=async()=>{
      artMsg.textContent='';
      if(!nameInp.value.trim()){artMsg.textContent='Name required.';return;}
      const payload={
        artist_name:nameInp.value.trim(),
        phone:phoneInp.value.trim()||null,
        email:mailInp.value.trim()||null,
        calendar_id:calInp.value.trim()||null,
        percentage_split:splitInp.value?parseFloat(splitInp.value):null,
        color:colorSel.value||null,
        location_id:locSel.value||null,
        portfolio:portInp.value.trim()||null,
        bio:bioInp.value.trim()||null
      };
      let res;
      if(currentArtistId)res=await supabase.from('artists').update(payload).eq('id',currentArtistId);
      else               res=await supabase.from('artists').insert([payload]);
      artMsg.textContent=res.error?'Error saving.':'Saved!';
      if(!res.error){loadArtists();clearForm();}
    };
    clearBtn.onclick=clearForm;
    function clearForm(){
      currentArtistId=null;
      [nameInp,phoneInp,mailInp,calInp,splitInp,portInp,bioInp].forEach(i=>i.value='');
      colorSel.value='';locSel.value='';artMsg.textContent='';
    }

    /* ---------- expose for inline buttons ---------- */
    window.deleteArtist=window.deleteArtist;
    window.editArtist  =window.editArtist;
  </script>
</body>
</html>
