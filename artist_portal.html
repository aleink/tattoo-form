<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Artist Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ── strict CSP; websocket allowed for Supabase realtime ── -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    /* ————— dark palette (unchanged visuals) ————— */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Helvetica Neue',Arial,sans-serif;background:#111;color:#fff;min-height:100vh;display:flex;flex-direction:column}
    header{background:#000;border-bottom:2px solid #444;padding:20px;text-align:center}
    header h1{font-size:1.8rem;color:#fff;margin-bottom:5px}
    header p{color:#bbb;font-size:.9rem}
    main{flex:1;max-width:900px;margin:20px auto;padding:10px}
    .section-box{background:#222;border:1px solid #444;border-radius:6px;padding:15px;margin-bottom:20px}
    label{display:block;font-weight:700;margin-bottom:4px}
    input,select,button{width:100%;padding:8px;margin-bottom:10px;background:#333;color:#fff;border:1px solid #555;border-radius:4px}
    button:hover{background:#444}
    .tab-buttons{display:flex;gap:10px;margin-bottom:10px}
    .tab-buttons button{flex:1;cursor:pointer;background:#333;border:1px solid #555}
    .tab-buttons button.active{background:#555}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .message{color:#f33;margin-top:8px}
    .appt-list{margin-top:10px}
    .appt-item{background:#333;border:1px solid #444;padding:10px;margin-bottom:8px;border-radius:4px}
    .appt-item h4{margin-bottom:5px;font-size:1rem;color:#fff}
    .appt-item p{color:#ccc;margin-bottom:4px;font-size:.9rem}
    .appt-total{margin-top:10px;font-weight:700;color:#0f0}
    /* calendar */
    .calendar-nav{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .calendar-nav button{width:auto;margin-bottom:0}
    .calendar-month-label{font-weight:700;font-size:1rem;text-align:center}
    .earn-month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
    .day-cell{background:#333;border:1px solid #444;border-radius:4px;text-align:center;min-height:60px;cursor:pointer;padding:5px;position:relative}
    .day-cell:hover{background:#444}
    .day-has-appts{background:#666!important}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #444;padding:6px;text-align:left}
    .no-appts{color:#aaa;font-style:italic;margin-top:5px}
    .day-cell strong{font-weight:700;font-size:1.2em;display:block;margin-top:2px}
    /* modal */
    .modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);justify-content:center;align-items:center;z-index:999}
    .modal-bg.active{display:flex}
    .modal-content{background:#222;border:1px solid #444;border-radius:6px;padding:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
    .modal-content h3{margin-bottom:10px}
    .modal-content button.close-btn{background:#f33;width:auto;margin:10px 0 0}
    /* logout button (grey) */
    #logout-btn{background:#333!important;border:1px solid #555;width:auto;margin-bottom:10px}
    #logout-btn:hover{background:#444!important}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
</head>
<body>
  <header>
    <h1 id="portal-title">Artist Portal</h1>
    <p id="portal-subtitle">Welcome, <span id="artist-name-span">Artist</span>! Check your schedule and track your earnings.</p>
  </header>
  <main>
    <!-- Login box -->
    <div class="section-box" id="login-section">
      <h2>Login</h2>
      <label>Email</label><input type="email" id="artist-email" placeholder="example@domain.com">
      <label>Password</label><input type="password" id="artist-password" placeholder="password">
      <button id="artist-login-btn">Login</button>
      <div class="message" id="login-message"></div>
    </div>

    <!-- Portal -->
    <div class="section-box" id="portal-section" style="display:none;">
      <button id="logout-btn">Logout</button>

      <div class="tab-buttons">
        <button id="tab-schedule-btn" class="active">Schedule</button>
        <button id="tab-earnings-btn">Earnings</button>
      </div>

      <!-- Schedule tab -->
      <div class="tab-content active" id="schedule-tab">
        <h2>My Upcoming Appointments</h2>
        <div id="schedule-message" class="message"></div>
        <div class="appt-list" id="upcoming-list"></div>
        <div class="appt-total" id="upcoming-total"></div>
      </div>

      <!-- Earnings tab -->
      <div class="tab-content" id="earnings-tab">
        <h2>My Earnings</h2>
        <div class="calendar-nav">
          <button id="earn-prev-month">&lt;&lt; Prev</button>
          <span id="earn-month-label" class="calendar-month-label"></span>
          <button id="earn-next-month">Next &gt;&gt;</button>
        </div>
        <div id="earnings-month-grid" class="earn-month-grid"></div>

        <label for="range-start">Start Date</label>
        <input type="date" id="range-start">
        <label for="range-end">End Date</label>
        <input type="date" id="range-end">
        <button id="range-generate-btn">Generate Summary</button>
        <div class="message" id="range-message"></div>
        <table id="range-summary-table" style="display:none;">
          <thead><tr><th>Total Sold</th><th>Your Cut</th><th>Total Tips</th><th>Grand Total</th></tr></thead>
          <tbody><tr><td id="sum-total-sold"></td><td id="sum-cut"></td><td id="sum-tips"></td><td id="sum-grand"></td></tr></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- day detail modal -->
  <div class="modal-bg" id="day-detail-modal">
    <div class="modal-content">
      <h3 id="day-modal-title"></h3>
      <div id="day-modal-body"></div>
      <button class="close-btn" id="day-modal-close">Close</button>
    </div>
  </div>

  <script>
/* -------- Supabase -------- */
const supabase=window.supabase.createClient(
  'https://shlvjhipxnslrncczopn.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ'
);

/* -------- DOM refs -------- */
const loginSec=document.getElementById('login-section');
const emailIn=document.getElementById('artist-email');
const passIn=document.getElementById('artist-password');
const loginBtn=document.getElementById('artist-login-btn');
const loginMsg=document.getElementById('login-message');

const portal=document.getElementById('portal-section');
const logoutBtn=document.getElementById('logout-btn');
const nameSpan=document.getElementById('artist-name-span');

const tabSchedBtn=document.getElementById('tab-schedule-btn');
const tabEarnBtn=document.getElementById('tab-earnings-btn');
const schedTab=document.getElementById('schedule-tab');
const earnTab=document.getElementById('earnings-tab');

const schedMsg=document.getElementById('schedule-message');
const upcomingList=document.getElementById('upcoming-list');
const upcomingTotal=document.getElementById('upcoming-total');

const earnPrev=document.getElementById('earn-prev-month');
const earnNext=document.getElementById('earn-next-month');
const earnLabel=document.getElementById('earn-month-label');
const earnGrid=document.getElementById('earnings-month-grid');

const rStart=document.getElementById('range-start');
const rEnd=document.getElementById('range-end');
const rGen=document.getElementById('range-generate-btn');
const rMsg=document.getElementById('range-message');
const sumTable=document.getElementById('range-summary-table');
const sumSold=document.getElementById('sum-total-sold');
const sumCut=document.getElementById('sum-cut');
const sumTips=document.getElementById('sum-tips');
const sumGrand=document.getElementById('sum-grand');

const dayModal=document.getElementById('day-detail-modal');
const dayTitle=document.getElementById('day-modal-title');
const dayBody=document.getElementById('day-modal-body');
const dayClose=document.getElementById('day-modal-close');

/* -------- state -------- */
let artist=null;
let mYear=0,mMonth=0;
/* realtime subscription holder */
let apptSub=null;

/* -------- helpers -------- */
const monthName=m=>['January','February','March','April','May','June','July','August','September','October','November','December'][m-1];

/* -------- login -------- */
loginBtn.onclick=async()=>{
  loginMsg.textContent='';
  if(!emailIn.value||!passIn.value){loginMsg.textContent='Email & password required.';return;}
  const {data,error}=await supabase.from('artists').select('*').eq('email',emailIn.value.trim());
  if(error||!data.length){loginMsg.textContent='Artist not found.';return;}
  if(data[0].password!==passIn.value.trim()){loginMsg.textContent='Incorrect password.';return;}
  artist=data[0];
  nameSpan.textContent=artist.artist_name||'Artist';
  loginSec.style.display='none';
  portal.style.display='block';
  loadUpcoming();
  const now=new Date();mYear=now.getFullYear();mMonth=now.getMonth()+1;drawMonth();

  /* ---- set up realtime subscription AFTER initial draw ---- */
  if(apptSub){supabase.removeSubscription(apptSub);}
  apptSub=supabase
    .from(`artist_appointments:artist_id=eq.${artist.id}`)
    .on('*', payload=>{
      // simple strategy: refresh affected areas
      loadUpcoming();
      drawMonth();
      // if day-modal open for this date, refresh it
      if(dayModal.classList.contains('active') && dayTitle.textContent.includes(payload.new?.date || payload.old?.date)){
        const [y,m,d]=dayTitle.textContent.match(/\d{4}-\d{2}-\d{2}/)[0].split('-');
        openDay(+y,+m,+d);
      }
    })
    .subscribe();
};

/* -------- logout -------- */
logoutBtn.onclick=()=>{
  artist=null;
  if(apptSub){supabase.removeSubscription(apptSub);apptSub=null;}
  portal.style.display='none';
  loginSec.style.display='block';
  emailIn.value='';passIn.value='';loginMsg.textContent='';
};

/* -------- tab switching -------- */
tabSchedBtn.onclick=()=>{tabSchedBtn.classList.add('active');tabEarnBtn.classList.remove('active');schedTab.classList.add('active');earnTab.classList.remove('active');};
tabEarnBtn.onclick=()=>{tabEarnBtn.classList.add('active');tabSchedBtn.classList.remove('active');earnTab.classList.add('active');schedTab.classList.remove('active');};

/* -------- upcoming appointments (type='appointment' future) -------- */
async function loadUpcoming(){
  upcomingList.innerHTML='';upcomingTotal.textContent='';schedMsg.textContent='';
  const today=new Date().toISOString().slice(0,10);
  const {data,error}=await supabase.from('artist_appointments')
    .select('*')
    .eq('artist_id',artist.id)
    .eq('appointment_type','appointment')
    .gte('date',today)
    .order('date',{ascending:true})
    .order('start_time',{ascending:true});
  if(error){schedMsg.textContent='Error loading.';return;}
  if(!data.length){schedMsg.textContent='No upcoming appointments.';return;}
  let total=0;
  data.forEach(ap=>{
    total+=ap.price||0;
    const div=document.createElement('div');
    div.className='appt-item';
    div.innerHTML=`<h4>${ap.date} ${ap.start_time||''}-${ap.end_time||''}</h4>
    <p>Client: ${ap.client_name||'N/A'}</p>
    <p>Phone: ${ap.client_phone||'N/A'}</p>
    <p>Email: ${ap.email||'N/A'}</p>
    <p>Price: $${(ap.price||0).toFixed(2)}</p>`;
    upcomingList.appendChild(div);
  });
  upcomingTotal.textContent=`Total Potential: $${total.toFixed(2)}`;
}

/* -------- monthly earnings (walk-in OR completed) -------- */
earnPrev.onclick=()=>{mMonth--;if(mMonth<1){mMonth=12;mYear--;}drawMonth();};
earnNext.onclick=()=>{mMonth++;if(mMonth>12){mMonth=1;mYear++;}drawMonth();};

async function drawMonth(){
  earnGrid.innerHTML='';earnLabel.textContent=`${monthName(mMonth)} ${mYear}`;
  const first=new Date(mYear,mMonth-1,1), firstIdx=first.getDay();
  const lastDay=new Date(mYear,mMonth,0).getDate();
  const start=`${mYear}-${String(mMonth).padStart(2,'0')}-01`;
  const end=`${mYear}-${String(mMonth).padStart(2,'0')}-${lastDay}`;
  const {data,error}=await supabase.from('artist_appointments')
    .select('date')
    .eq('artist_id',artist.id)
    .in('appointment_type',['walk-in','completed'])
    .gte('date',start).lte('date',end);
  const has={};data?.forEach(a=>has[+a.date.slice(-2)]=true);
  for(let i=0;i<firstIdx;i++){const c=document.createElement('div');c.className='day-cell';c.style.background='#222';earnGrid.appendChild(c);}
  for(let d=1;d<=lastDay;d++){
    const cell=document.createElement('div');cell.className='day-cell';cell.textContent=d;
    if(has[d]){
      cell.classList.add('day-has-appts');
      const $=document.createElement('strong');$.textContent='$';cell.appendChild($);
      cell.onclick=()=>openDay(mYear,mMonth,d);
    }
    earnGrid.appendChild(cell);
  }
}

async function openDay(y,m,d){
  const date=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  dayTitle.textContent=`Details for ${date}`;
  dayBody.innerHTML='Loading...';
  dayModal.classList.add('active');
  const {data,error}=await supabase.from('artist_appointments')
    .select('*')
    .eq('artist_id',artist.id)
    .eq('date',date)
    .in('appointment_type',['walk-in','completed']);
  if(error){dayBody.textContent='Error.';return;}
  if(!data.length){dayBody.innerHTML='<div class="no-appts">No earnings this day.</div>';return;}
  const split=artist.percentage_split||0;
  const tbl=document.createElement('table');
  tbl.innerHTML='<thead><tr><th>Time</th><th>Type</th><th>Price</th><th>Tip</th><th>Your Cut</th><th>Total</th></tr></thead>';
  const tb=document.createElement('tbody');tbl.appendChild(tb);
  data.forEach(ap=>{
    const price=ap.price||0, tip=ap.tip||0, cut=price*(split/100), total=cut+tip;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${ap.start_time||''}-${ap.end_time||''}</td><td>${ap.appointment_type}</td>
      <td>${price.toFixed(2)}</td><td>${tip.toFixed(2)}</td><td>${cut.toFixed(2)}</td><td>${total.toFixed(2)}</td>`;
    tb.appendChild(tr);
  });
  dayBody.innerHTML='';dayBody.appendChild(tbl);
}
dayClose.onclick=()=>dayModal.classList.remove('active');

/* -------- range summary -------- */
rGen.onclick=async()=>{
  rMsg.textContent='';sumTable.style.display='none';
  if(!rStart.value||!rEnd.value){rMsg.textContent='Start & End required.';return;}
  if(rEnd.value<rStart.value){rMsg.textContent='End before start.';return;}
  const {data,error}=await supabase.from('artist_appointments')
    .select('*')
    .eq('artist_id',artist.id)
    .in('appointment_type',['walk-in','completed'])
    .gte('date',rStart.value).lte('date',rEnd.value);
  if(error){rMsg.textContent='Error.';return;}
  if(!data.length){rMsg.textContent='No data.';return;}
  const split=artist.percentage_split||0;
  let sold=0, tips=0, cut=0;
  data.forEach(ap=>{
    sold+=ap.price||0;
    tips+=ap.tip||0;
    cut+= (ap.price||0)*(split/100);
  });
  sumSold.textContent=sold.toFixed(2);
  sumCut.textContent=cut.toFixed(2);
  sumTips.textContent=tips.toFixed(2);
  sumGrand.textContent=(cut+tips).toFixed(2);
  sumTable.style.display='';
};
  </script>
</body>
</html>
