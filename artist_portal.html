<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Artist Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- 
    Content-Security-Policy:
    - 'unsafe-eval' for Supabase
    - connect-src includes your .supabase.co domain
  -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
          connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
          style-src 'self' 'unsafe-inline';
          object-src 'none';
        ">

  <style>
    /* Dark style reminiscent of your index */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #111;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #000;
      border-bottom: 2px solid #444;
      padding: 20px;
      text-align: center;
    }
    header h1 {
      font-size: 1.8rem;
      color: #fff;
      margin-bottom: 5px;
    }
    header p {
      color: #bbb;
      font-size: 0.9rem;
    }
    main {
      flex: 1;
      max-width: 900px;
      margin: 20px auto;
      padding: 10px;
    }
    .section-box {
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button:hover {
      background: #444;
    }
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .tab-buttons button {
      flex: 1;
      cursor: pointer;
      background: #333;
      border: 1px solid #555;
    }
    .tab-buttons button.active {
      background: #555;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .message {
      color: #f33;
      margin-top: 8px;
    }

    /* Upcoming appointments list */
    .appt-list {
      margin-top: 10px;
    }
    .appt-item {
      background: #333;
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
    }
    .appt-item h4 {
      margin-bottom: 5px;
      font-size: 1rem;
      color: #fff;
    }
    .appt-item p {
      color: #ccc;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }

    /* Table for summary or pop-ups */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #444;
      padding: 6px;
      text-align: left;
    }
    .no-appts {
      color: #aaa;
      font-style: italic;
      margin-top: 5px;
    }

    /* Mobile-friendly modal/popup for day detail */
    .modal-bg {
      display: none;
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-bg.active {
      display: flex;
    }
    .modal-content {
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 20px;
      max-width: 500px;
      width: 90%; /* mobile-friendly */
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content h3 {
      margin-bottom: 10px;
    }
    .modal-content button.close-btn {
      background: #f33;
      width: auto;
      margin: 10px 0 0;
    }
  </style>

  <!-- Load supabase library FIRST in the head -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
</head>
<body>
  <header>
    <h1 id="portal-title">Artist Portal</h1>
    <p id="portal-subtitle">Welcome, <span id="artist-name-span">Artist</span>! Check your schedule and track your earnings.</p>
  </header>
  <main>
    <!-- Artist Email Login Box -->
    <div class="section-box" id="login-section">
      <h2>Login (by email only)</h2>
      <label for="artist-email">Artist Email</label>
      <input type="email" id="artist-email" placeholder="example@domain.com" />
      <button id="artist-login-btn">Login</button>
      <div class="message" id="login-message"></div>
    </div>

    <!-- Main Portal with Tabs -->
    <div class="section-box" id="portal-section" style="display:none;">
      <div class="tab-buttons">
        <button id="tab-schedule-btn" class="active">Schedule</button>
        <button id="tab-earnings-btn">Earnings</button>
      </div>

      <!-- ========== SCHEDULE TAB ========== -->
      <div class="tab-content active" id="schedule-tab">
        <h2>My Upcoming Appointments</h2>
        <div id="schedule-message" class="message"></div>
        <div class="appt-list" id="upcoming-list"></div>
      </div>

      <!-- ========== EARNINGS TAB ========== -->
      <div class="tab-content" id="earnings-tab">
        <h2>My Earnings</h2>

        <!-- Day detail is triggered by date if you want a daily breakdown -->
        <div class="date-range-container">
          <label for="range-start">Start Date</label>
          <input type="date" id="range-start" />
          <label for="range-end">End Date</label>
          <input type="date" id="range-end" />
          <button id="range-generate-btn">Generate Summary</button>
          <div class="message" id="range-message"></div>
          <table id="range-summary-table" style="display:none;">
            <thead>
              <tr>
                <th>Total Sold</th>
                <th>Your Cut</th>
                <th>Total Tips</th>
                <th>Grand Total (Cut + Tips)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td id="sum-total-sold"></td>
                <td id="sum-cut"></td>
                <td id="sum-tips"></td>
                <td id="sum-grand"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Possibly a button to see daily breakdown? 
             We'll add a 'View day detail' button that asks for a date,
             then opens the modal with completed appts that day. -->
        <div style="margin-top:20px;">
          <label for="day-detail-input">View a specific day</label>
          <input type="date" id="day-detail-input" />
          <button id="day-detail-btn">View Day Detail</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal for day detail in the Earnings tab -->
  <div class="modal-bg" id="day-detail-modal">
    <div class="modal-content">
      <h3 id="day-modal-title"></h3>
      <div id="day-modal-body"></div>
      <button class="close-btn" id="day-modal-close">Close</button>
    </div>
  </div>

  <!-- Your custom code referencing `supabase`, loaded LAST -->
  <script>
    // 1) Initialize supabase
    const supabaseUrl = 'https://shlvjhipxnslrncczopn.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // 2) DOM references
    const loginSection = document.getElementById('login-section');
    const loginMsg = document.getElementById('login-message');
    const artistEmailInput = document.getElementById('artist-email');
    const artistLoginBtn = document.getElementById('artist-login-btn');

    const portalSection = document.getElementById('portal-section');
    const tabScheduleBtn = document.getElementById('tab-schedule-btn');
    const tabEarningsBtn = document.getElementById('tab-earnings-btn');
    const scheduleTab = document.getElementById('schedule-tab');
    const earningsTab = document.getElementById('earnings-tab');
    const scheduleMsg = document.getElementById('schedule-message');
    const upcomingList = document.getElementById('upcoming-list');

    // Earnings references
    const rangeStart = document.getElementById('range-start');
    const rangeEnd = document.getElementById('range-end');
    const rangeGenBtn = document.getElementById('range-generate-btn');
    const rangeMsg = document.getElementById('range-message');
    const sumTable = document.getElementById('range-summary-table');
    const sumTotalSold = document.getElementById('sum-total-sold');
    const sumCut = document.getElementById('sum-cut');
    const sumTips = document.getElementById('sum-tips');
    const sumGrand = document.getElementById('sum-grand');

    // Day detail
    const dayDetailInput = document.getElementById('day-detail-input');
    const dayDetailBtn = document.getElementById('day-detail-btn');
    const dayModal = document.getElementById('day-detail-modal');
    const dayModalTitle = document.getElementById('day-modal-title');
    const dayModalBody = document.getElementById('day-modal-body');
    const dayModalClose = document.getElementById('day-modal-close');

    const artistNameSpan = document.getElementById('artist-name-span');

    let currentArtist = null;

    // (A) Artist login
    artistLoginBtn.addEventListener('click', async () => {
      const emailVal = artistEmailInput.value.trim();
      if(!emailVal){
        loginMsg.textContent='Email required.';
        return;
      }
      loginMsg.textContent='';

      const { data: artists, error } = await supabase
        .from('artists')
        .select('*')
        .eq('email', emailVal);

      if(error){
        console.error(error);
        loginMsg.textContent='Error checking artist email.';
        return;
      }
      if(!artists || artists.length===0){
        loginMsg.textContent='No artist found with this email.';
        return;
      }
      // success
      currentArtist = artists[0];
      artistNameSpan.textContent = currentArtist.artist_name || 'Artist';

      loginSection.style.display='none';
      portalSection.style.display='block';
      loadUpcomingAppointments();
    });

    // (B) Tab switching
    tabScheduleBtn.addEventListener('click', () => setActiveTab('schedule'));
    tabEarningsBtn.addEventListener('click', () => setActiveTab('earnings'));

    function setActiveTab(tabName){
      tabScheduleBtn.classList.remove('active');
      tabEarningsBtn.classList.remove('active');
      scheduleTab.classList.remove('active');
      earningsTab.classList.remove('active');

      if(tabName==='schedule'){
        tabScheduleBtn.classList.add('active');
        scheduleTab.classList.add('active');
      } else {
        tabEarningsBtn.classList.add('active');
        earningsTab.classList.add('active');
      }
    }

    // (C) Load upcoming appointments => type='appointment', date >= today
    async function loadUpcomingAppointments(){
      upcomingList.innerHTML='';
      scheduleMsg.textContent='';
      const todayStr = new Date().toISOString().split('T')[0]; // e.g. '2025-05-09'

      const { data: appts, error } = await supabase
        .from('artist_appointments')
        .select('date,start_time,end_time,client_name,notes,appointment_type')
        .eq('artist_id', currentArtist.id)
        .eq('appointment_type', 'appointment') // only upcoming "appointments"
        .gte('date', todayStr)                // from now forward
        .order('date', { ascending: true })
        .order('start_time', { ascending: true });

      if(error){
        console.error(error);
        scheduleMsg.textContent='Error loading upcoming appointments.';
        return;
      }
      if(!appts || appts.length===0){
        scheduleMsg.textContent='No upcoming appointments.';
        return;
      }

      appts.forEach(ap => {
        const item=document.createElement('div');
        item.classList.add('appt-item');
        item.innerHTML=`
          <h4>${ap.date} ${ap.start_time || ''} - ${ap.end_time || ''}</h4>
          <p>Client: ${ap.client_name || 'N/A'}</p>
          <p>Notes: ${ap.notes || ''}</p>
        `;
        upcomingList.appendChild(item);
      });
    }

    // (D) Earnings => date-range summary for completed
    rangeGenBtn.addEventListener('click', async ()=>{
      rangeMsg.textContent='';
      sumTable.style.display='none';
      const startVal=rangeStart.value;
      const endVal=rangeEnd.value;
      if(!startVal || !endVal){
        rangeMsg.textContent='Start & End Date required.';
        return;
      }
      if(endVal<startVal){
        rangeMsg.textContent='End date cannot be before start date.';
        return;
      }

      // only sum up 'completed' appointments
      const { data: appts, error }=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('artist_id', currentArtist.id)
        .gte('date', startVal)
        .lte('date', endVal)
        .eq('appointment_type','completed'); // only completed
      if(error){
        console.error(error);
        rangeMsg.textContent='Error fetching appointments.';
        return;
      }
      if(!appts || appts.length===0){
        rangeMsg.textContent='No completed appointments found in this range.';
        return;
      }
      const splitVal = currentArtist.percentage_split||0;
      let totalSold=0, totalTips=0, yourCut=0;
      appts.forEach(ap=>{
        const basePrice=ap.price||0;
        const tip=ap.tip||0;
        totalSold += basePrice;
        totalTips += tip;
        yourCut+=(basePrice*(splitVal/100));
      });
      sumTable.style.display='';
      sumTotalSold.textContent=totalSold.toFixed(2);
      sumCut.textContent=yourCut.toFixed(2);
      sumTips.textContent=totalTips.toFixed(2);
      sumGrand.textContent=(yourCut+totalTips).toFixed(2);
    });

    // (E) View day detail => also only completed
    dayDetailBtn.addEventListener('click', async ()=>{
      const dayVal = dayDetailInput.value;
      if(!dayVal){
        alert('Pick a date.');
        return;
      }
      dayModal.classList.add('active');
      dayModalTitle.textContent=`Completed Appointments on ${dayVal}`;
      dayModalBody.innerHTML='Loading...';

      const { data: appts, error }=await supabase
        .from('artist_appointments')
        .select('*')
        .eq('artist_id', currentArtist.id)
        .eq('date', dayVal)
        .eq('appointment_type','completed'); // only completed
      if(error){
        console.error(error);
        dayModalBody.innerHTML='Error loading appointments.';
        return;
      }
      if(!appts || appts.length===0){
        dayModalBody.innerHTML='<div class="no-appts">No completed appointments this day.</div>';
        return;
      }
      const splitVal = currentArtist.percentage_split||0;
      const table=document.createElement('table');
      const thead=document.createElement('thead');
      thead.innerHTML=`
        <tr>
          <th>Time</th>
          <th>Price</th>
          <th>Tip</th>
          <th>Your Cut</th>
          <th>Total</th>
        </tr>
      `;
      table.appendChild(thead);
      const tbody=document.createElement('tbody');
      table.appendChild(tbody);

      appts.forEach(ap=>{
        const basePrice=ap.price||0;
        const tip=ap.tip||0;
        const cut=basePrice*(splitVal/100);
        const total=cut+tip;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${ap.start_time||''} - ${ap.end_time||''}</td>
          <td>${basePrice.toFixed(2)}</td>
          <td>${tip.toFixed(2)}</td>
          <td>${cut.toFixed(2)}</td>
          <td>${total.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });
      dayModalBody.innerHTML='';
      dayModalBody.appendChild(table);
    });

    dayModalClose.addEventListener('click',()=>{
      dayModal.classList.remove('active');
    });
  </script>
</body>
</html>