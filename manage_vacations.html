<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Vacations</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <!-- ─── CSP (unchanged) ─── -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
    connect-src 'self' https://shlvjhipxnslrncczopn.supabase.co wss://shlvjhipxnslrncczopn.supabase.co;
    style-src 'self' 'unsafe-inline';
    object-src 'none';
  ">

  <!-- ─── VISUAL THEME (matches dark UI used elsewhere) ─── -->
  <style>
    :root{
      --bg-0:#111;            /* body background            */
      --bg-1:#222;            /* card/section background     */
      --bg-2:#333;            /* button & hover backgrounds  */
      --border:#444;          /* borders / outlines          */
      --text:#fff;            /* main text                   */
      --text-dim:#ccc;        /* helper text                 */
      --accent:#28a745;       /* accent / success            */
      --danger:#ff6b6b;       /* error text                  */
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:'Helvetica Neue',Arial,sans-serif}

    body{
      background:var(--bg-0);color:var(--text);
      max-width:750px;margin:20px auto;padding:20px;
    }

    h1{text-align:center;margin-bottom:18px}
    h2,h3{margin:10px 0 14px}
    p{font-size:.9em;color:var(--text-dim)}

    /* Card-style sections */
    .login-section,.vacations-section{
      background:var(--bg-1);
      border:1px solid var(--border);
      border-radius:6px;
      padding:18px;margin-bottom:24px;
    }

    label{font-weight:700;display:block;margin:10px 0 4px}
    input,select{
      width:100%;padding:8px;
      background:var(--bg-0);color:var(--text);
      border:1px solid var(--border);border-radius:4px;
      margin-bottom:12px;
    }
    input:focus,select:focus{outline:2px solid var(--accent)}

    /* Buttons */
    button{
      background:var(--bg-2);color:var(--text);
      border:none;border-radius:4px;
      padding:8px 16px;cursor:pointer;
      transition:background .2s;
    }
    button:hover{background:#555}

    .message{color:var(--danger);margin-top:8px;font-size:.9em}
    .hidden{display:none}

    /* Table styling */
    .table-container{
      max-height:320px;overflow-y:auto;
      border:1px solid var(--border);border-radius:4px;
    }
    table{width:100%;border-collapse:collapse}
    th,td{
      border:1px solid var(--border);
      padding:8px;text-align:left;font-size:.9em;
    }
    th{background:var(--bg-2)}
  </style>
</head>
<body>
  <h1>Manage Vacations</h1>

  <!-- ───── GM Login ───── -->
  <div class="login-section" id="login-section">
    <label for="gm-email">GM Email</label>
    <input type="email" id="gm-email">

    <label for="gm-password">GM Password</label>
    <input type="password" id="gm-password">

    <button id="gm-login-btn">Login</button>
    <div class="message" id="login-message"></div>
  </div>

  <!-- ───── Vacations Section ───── -->
  <div class="vacations-section hidden" id="vacations-section">
    <h2>Manage Artist Vacations</h2>

    <label for="location-filter">Filter by Location</label>
    <select id="location-filter">
      <option value="">-- Select Location --</option>
    </select>

    <label for="artist-filter">Filter by Artist</label>
    <select id="artist-filter">
      <option value="">-- Select Artist --</option>
    </select>

    <hr style="border-color:var(--border);margin:18px 0">

    <h3>Add / Edit Vacation</h3>
    <label for="vacation-start">Vacation Start</label>
    <input type="date" id="vacation-start">

    <label for="vacation-end">Vacation End</label>
    <input type="date" id="vacation-end">

    <label for="vacation-notes">Notes</label>
    <input type="text" id="vacation-notes" placeholder="Reason, or any extra notes">

    <button id="save-vacation-btn">Save / Update Vacation</button>
    <button id="clear-form-btn">Clear Form</button>
    <div class="message" id="vacation-message"></div>

    <hr style="border-color:var(--border);margin:18px 0">

    <h3>Existing Vacations</h3>
    <div class="table-container">
      <table id="vacations-table">
        <thead>
          <tr>
            <th>Start</th><th>End</th><th>Notes</th><th>Action</th>
          </tr>
        </thead>
        <tbody><!-- JS populates --></tbody>
      </table>
    </div>
  </div>

  <!-- Supabase JS (logic unchanged) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <script>
    /* ────────── All previous JS logic kept exactly the same ────────── */
    const supabaseUrl = 'https://shlvjhipxnslrncczopn.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNobHZqaGlweG5zbHJuY2N6b3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2NDgzNjIsImV4cCI6MjA2MjIyNDM2Mn0.oPrYFyW0IsDnNsDpQ9LI0cOm6Y7OIJbjebp2Zjvv_qQ';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const loginSection = document.getElementById('login-section');
    const vacationsSection = document.getElementById('vacations-section');
    const gmEmailInput = document.getElementById('gm-email');
    const gmPasswordInput = document.getElementById('gm-password');
    const gmLoginBtn = document.getElementById('gm-login-btn');
    const loginMessage = document.getElementById('login-message');

    const locationFilter = document.getElementById('location-filter');
    const artistFilter   = document.getElementById('artist-filter');

    const vacationStartInput = document.getElementById('vacation-start');
    const vacationEndInput   = document.getElementById('vacation-end');
    const vacationNotesInput = document.getElementById('vacation-notes');
    const saveVacationBtn    = document.getElementById('save-vacation-btn');
    const clearFormBtn       = document.getElementById('clear-form-btn');
    const vacationMessage    = document.getElementById('vacation-message');

    const vacationsTableBody = document.querySelector('#vacations-table tbody');

    let currentGM=null,currentVacationId=null;

    gmLoginBtn.addEventListener('click',async()=>{
      loginMessage.textContent='';
      const e=gmEmailInput.value.trim(),p=gmPasswordInput.value.trim();
      if(!e||!p){loginMessage.textContent='Email and Password required.';return;}
      const {data,error}=await supabase.from('users').select('*').eq('email',e).eq('role','gm');
      if(error||!data?.length){loginMessage.textContent='Invalid GM credentials or not a GM.';return;}
      if(data[0].password_hash!==p){loginMessage.textContent='Invalid credentials.';return;}
      currentGM=data[0];
      loginSection.classList.add('hidden');vacationsSection.classList.remove('hidden');loadLocations();
    });

    async function loadLocations(){
      locationFilter.innerHTML='<option value="">-- Select Location --</option>';
      const {data}=await supabase.from('locations').select('*');
      data?.forEach(l=>{const o=document.createElement('option');o.value=l.id;o.textContent=l.location_name;locationFilter.appendChild(o);});
    }

    locationFilter.addEventListener('change',async()=>{
      artistFilter.innerHTML='<option value="">-- Select Artist --</option>';vacationsTableBody.innerHTML='';currentVacationId=null;
      if(!locationFilter.value)return;
      const {data}=await supabase.from('artists').select('id,artist_name').eq('location_id',locationFilter.value);
      data?.forEach(a=>{const o=document.createElement('option');o.value=a.id;o.textContent=a.artist_name;artistFilter.appendChild(o);});
    });

    artistFilter.addEventListener('change',loadVacations);

    async function loadVacations(){
      vacationsTableBody.innerHTML='';currentVacationId=null;if(!artistFilter.value)return;
      const {data}=await supabase.from('artist_vacations').select('*').eq('artist_id',artistFilter.value).order('vacation_start',{ascending:true});
      data?.forEach(v=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${v.vacation_start}</td>
          <td>${v.vacation_end||v.vacation_start}</td>
          <td>${v.notes||''}</td>
          <td>
            <button data-id="${v.id}" class="edit-btn">Edit</button>
            <button data-id="${v.id}" class="del-btn">Delete</button>
          </td>`;
        vacationsTableBody.appendChild(tr);
      });
      vacationsTableBody.querySelectorAll('.edit-btn').forEach(b=>b.onclick=()=>editVacation(data.find(v=>v.id==b.dataset.id)));
      vacationsTableBody.querySelectorAll('.del-btn').forEach(b=>b.onclick=()=>deleteVacation(b.dataset.id));
    }

    function editVacation(v){
      currentVacationId=v.id;
      vacationStartInput.value=v.vacation_start||'';
      vacationEndInput.value=v.vacation_end||v.vacation_start||'';
      vacationNotesInput.value=v.notes||'';
      vacationMessage.textContent='Editing existing vacation range. Save to update.';
    }

    async function deleteVacation(id){
      if(!confirm('Delete this vacation?'))return;
      const {error}=await supabase.from('artist_vacations').delete().eq('id',id);
      vacationMessage.textContent=error?'Error deleting vacation.':'Vacation deleted.';loadVacations();clearForm();
    }

    saveVacationBtn.addEventListener('click',async()=>{
      vacationMessage.textContent='';
      if(!artistFilter.value){vacationMessage.textContent='Select an artist.';return;}
      const start=vacationStartInput.value;if(!start){vacationMessage.textContent='Vacation start date required.';return;}
      const end=vacationEndInput.value||start;const notes=vacationNotesInput.value.trim()||null;
      if(!currentVacationId){
        const {error}=await supabase.from('artist_vacations').insert([{artist_id:artistFilter.value,vacation_start:start,vacation_end:end,notes}]);
        vacationMessage.textContent=error?'Error inserting vacation.':'New vacation added!';
      }else{
        const {error}=await supabase.from('artist_vacations').update({vacation_start:start,vacation_end:end,notes}).eq('id',currentVacationId);
        vacationMessage.textContent=error?'Error updating vacation.':'Vacation updated!';
      }
      loadVacations();clearForm();
    });

    clearFormBtn.addEventListener('click',clearForm);
    function clearForm(){currentVacationId=null;vacationStartInput.value='';vacationEndInput.value='';vacationNotesInput.value='';vacationMessage.textContent='';}

    window.addEventListener('DOMContentLoaded',()=>vacationsSection.classList.add('hidden'));
  </script>
</body>
</html>
